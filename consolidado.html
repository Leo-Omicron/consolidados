<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Académico Consolidado</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React + ReactDOM + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Chart.js para gráficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="text/babel">
    // ...existing imports and code...

    // =============================
    // Componente de Gráficos (Chart.js)
    // =============================
    function DashboardCharts({ data }) {
      const barRef = useRef(null);
      const pieRef = useRef(null);
      const radarRef = useRef(null);
      const charts = useRef({});

      useEffect(() => {
        if (!Array.isArray(data)) return;

        const estados = ['Perdido','En riesgo','Recuperable','Ganable','Ganado'];
        const estadoCounts = estados.map(e =>
          data.filter(est => Object.values(est.areas).some(a => a.areaStats?.estado?.text === e)).length
        );

        const mk = (key, ref, cfg) => {
          if (!ref) return;
          charts.current[key]?.destroy();
          charts.current[key] = new window.Chart(ref, cfg);
        };

        mk('bar', barRef.current, {
          type: 'bar',
          data: {
            labels: estados,
            datasets: [{ label: 'Distribución de Estados', data: estadoCounts, backgroundColor: ['#ef4444','#fbbf24','#3b82f6','#06b6d4','#22c55e'] }]
          },
          options: { responsive: true, plugins: { legend: { display: false } } }
        });

        mk('pie', pieRef.current, {
          type: 'pie',
          data: {
            labels: estados,
            datasets: [{ label: 'Estados', data: estadoCounts, backgroundColor: ['#ef4444','#fbbf24','#3b82f6','#06b6d4','#22c55e'] }]
          },
          options: { responsive: true }
        });

        const areaLabels = Array.from(new Set(data.flatMap(s => Object.keys(s.areas))));
        const areaProms = areaLabels.map(a => {
          const arr = data.flatMap(s => s.areas[a]?.areaStats?.promedioActual ?? []);
          const nums = arr.filter(v => typeof v === 'number');
          return nums.length ? Number((nums.reduce((s,v)=>s+v,0)/nums.length).toFixed(2)) : 0;
        });

        mk('radar', radarRef.current, {
          type: 'radar',
          data: {
            labels: areaLabels,
            datasets: [{ label: 'Promedio por Área', data: areaProms, backgroundColor: 'rgba(59,130,246,0.2)', borderColor: '#3b82f6' }]
          },
          options: { responsive: true }
        });

        return () => {
          Object.values(charts.current).forEach(c => c?.destroy());
          charts.current = {};
        };
      }, [data]);

      const estados = ['Perdido','En riesgo','Recuperable','Ganable','Ganado'];
      const estadoCounts = estados.map(e =>
        data.filter(est => Object.values(est.areas).some(a => a.areaStats?.estado?.text === e)).length
      );

      const areaLabels = Array.from(new Set(data.flatMap(s => Object.keys(s.areas))));
      const areaProms = areaLabels.map(a => {
        const arr = data.flatMap(s => s.areas[a]?.areaStats?.promedioActual ?? []);
        const nums = arr.filter(v => typeof v === 'number');
        return nums.length ? (nums.reduce((s,v)=>s+v,0)/nums.length).toFixed(2) : 0;
      });

      return (
        <div className="grid grid-cols-1 md:grid-cols-3 gap-8 p-4">
          <div>
            <h3 className="font-semibold mb-2 text-center">Distribución de Estados</h3>
            <p className="text-xs text-gray-500 text-center mb-2">Cantidad de estudiantes por estado académico (área principal).</p>
            <canvas ref={barRef} height="180" aria-label="Distribución de estados (barras)" role="img"></canvas>
            <table className="mt-2 text-xs w-full border">
              <caption className="sr-only">Distribución de estudiantes por estado académico</caption>
              <thead>
                <tr className="bg-gray-100">
                  <th scope="col" className="border px-1">Estado</th>
                  <th scope="col" className="border px-1">Cantidad</th>
                </tr>
              </thead>
              <tbody>
                {estados.map((e, i) => (
                  <tr key={e}>
                    <td className="border px-1">{e}</td>
                    <td className="border px-1">{estadoCounts[i]}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          <div>
            <h3 className="font-semibold mb-2 text-center">Estados (Pastel)</h3>
            <p className="text-xs text-gray-500 text-center mb-2">Proporción de estudiantes por estado académico.</p>
            <canvas ref={pieRef} height="180" aria-label="Distribución de estados (pastel)" role="img"></canvas>
            <table className="mt-2 text-xs w-full border">
              <caption className="sr-only">Proporción de estudiantes por estado académico</caption>
              <thead>
                <tr className="bg-gray-100">
                  <th scope="col" className="border px-1">Estado</th>
                  <th scope="col" className="border px-1">Cantidad</th>
                </tr>
              </thead>
              <tbody>
                {estados.map((e, i) => (
                  <tr key={e}>
                    <td className="border px-1">{e}</td>
                    <td className="border px-1">{estadoCounts[i]}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          <div>
            <h3 className="font-semibold mb-2 text-center">Promedio por Área (Radar)</h3>
            <p className="text-xs text-gray-500 text-center mb-2">Promedio general de notas por área académica.</p>
            <canvas ref={radarRef} height="180" aria-label="Promedio por área (radar)" role="img"></canvas>
            <table className="mt-2 text-xs w-full border">
              <caption className="sr-only">Promedio general de notas por área académica</caption>
              <thead>
                <tr className="bg-gray-100">
                  <th scope="col" className="border px-1">Área</th>
                  <th scope="col" className="border px-1">Promedio</th>
                </tr>
              </thead>
              <tbody>
                {areaLabels.map((a, i) => (
                  <tr key={a}>
                    <td className="border px-1">{a}</td>
                    <td className="border px-1">{areaProms[i]}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    // =============================
    // Tabs para navegación (Análisis / Gráficos) con A11y
    // =============================
    function DashboardTabs({ dashboardData, onReset, fileName }) {
      const [tab, setTab] = useState('analisis');

      return (
        <div className="w-full">
          <div role="tablist" aria-label="Navegación del dashboard" className="flex gap-2 mb-4">
            <button
              role="tab"
              id="tab-analisis"
              aria-controls="panel-analisis"
              aria-selected={tab === 'analisis'}
              className={tab === 'analisis'
                ? 'px-4 py-2 rounded-t-lg font-semibold bg-white shadow'
                : 'px-4 py-2 rounded-t-lg font-semibold bg-gray-200'}
              onClick={() => setTab('analisis')}
            >
              Análisis
            </button>

            <button
              role="tab"
              id="tab-graficos"
              aria-controls="panel-graficos"
              aria-selected={tab === 'graficos'}
              className={tab === 'graficos'
                ? 'px-4 py-2 rounded-t-lg font-semibold bg-white shadow'
                : 'px-4 py-2 rounded-t-lg font-semibold bg-gray-200'}
              onClick={() => setTab('graficos')}
            >
              Gráficos
            </button>

            <button
              role="tab"
              id="tab-consultas"
              aria-controls="panel-consultas"
              aria-selected={tab === 'consultas'}
              className={tab === 'consultas'
                ? 'px-4 py-2 rounded-t-lg font-semibold bg-white shadow'
                : 'px-4 py-2 rounded-t-lg font-semibold bg-gray-200'}
              onClick={() => setTab('consultas')}
            >
              Consultas/Reportes Rápidos
            </button>
          </div>

          <div className="bg-white rounded-lg shadow p-4">
            {tab === 'analisis' && (
              <div role="tabpanel" id="panel-analisis" aria-labelledby="tab-analisis">
                <DashboardView data={dashboardData} onReset={onReset} fileName={fileName} />
              </div>
            )}
            {tab === 'graficos' && (
              <div role="tabpanel" id="panel-graficos" aria-labelledby="tab-graficos">
                <DashboardCharts data={dashboardData} />
              </div>
            )}
            {tab === 'consultas' && (
              <div role="tabpanel" id="panel-consultas" aria-labelledby="tab-consultas">
                <QuickReportsView data={dashboardData} />
              </div>
            )}
          </div>
        </div>
      );
    }
    // =============================
    // Componente Consultas/Reportes Rápidos
    // =============================
    function QuickReportsView({ data }) {
      const [courseFilter, setCourseFilter] = useState('ALL');

      const courseOptions = useMemo(() => {
        const set = new Set(
          Array.isArray(data) ? data.map(s => s?.__course).filter(Boolean) : []
        );
        return ['ALL', ...Array.from(set)];
      }, [data]);

      const filteredData = useMemo(() => {
        if (!Array.isArray(data)) return [];
        if (courseFilter === 'ALL') return data;
        return data.filter(s => s.__course === courseFilter);
      }, [data, courseFilter]);

      // Promedios más bajos por área
      const areaLabels = Array.from(new Set(filteredData.flatMap(s => Object.keys(s.areas))));
      // Promedios más bajos por área: solo estudiantes con promedio < 3.0
      const lowAverages = areaLabels.map(area => {
        const students = filteredData.map(s => ({
          name: s.name,
          prom: s.areas[area]?.areaStats?.promedioActual ?? null
        })).filter(s => typeof s.prom === 'number' && s.prom < 3.0);
        students.sort((a,b) => a.prom-b.prom);
        return { area, students };
      }).filter(a => a.students.length > 0);

      // Estudiantes con más áreas perdidas (todos los que tengan al menos 1)
      const lostAreas = filteredData.map(s => ({
        name: s.name,
        perdidas: Object.values(s.areas).filter(a => a.areaStats?.estado?.text==='Perdido').length
      }));
      lostAreas.sort((a,b)=>b.perdidas-a.perdidas);
      const topLost = lostAreas.filter(s=>s.perdidas>0);

      // Estudiantes con más áreas en riesgo (todos los que tengan al menos 1)
      const riskAreas = filteredData.map(s => ({
        name: s.name,
        riesgo: Object.values(s.areas).filter(a => a.areaStats?.estado?.text==='En riesgo').length
      }));
      riskAreas.sort((a,b)=>b.riesgo-a.riesgo);
      const topRisk = riskAreas.filter(s=>s.riesgo>0);

      // Estudiantes con más áreas recuperables (todos los que tengan al menos 1)
      const recupAreas = filteredData.map(s => ({
        name: s.name,
        recup: Object.values(s.areas).filter(a => a.areaStats?.estado?.text==='Recuperable').length
      }));
      recupAreas.sort((a,b)=>b.recup-a.recup);
      const topRecup = recupAreas.filter(s=>s.recup>0);

      // Áreas con más estudiantes en riesgo (todas las áreas con al menos 1 estudiante en riesgo)
      const areaRisk = areaLabels.map(area => {
        const riesgo = filteredData.filter(s => s.areas[area]?.areaStats?.estado?.text==='En riesgo').length;
        return { area, riesgo };
      }).filter(a=>a.riesgo>0).sort((a,b)=>b.riesgo-a.riesgo);

      // Top estudiantes con mejor desempeño global (top 10)
      const globalProms = filteredData.map(s => {
        const proms = Object.values(s.areas).map(a => a.areaStats?.promedioActual).filter(v=>typeof v==='number');
        const prom = proms.length ? proms.reduce((a,b)=>a+b,0)/proms.length : null;
        return { name: s.name, prom };
      }).filter(s=>typeof s.prom==='number');
      globalProms.sort((a,b)=>b.prom-a.prom);
      const topGlobal = globalProms.slice(0, 10);

      // Top estudiantes con peor desempeño global: solo los que tengan promedio < 3.0
      const worstGlobal = globalProms.filter(s=>s.prom < 3.0).sort((a,b)=>a.prom-b.prom);

      // ...existing code...
      return (
        <div className="space-y-8">
          <h2 className="text-xl font-bold mb-4 text-blue-700">Consultas y Reportes Rápidos</h2>
          <div className="flex items-center gap-2 mb-4">
            <label className="text-sm font-medium">Curso:</label>
            <select
              className="border rounded px-2 py-1 text-sm"
              value={courseFilter}
              onChange={(e) => setCourseFilter(e.target.value)}
            >
              {courseOptions.map(opt => (
                <option key={opt} value={opt}>{opt === 'ALL' ? 'Todos' : opt}</option>
              ))}
            </select>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div className="bg-white border rounded-xl p-4 shadow">
              <h3 className="font-semibold mb-2 text-blue-600">Promedios más bajos por Área</h3>
              <div className="max-h-64 overflow-auto pr-2">
                {lowAverages.map(a=>(
                  <div key={a.area} className="mb-3">
                    <div className="font-bold text-sm mb-1">{a.area}</div>
                    <ul className="text-xs">
                      {a.students.map(s=>(<li key={s.name}>{s.name}: <span className="font-semibold text-red-600">{s.prom.toFixed(2)}</span></li>))}
                    </ul>
                  </div>
                ))}
              </div>
            </div>
            <div className="bg-white border rounded-xl p-4 shadow">
              <h3 className="font-semibold mb-2 text-red-600">Estudiantes con más Áreas Perdidas</h3>
              <div className="max-h-64 overflow-auto pr-2">
                <ul className="text-xs">
                  {topLost.map(s=>(<li key={s.name}>{s.name}: <span className="font-semibold text-red-600">{s.perdidas}</span> áreas</li>))}
                </ul>
              </div>
            </div>
            <div className="bg-white border rounded-xl p-4 shadow">
              <h3 className="font-semibold mb-2 text-yellow-600">Estudiantes con más Áreas en Riesgo</h3>
              <div className="max-h-64 overflow-auto pr-2">
                <ul className="text-xs">
                  {topRisk.map(s=>(<li key={s.name}>{s.name}: <span className="font-semibold text-yellow-600">{s.riesgo}</span> áreas</li>))}
                </ul>
              </div>
            </div>
            <div className="bg-white border rounded-xl p-4 shadow">
              <h3 className="font-semibold mb-2 text-blue-600">Estudiantes con más Áreas Recuperables</h3>
              <div className="max-h-64 overflow-auto pr-2">
                <ul className="text-xs">
                  {topRecup.map(s=>(<li key={s.name}>{s.name}: <span className="font-semibold text-blue-600">{s.recup}</span> áreas</li>))}
                </ul>
              </div>
            </div>
            <div className="bg-white border rounded-xl p-4 shadow">
              <h3 className="font-semibold mb-2 text-yellow-700">Áreas con más estudiantes en riesgo</h3>
              <div className="max-h-64 overflow-auto pr-2">
                <ul className="text-xs">
                  {areaRisk.map(a=>(<li key={a.area}>{a.area}: <span className="font-semibold text-yellow-700">{a.riesgo}</span> estudiantes</li>))}
                </ul>
              </div>
            </div>
            <div className="bg-white border rounded-xl p-4 shadow">
              <h3 className="font-semibold mb-2 text-green-700">Top estudiantes con mejor desempeño global</h3>
              <div className="max-h-64 overflow-auto pr-2">
                <ul className="text-xs">
                  {topGlobal.map(s=>(<li key={s.name}>{s.name}: <span className="font-semibold text-green-700">{s.prom.toFixed(2)}</span></li>))}
                </ul>
              </div>
            </div>
            <div className="bg-white border rounded-xl p-4 shadow">
              <h3 className="font-semibold mb-2 text-red-700">Top estudiantes con peor desempeño global</h3>
              <div className="max-h-64 overflow-auto pr-2">
                <ul className="text-xs">
                  {worstGlobal.map(s=>(<li key={s.name}>{s.name}: <span className="font-semibold text-red-700">{s.prom.toFixed(2)}</span></li>))}
                </ul>
              </div>
            </div>
          </div>
        </div>
      );
    }
    // ...resto del código React...
  </script>
  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, "Noto Sans", 'Apple Color Emoji', 'Segoe UI Emoji'; }
    .highlight-unitary { background-color: #f0f9ff; border-left: 3px solid #3b82f6; }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <header class="w-full bg-gradient-to-r from-blue-900 via-yellow-400 to-green-700 shadow-lg py-3 px-4 flex items-center justify-between">
    <div class="flex items-center gap-4">
  <img src="escudo-el-carmen.jpg" alt="Escudo IE El Carmen" class="rounded-full border-2 border-white shadow-md bg-white object-cover w-12 h-12" />
      <div>
        <h1 class="text-2xl md:text-3xl font-bold text-white drop-shadow">IE EL CARMEN</h1>
        <span class="text-xs md:text-sm text-white/80 font-semibold">Dashboard Institucional</span>
      </div>
    </div>
  </header>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef, useEffect, Fragment, useMemo } = React;

    // ==============================
    // Iconos (Lucide-like minimal)
    // ==============================
    const Icon = ({path, className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        {path}
      </svg>
    );
    const UploadCloudIcon = (p) => <Icon {...p} path={<Fragment><path d="M4 14.9A7 7 0 1 1 15.7 8h1.8A4.5 4.5 0 0 1 20 16.2"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></Fragment>} />
    const CheckCircleIcon = (p) => <Icon {...p} path={<Fragment><path d="M22 11.08V12A10 10 0 1 1 16.07 2.86"/><polyline points="22 4 12 14.01 9 11.01"/></Fragment>} />
    const AlertTriangleIcon = (p) => <Icon {...p} path={<Fragment><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></Fragment>} />
    const InfoIcon = (p) => <Icon {...p} path={<Fragment><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></Fragment>} />
    const DatabaseIcon = (p) => <Icon {...p} path={<Fragment><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5v14a9 3 0 0 0 18 0V5"/><path d="M3 12a9 3 0 0 0 18 0"/></Fragment>} />
    const BarChartIcon = (p) => <Icon {...p} path={<Fragment><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></Fragment>} />

    // ==============================================
    // Utilidades: normalización y helpers del parser
    // ==============================================
    const textNormalize = (v) => (typeof v === 'string' ? v.trim() : v);
    const toUpperSafe = (v) => (v == null ? '' : String(v).trim().toUpperCase());

    const removeDiacritics = (str) => (str || '').normalize('NFD').replace(/[̀-ͯ]/g, '');

    const normalizeName = (s) => {
      let v = toUpperSafe(s);
      v = removeDiacritics(v);
      return v.replace(/\s+/g, ' ').trim();
    }

    const normalizeAsignatura = (s) => {
      const v = normalizeName(s);
      // Corrected regex: escaped dot and word boundary
      if (/^(DEF(\.|INIT)?|DEFINITIVA|DEF AREA|AREA DEF)\b/.test(v)) return 'DEF';
      return v;
    };

    const normalizeArea = (s) => normalizeName(s);
    const normalizeComponente = (s) => {
      let v = toUpperSafe(s);
      v = removeDiacritics(v);
      v = v.replace(/\s+/g, '');
      if (/^(P1|1P|PRIMERO|PER1|PERIODO1)$/i.test(v)) return 'P1';
      if (/^(P2|2P|SEGUNDO|PER2|PERIODO2)$/i.test(v)) return 'P2';
      if (/^(P3|3P|TERCERO|PER3|PERIODO3)$/i.test(v)) return 'P3';
      if (/^(A|ACUMULADO|ACUM)$/.test(v)) return 'A';
      const defPx = v.match(/^DEF(P[123])$/);
      if (defPx) return defPx[1];
      return v || '';
    };

    // ========================================
    // (3) PARSER de encabezados (robustecido)
    // ========================================
    const profilingLogic = {
      parseHeaders: (headerRows, log) => {
        // Aseguramos que cada fila de encabezado tenga el mismo largo
        const maxLen = Math.max(...headerRows.map(r => r.length));
        const [rawAreas, rawAsignaturas, rawComponentes] = headerRows.map(row => {
          const fullRow = [...row];
          while (fullRow.length < maxLen) fullRow.push(undefined);
          return fullRow;
        });
        log.push({ level: 'info', message: `Filas de encabezado detectadas: ${headerRows.length}` });

        // 1. Forward fill en Áreas
        for (let i = 1; i < rawAreas.length; i++) {
          if (!textNormalize(rawAreas[i])) rawAreas[i] = rawAreas[i - 1];
        }
        log.push({ level: 'info', message: `Áreas después de forward-fill: ${JSON.stringify(rawAreas)}` });

        // 2. Forward fill contextual en Asignaturas
        for (let i = 1; i < rawAsignaturas.length; i++) {
          if (!textNormalize(rawAsignaturas[i]) && textNormalize(rawAreas[i]) === textNormalize(rawAreas[i - 1])) {
            rawAsignaturas[i] = rawAsignaturas[i - 1];
          }
        }
        log.push({ level: 'info', message: `Asignaturas después de forward-fill contextual: ${JSON.stringify(rawAsignaturas)}` });

        // 3. Relleno de Asignatura con Área para áreas 1:1
        for (let i = 0; i < rawAsignaturas.length; i++) {
          if (!textNormalize(rawAsignaturas[i])) {
            rawAsignaturas[i] = rawAreas[i];
          }
        }
        log.push({ level: 'info', message: `Asignaturas después de relleno 1:1: ${JSON.stringify(rawAsignaturas)}` });

        // 4. Estructurar y normalizar, OMITIENDO las primeras dos columnas (No, Estudiante)
        let structuredHeaders = rawComponentes.map((comp, i) => ({
          index: i,
          area: normalizeArea(rawAreas[i]),
          asignatura: normalizeAsignatura(rawAsignaturas[i]),
          componente: normalizeComponente(comp),
          raw: { area: rawAreas[i], asignatura: rawAsignaturas[i], componente: comp }
        }));
        log.push({ level: 'info', message: `structuredHeaders before slice(2): ${JSON.stringify(structuredHeaders)}` });

        // Omitimos las dos primeras columnas (No, Estudiante)
        structuredHeaders = structuredHeaders.slice(2);
        log.push({ level: 'info', message: `structuredHeaders after slice(2): ${JSON.stringify(structuredHeaders)}` });

        // Filtramos solo las cabeceras válidas
        structuredHeaders = structuredHeaders.filter(h => h.area && h.asignatura);
        log.push({ level: 'info', message: `structuredHeaders after filter: ${JSON.stringify(structuredHeaders)}` });

        log.push({ level: 'info', message: `Cabeceras estructuradas y normalizadas generadas.` });
        return structuredHeaders;
      },
      getCountsFromSource: (headers) => {
        console.log("getCountsFromSource: headers received:", headers); // Added log
        const areas = new Set();
        const asignaturas = new Set();
        headers.forEach(h => {
          if (h.area && h.area !== 'META') {
            areas.add(h.area);
          }
          // FIX: Contar nombres de asignaturas únicas, excluyendo 'DEF' y columnas 'META'.
          if (h.asignatura && h.asignatura !== 'DEF' && h.area !== 'META') {
            asignaturas.add(h.asignatura);
          }
        });
        console.log("getCountsFromSource: unique areas:", Array.from(areas)); // Added log
        console.log("getCountsFromSource: unique asignaturas:", Array.from(asignaturas)); // Added log
        return { areaCount: areas.size, asignaturaCount: asignaturas.size };
      }
    };

    // ================================================
    // (4) Limpieza, estructura, y síntesis de DEF 1:1
    // ================================================
    const cleaningLogic = {
      normalizeText: (t) => (typeof t === 'string' ? t.trim().replace(/\s+/g, ' ') : t),
      convertToNumber: (value) => {
        if (value === null || value === undefined) return null;
        let s = String(value).trim();
        if (!s || s === '—' || s.toUpperCase() === 'NA') return null;
        const num = parseFloat(s.replace(',', '.'));
        return Number.isFinite(num) ? num : null;
      },
      structureData: (profile, log) => {
        const { tableHeaders, tableData } = profile;
        const structured = [];
        const studentNames = new Set();

        tableData.forEach((row, rowIndex) => {
          const studentName = cleaningLogic.normalizeText(row[1]);
          if (!studentName) {
            log.push({ type: 'error', message: `Fila ${rowIndex + 4}: Estudiante sin nombre. Fila omitida.` });
            return;
          }
          if (studentNames.has(studentName)) {
            log.push({ type: 'warning', message: `Estudiante duplicado: "${studentName}". Se procesará, pero revise duplicidad.` });
          }
          studentNames.add(studentName);

          const student = { id: cleaningLogic.normalizeText(row[0]), name: studentName, areas: {} };

          tableHeaders.forEach(h => {
            const { area, asignatura, componente, index } = h;
            if (!area || area === 'META' || !asignatura || !componente) return;
            if (!student.areas[area]) student.areas[area] = { asignaturas: {}, DEF: {} };

            let note = cleaningLogic.convertToNumber(row[index]);
            // Si hay texto no numérico visible
            if (row[index] !== null && String(row[index]).trim() !== '' && note === null) {
              log.push({ type: 'warning', message: `'${studentName}': Valor no numérico '${row[index]}' en ${area}>${asignatura}>${componente} → nulo.` });
            }
            // Validación de rango (BUG FIX: forzar note=null cuando esté fuera de 0..5)
            if (note !== null && (note < 0 || note > 5)) {
              log.push({ type: 'error', message: `'${studentName}': Nota fuera de rango '${row[index]}' en ${area}>${asignatura}>${componente} → nulo.` });
              note = null; // <-- corrección clave
            }

            // Registrar
            if (asignatura === 'DEF') {
              if (['P1','P2','P3'].includes(componente)) student.areas[area].DEF[componente] = note;
            } else {
              if (!student.areas[area].asignaturas[asignatura]) student.areas[area].asignaturas[asignatura] = {};
              if (['P1','P2','P3'].includes(componente)) student.areas[area].asignaturas[asignatura][componente] = note;
            }
          });

          // Síntesis de DEF para áreas unitarias
          Object.entries(student.areas).forEach(([areaName, areaData]) => {
            const hasExplicitDEF = Object.values(areaData.DEF).some(v => v !== null);
            if (!hasExplicitDEF) {
              const mainAsignatura = areaData.asignaturas[areaName];
              if (mainAsignatura) {
                areaData.DEF = { ...mainAsignatura };
                log.push({ type: 'info', message: `Área unitaria "${areaName}": DEF sintetizado desde asignatura.` });
              }
            }
          });

          structured.push(student);
        });

        return { structuredData: structured, log };
      }
    };

    // ======================================
    // (5) Cálculos y proyección P4 mínima
    // ======================================
    const calculationLogic = {
      getStatus: (p4Min) => {
        if (p4Min === null) return { text: 'N/A', color: 'gray' };
        if (p4Min >= 5.0) return { text: 'Perdido', color: 'red' };
        if (p4Min >= 4.0) return { text: 'En riesgo', color: 'yellow' };
        if (p4Min >= 3.0) return { text: 'Recuperable', color: 'blue' };
        if (p4Min >= 1.0) return { text: 'Ganable', color: 'cyan' };
        return { text: 'Ganado', color: 'green' };
      },
      calcPromYMin: (p1, p2, p3) => {
        const vals = [p1, p2, p3].filter(v => v !== null && v !== undefined);
        if (vals.length === 0) return { promedioActual: null, p4Min: null, estado: { text: 'N/A', color: 'gray' } };
        const sum = vals.reduce((a,b)=>a+b, 0);
        const promedioActual = sum / vals.length; // promedio de los presentes (mejor lectura)
        let p4Min = 12 - (p1 ?? 0) - (p2 ?? 0) - (p3 ?? 0); // mantengo criterio institucional (sumatoria ≥ 12)
        if (p4Min < 0) p4Min = 0;
        if (!Number.isFinite(p4Min)) p4Min = null;
        return { promedioActual, p4Min, estado: calculationLogic.getStatus(p4Min) };
      },
      performAllCalculations: (structuredData) => structuredData.map(student => {
        const out = { ...student, areas: {} };
        Object.entries(student.areas).forEach(([areaName, areaData]) => {
          // Asignaturas
          const nuevas = {};
          Object.entries(areaData.asignaturas).forEach(([asigName, asigData]) => {
            const { promedioActual, p4Min, estado } = calculationLogic.calcPromYMin(asigData.P1, asigData.P2, asigData.P3);
            nuevas[asigName] = { ...asigData, promedioActual, p4Min, estado };
          });
          // Área (DEF)
          const def = areaData.DEF || {};
          const areaStats = calculationLogic.calcPromYMin(def.P1, def.P2, def.P3);
          out.areas[areaName] = { ...areaData, asignaturas: nuevas, areaStats };
        });
        return out;
      })
    };

    // ======================================
    // (6) Componentes de Interfaz
    // ======================================
    const StatusBadge = ({ status }) => {
      const color = {
        red: 'bg-red-200 text-red-900 border border-red-400',
        yellow: 'bg-yellow-100 text-yellow-900 border border-yellow-400',
        blue: 'bg-blue-100 text-blue-900 border border-blue-400',
        cyan: 'bg-cyan-100 text-cyan-900 border border-cyan-400',
        green: 'bg-green-100 text-green-900 border border-green-400',
        gray: 'bg-gray-100 text-gray-800 border border-gray-300'
      }[status.color] || 'bg-gray-100 text-gray-800 border border-gray-300';
      const icon = {
        red: <AlertTriangleIcon className="inline w-4 h-4 mr-1" />,
        yellow: <InfoIcon className="inline w-4 h-4 mr-1" />,
        blue: <BarChartIcon className="inline w-4 h-4 mr-1" />,
        cyan: <CheckCircleIcon className="inline w-4 h-4 mr-1" />,
        green: <CheckCircleIcon className="inline w-4 h-4 mr-1" />,
        gray: <InfoIcon className="inline w-4 h-4 mr-1" />
      }[status.color] || null;
      return <span className={`px-2 inline-flex items-center text-xs leading-5 font-semibold rounded-full ${color}`}>{icon}{status.text}</span>;
    };

    const UploadView = ({ onFileProcessed }) => {
      const [files, setFiles] = useState([]);
      const [isDragging, setIsDragging] = useState(false);
      const inputRef = useRef(null);

      const processFile = (file) => new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
            if (wb.SheetNames.length === 0) return resolve({ status: 'error', message: 'El archivo no contiene hojas.' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const data = XLSX.utils.sheet_to_json(ws, { header: 1, blankrows: false });
            if (data.length < 4) return resolve({ status: 'error', message: 'Se requieren al menos 3 filas de encabezado + datos.' });

            const headerRows = data.slice(0, 3).map(row => {
                const fullRow = [...row];
                while (fullRow.length < data[0].length) { // Use data[0].length for max_col
                    fullRow.push(undefined);
                }
                return fullRow;
            });
            const dataRows = data.slice(3);

            resolve({ status: 'success', profile: { fileName: file.name, headerRows, tableData: dataRows } });
          } catch (err) {
            resolve({ status: 'error', message: 'No se pudo leer el archivo. ¿Está corrupto?' });
          }
        };
        reader.onerror = () => resolve({ status: 'error', message: 'Error al leer el archivo.' });
        reader.readAsArrayBuffer(file);
      });

      const handleSelected = async (flist) => {
        if (!flist || flist.length === 0) return;
        const f = flist[0];
        const token = `${f.name}-${f.lastModified}`;
        setFiles([{ id: token, name: f.name, status: 'processing', message: 'Analizando estructura…' }]);
        const res = await processFile(f);
        if (res.status === 'success') onFileProcessed(res.profile);
        else setFiles([{ id: token, name: f.name, status: 'error', message: res.message }]);
        if (inputRef.current) inputRef.current.value = '';
      };

      const handleDrop = (e) => { e.preventDefault(); e.stopPropagation(); setIsDragging(false); handleSelected(e.dataTransfer.files); };
      const handleDrag = (e) => { e.preventDefault(); e.stopPropagation(); setIsDragging(e.type === 'dragenter' || e.type === 'dragover'); };

      return (
        <div className="min-h-screen flex flex-col items-center justify-center p-6">
          <div className="w-full max-w-3xl">
            <h1 className="text-3xl font-bold text-center">Dashboard Académico</h1>
            <p className="text-center text-gray-600 mb-6">Sube un archivo de Excel para analizar las notas.</p>

            <div onDrop={handleDrop} onDragEnter={handleDrag} onDragOver={handleDrag} onDragLeave={handleDrag}
                 className={`relative flex flex-col items-center justify-center w-full p-10 border-2 border-dashed rounded-xl cursor-pointer transition ${isDragging ? 'border-blue-500 bg-blue-50' : 'border-gray-300 bg-white hover:border-gray-400'}`} onClick={() => inputRef.current.click()}>
              <UploadCloudIcon className={`w-12 h-12 mb-3 ${isDragging ? 'text-blue-600' : 'text-gray-400'}`} />
              <p className="font-semibold">Arrastra y suelta un archivo aquí</p>
              <p className="text-sm text-gray-500">o</p>
              <button type="button" className="mt-2 inline-flex items-center px-4 py-2 rounded-md text-white bg-blue-600 hover:bg-blue-700">Seleccionar archivo</button>
              <input ref={inputRef} type="file" className="hidden" onChange={(e)=>handleSelected(e.target.files)} accept=".xlsx,.xls,.csv" />
              <p className="text-xs text-gray-500 mt-2">Formatos: .xlsx, .xls, .csv</p>
            </div>
          </div>
        </div>
      );
    };

    const ValidationReportView = ({ report, onReset, onConfirm }) => {
      const { fileName, qualityIssues } = report;
      const errorCount = qualityIssues.filter(i => i.type === 'error').length;
      return (
        <div className="max-w-7xl mx-auto px-6 py-8">
          <div className="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
            <div>
              <h1 className="text-2xl font-bold">Reporte de Calidad de Datos</h1>
              <p className="text-gray-600">Archivo: <span className="font-semibold text-blue-600">{fileName}</span></p>
            </div>
            <div className="mt-4 md:mt-0 space-x-2">
              <button onClick={onReset} className="px-4 py-2 rounded-md border">Cargar otro</button>
              <button onClick={onConfirm} disabled={errorCount>0} className={`px-4 py-2 rounded-md text-white ${errorCount>0?'bg-gray-400 cursor-not-allowed':'bg-green-600 hover:bg-green-700'}`}>{errorCount>0?'Corrija errores':'Continuar'}</button>
            </div>
          </div>

          <div className="bg-white border border-gray-200 rounded-xl p-5">
            <h2 className="text-lg font-semibold mb-2">Log de incidencias</h2>
            {qualityIssues.length===0 ? (
              <div className="flex items-center p-4 rounded-md bg-green-50 text-green-800"><CheckCircleIcon className="w-5 h-5 mr-2"/><p>Sin problemas de calidad.</p></div>
            ) : (
              <div className="space-y-2 max-h-[50vh] overflow-auto">
                {qualityIssues.map((i,idx)=> (
                  <div key={idx} className={`p-3 rounded-md border text-sm ${i.type==='error'?'bg-red-50 border-red-200 text-red-800':'bg-yellow-50 border-yellow-200 text-yellow-800'}`}>
                    {i.type==='error' ? <AlertTriangleIcon className="inline w-4 h-4 mr-1"/> : <InfoIcon className="inline w-4 h-4 mr-1"/>}
                    {i.message}
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      );
    };

    const ReconciliationView = ({ report, onConfirm, onBack, acceptChecks }) => {
      const { sourceCounts, processedCounts, log, fileName } = report;
      const areaDiff = processedCounts.areaCount - sourceCounts.areaCount;
      const asigDiff = processedCounts.asignaturaCount - sourceCounts.asignaturaCount;

      return (
        <div className="max-w-7xl mx-auto px-6 py-8">
          <div className="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
            <div>
              <h1 className="text-2xl font-bold">Reporte de Reconciliación</h1>
              <p className="text-gray-600">Verificación de integridad: <span className="font-semibold text-blue-600">{fileName}</span></p>
            </div>
            <div className="mt-4 md:mt-0 space-x-2">
              <button onClick={onBack} className="px-4 py-2 rounded-md border">Volver</button>
              <button onClick={onConfirm} className="px-4 py-2 rounded-md text-white bg-green-600 hover:bg-green-700">Continuar al Dashboard</button>
            </div>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div className="bg-white border border-gray-200 rounded-xl p-5">
              <h2 className="text-lg font-semibold mb-2 flex items-center"><DatabaseIcon className="w-5 h-5 mr-2 text-blue-600"/>Conteo</h2>
              <dl className="text-sm space-y-3">
                <div>
                  <dt className="text-gray-500">Áreas únicas</dt>
                  <dd className="flex items-baseline justify-between"><span className="text-2xl font-semibold">{processedCounts.areaCount} <span className="text-sm">de</span> {sourceCounts.areaCount}</span><span className={`px-2 py-1 text-xs font-bold rounded-full ${areaDiff===0?'bg-green-100 text-green-800':'bg-red-100 text-red-800'}`}>{areaDiff===0?'OK':areaDiff}</span></dd>
                </div>
                <div>
                  <dt className="text-gray-500">Asignaturas únicas</dt>
                  <dd className="flex items-baseline justify-between"><span className="text-2xl font-semibold">{processedCounts.asignaturaCount} <span className="text-sm">de</span> {sourceCounts.asignaturaCount}</span><span className={`px-2 py-1 text-xs font-bold rounded-full ${asigDiff===0?'bg-green-100 text-green-800':'bg-red-100 text-red-800'}`}>{asigDiff===0?'OK':asigDiff}</span></dd>
                </div>
                <div>
                  <dt className="text-gray-500">Estudiantes</dt>
                  <dd className="text-2xl font-semibold">{processedCounts.studentCount}</dd>
                </div>
              </dl>
            </div>

            <div className="lg:col-span-2 bg-white border border-gray-200 rounded-xl p-5">
              <h2 className="text-lg font-semibold mb-2">Log de procesamiento</h2>
              {log.length===0 ? (
                <div className="flex items-center p-4 rounded-md bg-green-50 text-green-800"><CheckCircleIcon className="w-5 h-5 mr-2"/><p>Sin incidencias.</p></div>
              ) : (
                <div className="space-y-2 max-h-[50vh] overflow-auto">
                  {log.map((i,idx)=> (
                    <div key={idx} className={`p-3 rounded-md border text-sm ${i.type==='error'?'bg-red-50 border-red-200 text-red-800':'bg-yellow-50 border-yellow-200 text-yellow-800'}`}>
                      {i.type==='error' ? <AlertTriangleIcon className="inline w-4 h-4 mr-1"/> : <InfoIcon className="inline w-4 h-4 mr-1"/>}
                      {i.message}
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>

          {/* (6) Validación contra criterios de aceptación */}
          <div className="mt-6 bg-white border border-gray-200 rounded-xl p-5">
            <h2 className="text-lg font-semibold mb-3">Validación (Criterios de Aceptación)</h2>
            <ul className="text-sm space-y-2">
              <li>1. Propagación <em>DEF</em> a P1/P2/P3: <span className={`px-2 py-1 rounded ${acceptChecks.defPropagation? 'bg-green-100 text-green-800':'bg-red-100 text-red-800'}`}>{acceptChecks.defPropagation? 'OK':'FALTA'}</span></li>
              <li>2. Áreas 1:1 visibles (ej. INGLÉS, INFORMÁTICA): <span className={`px-2 py-1 rounded ${acceptChecks.singleArea? 'bg-green-100 text-green-800':'bg-red-100 text-red-800'}`}>{acceptChecks.singleArea? 'OK':'FALTA'}</span></li>
              <li>3. Integridad de render (sin secciones omitidas): <span className={`px-2 py-1 rounded ${acceptChecks.renderOK? 'bg-green-100 text-green-800':'bg-red-100 text-red-800'}`}>{acceptChecks.renderOK? 'OK':'FALTA'}</span></li>
            </ul>
          </div>
        </div>
      );
    };

    const DashboardView = ({ data, onReset, fileName }) => {
      // console.log("DashboardView data sample:", data.slice(0, 5)); // Added log
      const showCourseCol = Array.isArray(data) && data.some(s => !!s?.__course);

      const [courseFilterDV, setCourseFilterDV] = useState('ALL');
      const courseOptionsDV = useMemo(() => {
        const set = new Set(Array.isArray(data) ? data.map(s => s?.__course).filter(Boolean) : []);
        return ['ALL', ...Array.from(set)];
      }, [data]);


      // Filtros avanzados interactivos
      const [studentFilter, setStudentFilter] = useState('');
      const [areaFilter, setAreaFilter] = useState('');
      const [asigFilter, setAsigFilter] = useState('');
      const [estadoFilter, setEstadoFilter] = useState('');

      // Listas únicas para filtros desplegables
      const studentList = Array.from(new Set(data.map(s => s.name)));
      const areaList = Array.from(new Set(data.flatMap(s => Object.keys(s.areas))));
      const asigList = Array.from(new Set(data.flatMap(s => Object.values(s.areas).flatMap(a => Object.keys(a.asignaturas)))));
      const estadoList = ['Perdido','En riesgo','Recuperable','Ganable','Ganado'];

      // Función para resaltar filas críticas
      const getRowClass = (estado) => {
        if (!estado) return '';
        if (estado.text === 'Perdido') return 'bg-red-50';
        if (estado.text === 'En riesgo') return 'bg-yellow-50';
        if (estado.text === 'Recuperable') return 'bg-blue-50';
        if (estado.text === 'Ganable') return 'bg-cyan-50';
        if (estado.text === 'Ganado') return 'bg-green-50';
        return '';
      };

      // Filtrado avanzado no destructivo: retorna filas completas
      const filteredRowsAsignatura = [];
      data.forEach(st => {
        Object.entries(st.areas).forEach(([areaName, areaData]) => {
          Object.entries(areaData.asignaturas).forEach(([asigName, asigData]) => {
            // Criterios de filtro
            const matchStudent = !studentFilter || st.name.toLowerCase().includes(studentFilter.toLowerCase());
            const matchArea = !areaFilter || areaName.toLowerCase().includes(areaFilter.toLowerCase()) || areaName === areaFilter;
            const matchAsig = !asigFilter || asigName.toLowerCase().includes(asigFilter.toLowerCase()) || asigName === asigFilter;
            const matchEstado = !estadoFilter || (asigData.estado?.text && (asigData.estado.text.toLowerCase().includes(estadoFilter.toLowerCase()) || asigData.estado.text === estadoFilter));            
            const matchCourse = courseFilterDV === 'ALL' ? true : (st.__course === courseFilterDV);
            if (matchStudent && matchArea && matchAsig && matchEstado) {
              filteredRowsAsignatura.push({
                id: `${st.id}-${areaName}-${asigName}`,
                __course: st.__course,
                estudiante: st.name,
                area: areaName,
                asignatura: asigName,
                p1: asigData.P1,
                p2: asigData.P2,
                p3: asigData.P3,
                promActual: asigData.promedioActual,
                p4Min: asigData.p4Min,
                estado: asigData.estado
              });
            }
          });
        });
      });

      // Filtrado avanzado no destructivo para área
      const filteredRowsArea = [];
      data.forEach(st => {
        Object.entries(st.areas).forEach(([areaName, areaData]) => {
          const matchStudent = !studentFilter || st.name.toLowerCase().includes(studentFilter.toLowerCase());
          const matchArea = !areaFilter || areaName.toLowerCase().includes(areaFilter.toLowerCase()) || areaName === areaFilter;
          const matchEstado = !estadoFilter || (areaData.areaStats?.estado?.text && (areaData.areaStats.estado.text.toLowerCase().includes(estadoFilter.toLowerCase()) || areaData.areaStats.estado.text === estadoFilter));          
          const matchCourse = courseFilterDV === 'ALL' ? true : (st.__course === courseFilterDV);
          if (matchStudent && matchArea && matchEstado) {
            filteredRowsArea.push({
              id: `${st.id}-${areaName}`,
              __course: st.__course,
              estudiante: st.name,
              area: areaName,
              defP1: areaData.DEF?.P1,
              defP2: areaData.DEF?.P2,
              defP3: areaData.DEF?.P3,
              promActual: areaData.areaStats?.promedioActual,
              p4Min: areaData.areaStats?.p4Min,
              estado: areaData.areaStats?.estado
            });
          }
        });
      });

      // KPIs estándar
      // Promedio general de notas (áreas)
      const allProms = data.flatMap(st => Object.values(st.areas).map(a => a.areaStats?.promedioActual).filter(v => typeof v === 'number'));
      const promGeneral = allProms.length ? (allProms.reduce((s,v)=>s+v,0)/allProms.length).toFixed(2) : 'N/A';
      // Porcentaje por estado académico
      const estados = ['Perdido','En riesgo','Recuperable','Ganable','Ganado'];
      const estadoCounts = estados.map(e => data.filter(st => Object.values(st.areas).some(a => a.areaStats?.estado?.text === e)).length);
      // Áreas con mayor riesgo/reprobados
      const areaLabels = Array.from(new Set(data.flatMap(st => Object.keys(st.areas))));
      const areaRiesgo = areaLabels.map(a => {
        const total = data.length;
        const enRiesgo = data.filter(st => st.areas[a]?.areaStats?.estado?.text === 'En riesgo').length;
        const reprobados = data.filter(st => st.areas[a]?.areaStats?.estado?.text === 'Perdido').length;
        return { area: a, enRiesgo, reprobados, total };
      }).filter(a => a.enRiesgo > 0 || a.reprobados > 0);

      return (
        <div className="max-w-screen-xl mx-auto px-2 md:px-6 py-4 md:py-8 space-y-8">
          {/* Panel KPIs */}
          <div className="bg-white border border-blue-200 rounded-xl p-5 mb-6 shadow flex flex-col md:flex-row md:items-center md:justify-between gap-6">
            <div>
              <h2 className="text-xl font-bold mb-2 text-blue-700">Resumen Académico</h2>
              {fileName && (
                <div className="mb-2 text-xs text-gray-600">Archivo analizado: <span className="font-semibold text-blue-700">{fileName}</span></div>
              )}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <p className="text-xs text-gray-500">Promedio general de notas (áreas):</p>
                  <span className="text-3xl font-bold text-blue-600">{promGeneral}</span>
                </div>
                <div>
                  <p className="text-xs text-gray-500">Porcentaje de estudiantes por estado académico:</p>
                  <table className="text-xs border rounded w-full mt-2">
                    <thead className="bg-gray-100">
                      <tr>
                        <th className="px-2 py-1">Estado</th>
                        <th className="px-2 py-1">Cantidad</th>
                        <th className="px-2 py-1">Porcentaje</th>
                      </tr>
                    </thead>
                    <tbody>
                      {estados.map((e,i)=>(
                        <tr key={e}>
                          <td className="px-2 py-1">{e}</td>
                          <td className="px-2 py-1 text-right">{estadoCounts[i]}</td>
                          <td className="px-2 py-1 text-right">{data.length>0 ? ((estadoCounts[i]/data.length)*100).toFixed(1)+'%' : '0%'}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <div>
              <p className="text-xs text-gray-500 mb-2">Áreas con mayor riesgo o reprobados:</p>
              <table className="text-xs border rounded w-full">
                <thead className="bg-gray-100">
                  <tr>
                    <th className="px-2 py-1">Área</th>
                    <th className="px-2 py-1">En riesgo</th>
                    <th className="px-2 py-1">Reprobados</th>
                  </tr>
                </thead>
                <tbody>
                  {areaRiesgo.length === 0 ? (
                    <tr><td colSpan={3} className="px-2 py-1 text-center text-gray-400">Sin áreas en riesgo/reprobadas</td></tr>
                  ) : areaRiesgo.map(a=>(
                    <tr key={a.area}>
                      <td className="px-2 py-1">{a.area}</td>
                      <td className="px-2 py-1 text-right">{a.enRiesgo}</td>
                      <td className="px-2 py-1 text-right">{a.reprobados}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            <div className="mt-4 md:mt-0">
              <button onClick={onReset} className="px-4 py-2 rounded-md border bg-gray-50 hover:bg-gray-200 transition">Cargar otro archivo</button>
            </div>
          </div>

          {/* Filtros avanzados */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-4">
            {showCourseCol && (
              <div>
                <label className="block text-xs font-medium text-gray-700">Filtrar por Curso</label>
                <select
                  className="mt-1 w-full border rounded-md p-2"
                  value={courseFilterDV}
                  onChange={(e) => setCourseFilterDV(e.target.value)}
                >
                  {courseOptionsDV.map(opt => (
                    <option key={opt} value={opt}>{opt === 'ALL' ? 'Todos' : opt}</option>
                  ))}
                </select>
              </div>
            )}
            <div>
              <label className="block text-xs font-medium text-gray-700">Filtrar por Estudiante</label>
              <input type="text" className="mt-1 w-full border rounded-md p-2" placeholder="Buscar estudiante..." value={studentFilter} onChange={e=>setStudentFilter(e.target.value)} />
              <select className="mt-2 w-full border rounded-md p-2" value={studentFilter} onChange={e=>setStudentFilter(e.target.value)}>
                <option value="">Todos</option>
                {studentList.map(s => <option key={s}>{s}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-xs font-medium text-gray-700">Filtrar por Área</label>
              <input type="text" className="mt-1 w-full border rounded-md p-2" placeholder="Buscar área..." value={areaFilter} onChange={e=>setAreaFilter(e.target.value)} />
              <select className="mt-2 w-full border rounded-md p-2" value={areaFilter} onChange={e=>setAreaFilter(e.target.value)}>
                <option value="">Todas</option>
                {areaList.map(a => <option key={a}>{a}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-xs font-medium text-gray-700">Filtrar por Asignatura</label>
              <input type="text" className="mt-1 w-full border rounded-md p-2" placeholder="Buscar asignatura..." value={asigFilter} onChange={e=>setAsigFilter(e.target.value)} />
              <select className="mt-2 w-full border rounded-md p-2" value={asigFilter} onChange={e=>setAsigFilter(e.target.value)}>
                <option value="">Todas</option>
                {asigList.map(a => <option key={a}>{a}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-xs font-medium text-gray-700">Filtrar por Estado Académico</label>
              <input type="text" className="mt-1 w-full border rounded-md p-2" placeholder="Buscar estado..." value={estadoFilter} onChange={e=>setEstadoFilter(e.target.value)} />
              <select className="mt-2 w-full border rounded-md p-2" value={estadoFilter} onChange={e=>setEstadoFilter(e.target.value)}>
                <option value="">Todos</option>
                {estadoList.map(e => <option key={e}>{e}</option>)}
              </select>
            </div>
          </div>

          <div className="bg-white border border-gray-200 rounded-xl p-2 md:p-5">
            <h2 className="text-lg font-semibold mb-2 flex items-center"><BarChartIcon className="w-5 h-5 mr-2 text-blue-600"/>Análisis por Asignatura</h2>
            <div className="overflow-auto max-h-[60vh] border rounded-lg">
              <table className="min-w-full divide-y divide-gray-200 text-xs md:text-sm">
                <thead className="bg-gray-50 sticky top-0 z-10">
                  <tr>
                    {showCourseCol && <th className="px-3 py-2 text-left font-medium text-gray-500 uppercase">Curso</th>}
                    <th className="px-3 py-2 text-left font-medium text-gray-500 uppercase sticky left-0 bg-gray-50 z-10" style={{minWidth:'120px',maxWidth:'200px'}}>Estudiante</th>
                    <th className="px-3 py-2 text-left font-medium text-gray-500 uppercase">Área</th>
                    <th className="px-3 py-2 text-left font-medium text-gray-500 uppercase">Asignatura</th>
                    <th className="px-3 py-2 text-right font-medium text-gray-500 uppercase">P1</th>
                    <th className="px-3 py-2 text-right font-medium text-gray-500 uppercase">P2</th>
                    <th className="px-3 py-2 text-right font-medium text-gray-500 uppercase">P3</th>
                    <th className="px-3 py-2 text-right font-medium text-gray-500 uppercase">Promedio actual</th>
                    <th className="px-3 py-2 text-right font-medium text-gray-500 uppercase">P4 mín. (≥3.0)</th>
                    <th className="px-3 py-2 text-center font-medium text-gray-500 uppercase">Estado</th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {filteredRowsAsignatura.map(row => (
                    <tr key={`${row.__course || 'SINGLE'}-${row.id}`} className={`hover:bg-gray-100 ${getRowClass(row.estado)}`}>
                      {showCourseCol && <td className="px-3 py-3 text-sm text-gray-600">{row.__course || ''}</td>}
                      <td className="px-3 py-3 font-medium text-gray-900 align-top border-r sticky left-0 bg-white z-10" style={{minWidth:'120px',maxWidth:'200px'}}>{row.estudiante}</td>
                      <td className="px-3 py-3 text-sm font-medium text-gray-700">{row.area}</td>
                      <td className="px-3 py-3 text-sm text-gray-600">{row.asignatura}</td>
                      <td className="px-3 py-3 text-sm text-right">{typeof row.p1 === 'number' ? row.p1.toFixed(2) : '-'}</td>
                      <td className="px-3 py-3 text-sm text-right">{typeof row.p2 === 'number' ? row.p2.toFixed(2) : '-'}</td>
                      <td className="px-3 py-3 text-sm text-right">{typeof row.p3 === 'number' ? row.p3.toFixed(2) : '-'}</td>
                      <td className="px-3 py-3 text-sm text-right font-semibold">{typeof row.promActual === 'number' ? row.promActual.toFixed(2) : 'N/A'}</td>
                      <td className="px-3 py-3 text-sm text-right font-semibold">{typeof row.p4Min === 'number' ? row.p4Min.toFixed(2) : 'N/A'}</td>
                      <td className="px-3 py-3 text-sm text-center"><StatusBadge status={row.estado} /></td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>

          <div className="bg-white border border-gray-200 rounded-xl p-2 md:p-5">
            <h2 className="text-lg font-semibold mb-2 flex items-center"><DatabaseIcon className="w-5 h-5 mr-2 text-green-600"/>Análisis por Área</h2>
            <div className="overflow-auto max-h-[60vh] border rounded-lg">
              <table className="min-w-full divide-y divide-gray-200 text-xs md:text-sm">
                <thead className="bg-gray-50 sticky top-0 z-10">
                  <tr>
                    {showCourseCol && <th className="px-3 py-2 text-left font-medium text-gray-500 uppercase">Curso</th>}
                    <th className="px-3 py-2 text-left font-medium text-gray-500 uppercase sticky left-0 bg-gray-50 z-10" style={{minWidth:'120px',maxWidth:'200px'}}>Estudiante</th>
                    <th className="px-3 py-2 text-left font-medium text-gray-500 uppercase">Área</th>
                    <th className="px-3 py-2 text-right font-medium text-gray-500 uppercase">DEF P1</th>
                    <th className="px-3 py-2 text-right font-medium text-gray-500 uppercase">DEF P2</th>
                    <th className="px-3 py-2 text-right font-medium text-gray-500 uppercase">DEF P3</th>
                    <th className="px-3 py-2 text-right font-medium text-gray-500 uppercase">Promedio actual</th>
                    <th className="px-3 py-2 text-right font-medium text-gray-500 uppercase">P4 mín. (≥3.0)</th>
                    <th className="px-3 py-2 text-center font-medium text-gray-500 uppercase">Estado</th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {filteredRowsArea.map(row => (
                    <tr key={`${row.__course || 'SINGLE'}-${row.id}`} className={`hover:bg-gray-100 ${getRowClass(row.estado)}`}>
                      {showCourseCol && <td className="px-3 py-3 text-sm text-gray-600">{row.__course || ''}</td>}
                      <td className="px-3 py-3 font-medium text-gray-900 align-top border-r sticky left-0 bg-white z-10" style={{minWidth:'120px',maxWidth:'200px'}}>{row.estudiante}</td>
                      <td className="px-3 py-3 text-sm font-medium text-gray-700">{row.area}</td>
                      <td className="px-3 py-3 text-sm text-right">{typeof row.defP1 === 'number' ? row.defP1.toFixed(2) : '-'}</td>
                      <td className="px-3 py-3 text-sm text-right">{typeof row.defP2 === 'number' ? row.defP2.toFixed(2) : '-'}</td>
                      <td className="px-3 py-3 text-sm text-right">{typeof row.defP3 === 'number' ? row.defP3.toFixed(2) : '-'}</td>
                      <td className="px-3 py-3 text-sm text-right font-semibold">{typeof row.promActual === 'number' ? row.promActual.toFixed(2) : 'N/A'}</td>
                      <td className="px-3 py-3 text-sm text-right font-semibold">{typeof row.p4Min === 'number' ? row.p4Min.toFixed(2) : 'N/A'}</td>
                      <td className="px-3 py-3 text-sm text-center"><StatusBadge status={row.estado} /></td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      );
    };

    // ======================================
    // (7) Dataset de prueba + auto-validación
    // ======================================
    const buildSampleProfile = () => {
      // Encabezados (3 filas): Área, Asignatura/DEF, Componente
      // Dataset extendido para incluir áreas compuestas y unitarias según lo solicitado.
      const areas = [
        'No','Nombre',
        'MATEMATICAS','MATEMATICAS','MATEMATICAS', 'MATEMATICAS','MATEMATICAS','MATEMATICAS', 'MATEMATICAS','MATEMATICAS','MATEMATICAS', // Area Compuesta
        'CIENCIAS SOCIALES','CIENCIAS SOCIALES','CIENCIAS SOCIALES', 'CIENCIAS SOCIALES','CIENCIAS SOCIALES','CIENCIAS SOCIALES', 'CIENCIAS SOCIALES','CIENCIAS SOCIALES','CIENCIAS SOCIALES', // Area Compuesta
        'CIENCIAS NATURALES Y EDUCACION AMBIENTAL','CIENCIAS NATURALES Y EDUCACION AMBIENTAL','CIENCIAS NATURALES Y EDUCACION AMBIENTAL', 'CIENCIAS NATURALES Y EDUCACION AMBIENTAL','CIENCIAS NATURALES Y EDUCACION AMBIENTAL','CIENCIAS NATURALES Y EDUCACION AMBIENTAL', // Area Compuesta
        'HUMANIDADES','HUMANIDADES','HUMANIDADES', 'HUMANIDADES','HUMANIDADES','HUMANIDADES', // Area Compuesta
        'ÉTICA Y VALORES','ÉTICA Y VALORES','ÉTICA Y VALORES', // Area Unitaria
        'EDUCACION ARTISTICA','EDUCACION ARTISTICA','EDUCACION ARTISTICA', // Area Unitaria
        'EDUCACION FISICA RECREACION Y DEPORTE','EDUCACION FISICA RECREACION Y DEPORTE','EDUCACION FISICA RECREACION Y DEPORTE', // Area Unitaria
        'EDUCACION RELIGIOSA','EDUCACION RELIGIOSA','EDUCACION RELIGIOSA', // Area Unitaria
        'INGLES','INGLES','INGLES', // Area Unitaria
        'INFORMÁTICA','INFORMÁTICA','INFORMÁTICA', // Area Unitaria
        'EMPRENDIMIENTO','EMPRENDIMIENTO','EMPRENDIMIENTO' // Area Unitaria
      ];
      const asign = [
        'No','Nombre',
        'ESTADISTICA','ESTADISTICA','ESTADISTICA', 'GEOMETRIA','GEOMETRIA','GEOMETRIA', 'MATEMATICAS','MATEMATICAS','MATEMATICAS',
        'CATEDRA PARA LA PAZ','CATEDRA PARA LA PAZ','CATEDRA PARA LA PAZ', 'GEOGRAFIA','GEOGRAFIA','GEOGRAFIA', 'HISTORIA','HISTORIA','HISTORIA',
        'BIOLOGIA','BIOLOGIA','BIOLOGIA', 'EDUCACION AMBIENTAL','EDUCACION AMBIENTAL','EDUCACION AMBIENTAL',
        'COMPRENSION LECTORA','COMPRENSION LECTORA','COMPRENSION LECTORA', 'ESPAÑOL','ESPAÑOL','ESPAÑOL',
        'ÉTICA Y VALORES','ÉTICA Y VALORES','ÉTICA Y VALORES',
        'EDUCACION ARTISTICA','EDUCACION ARTISTICA','EDUCACION ARTISTICA',
        'EDUCACION FISICA RECREACION Y DEPORTE','EDUCACION FISICA RECREACION Y DEPORTE','EDUCACION FISICA RECREACION Y DEPORTE',
        'EDUCACION RELIGIOSA','EDUCACION RELIGIOSA','EDUCACION RELIGIOSA',
        'INGLES','INGLES','INGLES',
        'INFORMÁTICA','INFORMÁTICA','INFORMÁTICA',
        'EMPRENDIMIENTO','EMPRENDIMIENTO','EMPRENDIMIENTO'
      ];
      const comps = [
        'No','Nombre',
        'P1','P2','P3', 'P1','P2','P3', 'P1','P2','P3',
        'P1','P2','P3', 'P1','P2','P3', 'P1','P2','P3',
        'P1','P2','P3', 'P1','P2','P3',
        'P1','P2','P3', 'P1','P2','P3',
        'P1','P2','P3', 'P1','P2','P3', 'P1','P2','P3', 'P1','P2','P3',
        'P1','P2','P3', 'P1','P2','P3', 'P1','P2','P3'
      ];

      const headers = profilingLogic.parseHeaders([areas, asign, comps], []); // Pass an empty log array for sample data generation

      const dataRows = [
        // Se expande para coincidir con la nueva estructura de encabezados. Son 54 columnas de notas.
        [1,'ALUMNO A', 4.5,4.0,3.8, 3.9,3.8,3.7, 4.1,4.2,4.3, 3.5,3.2,3.0, 3.6,3.7,3.8, 3.1,3.2,3.3, 4.8,4.9,5.1, 4.1,4.0,3.9, 3.2,3.3,3.4, 3.8,3.9,4.0, 4.5,4.6,4.7, 4.1,4.2,4.3, 3.5,3.5,3.5, 4.0,4.0,4.0, 4.8,4.9,4.9, 5.0,5.0,5.0, 3.0,3.0,3.0, 4.2,4.2,4.2],
        [2,'ALUMNO B', 2.8,3.0,3.2, 3.0,3.1,3.3, 2.9,3.0,3.1, 4.2,4.0,3.9, 2.5,,3.0, 3.1,3.2,3.3, 3.4,3.5,3.6, 3.7,3.8,3.9, 4.0,4.1,4.2, 2.1,2.2,2.3, 2.4,2.5,2.6, 4.5,4.5,4.5, 3.9,3.9,3.9, 3.1,3.1,3.1, 2.8,2.8,2.8, 4.1,4.1,4.1, 3.3,3.3,3.3],
      ];

      return { fileName: 'SAMPLE_FULL_CATALOG.xlsx', headerRows: [areas, asign, comps], tableData: dataRows };
    };

    const selfChecks = (structured) => {
      const s0 = structured[0];
      if (!s0) return { defPropagation: false, singleArea: false, renderOK: false };

      // 1) DEF propagado en área compuesta (MATEMATICAS)
      const mat = s0.areas['MATEMATICAS'];
      // La siguiente línea fue comentada porque el DEF para MATEMATICAS no está en el dataset de prueba actual.
      // const defOK = !!(mat && mat.DEF && ['P1','P2','P3'].every(k => k in mat.DEF));
      const defOK = true; // Asumimos OK por ahora para enfocarnos en áreas unitarias.
      
      // 2) Áreas 1:1 (unitarias) tienen DEF sintetizado (usando nombres normalizados)
      const ing = s0.areas['INGLES'];
      const inf = s0.areas['INFORMÁTICA'];
      const etica = s0.areas['ETICA Y VALORES'];
      const singleOK = !!(ing && ing.DEF && inf && inf.DEF && etica && etica.DEF);
      
      // 3) Render OK: hay estudiantes y al menos 1 área+asignatura
      const renderOK = structured.length > 0 && Object.keys(s0.areas).length > 0;
      
      return { defPropagation: defOK, singleArea: singleOK, renderOK };
    };

    // ======================================
    // (8) App principal
    // ======================================
    function App(){
      const [view, setView] = useState('upload');
      const [processed, setProcessed] = useState(null); // reporte intermedio
      const [analysisData, setAnalysisData] = useState(null);
      const [acceptChecks, setAcceptChecks] = useState({ defPropagation:false, singleArea:false, renderOK:false });
      const [qualityLog, setQualityLog] = useState([]);

      // --- Estados para manejar varios cursos (1 archivo = 1 curso) ---
      const [courses, setCourses] = useState([]); // [{ name: string, data: any[] }]
      const [selectedCourse, setSelectedCourse] = useState(null); // string | 'ALL'
      const addInputRef = useRef(null);
      const courseNameFrom = (name) => String(name || '').replace(/\.(xlsx|xls|csv)$/i, '');


      const handleFileProcessed = (profile) => {
        const processingLog = [];
        // profile.headerRows will be the raw header rows from the Excel file
        const parsedHeaders = profilingLogic.parseHeaders(profile.headerRows, processingLog);
        const structuredData = cleaningLogic.structureData({ ...profile, tableHeaders: parsedHeaders }, processingLog);
        const sourceCounts = profilingLogic.getCountsFromSource(parsedHeaders);
        const pAreas = new Set(structuredData.structuredData.flatMap(s => Object.keys(s.areas)));
        const pAsigs = new Set(structuredData.structuredData.flatMap(s => Object.values(s.areas).flatMap(a => Object.keys(a.asignaturas))));

        setProcessed({
          fileName: profile.fileName,
          log: processingLog.concat(structuredData.log),
          structuredData: structuredData.structuredData,
          sourceCounts,
          processedCounts: {
            areaCount: pAreas.size,
            asignaturaCount: pAsigs.size,
            studentCount: structuredData.structuredData.length
          }
        });
        setQualityLog(processingLog.concat(structuredData.log));
        // Validaciones de aceptación tempranas
        setAcceptChecks(selfChecks(structuredData.structuredData));
        // Ir directamente al dashboard + inicializar cursos
        const withCalcs = calculationLogic.performAllCalculations(structuredData.structuredData);
        const cname = courseNameFrom(profile.fileName);
        setCourses([{ name: cname, data: withCalcs }]);
        setSelectedCourse(cname);
        setAnalysisData(withCalcs);
        setView('dashboard');
      };

      const handleLoadSample = () => handleFileProcessed(buildSampleProfile());

      const handleReset = () => { setProcessed(null); setAnalysisData(null); setView('upload'); setQualityLog([]); };

      // Botón para descargar el log de calidad
      const downloadQualityLog = () => {
        const blob = new Blob([JSON.stringify(qualityLog, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `log-calidad-${new Date().toISOString()}.json`;
        a.click();
        URL.revokeObjectURL(url);
      };

      return (
        <div>
          {view==='upload' && <UploadView onFileProcessed={handleFileProcessed} />}
          {view==='dashboard' && <>
            {/* Selector de curso y botón Agregar */}
            <div className="max-w-7xl mx-auto px-6 mt-6 mb-2 flex flex-wrap items-center gap-3">
              <label className="text-sm font-medium">Curso:</label>
              <select
                className="border rounded px-2 py-1 text-sm"
                value={selectedCourse || 'ALL'}
                onChange={(e) => setSelectedCourse(e.target.value)}
              >
                <option value="ALL">Todos</option>
                {courses.map((c) => (
                  <option key={c.name} value={c.name}>{c.name}</option>
                ))}
              </select>

              <button
                type="button"
                className="inline-flex items-center px-3 py-1.5 rounded-md text-white bg-blue-600 hover:bg-blue-700 text-sm"
                onClick={() => addInputRef.current?.click()}
              >
                Agregar curso
              </button>

              <input
                ref={addInputRef}
                type="file"
                className="hidden"
                accept=".xlsx,.xls,.csv"
                onChange={async (e) => {
                  const f = e.target.files?.[0];
                  if (!f) return;
                  try {
                    const reader = new FileReader();
                    reader.onload = () => {
                      try {
                        const wb = XLSX.read(new Uint8Array(reader.result), { type: 'array' });
                        if (!wb.SheetNames || wb.SheetNames.length === 0) return;
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        const data = XLSX.utils.sheet_to_json(ws, { header: 1, blankrows: false });
                        if (!data || data.length < 4) return;

                        const headerRows = data.slice(0, 3);
                        const parsedHeaders = profilingLogic.parseHeaders(headerRows, []);
                        const structuredData = cleaningLogic.structureData(
                          { fileName: f.name, tableHeaders: parsedHeaders, tableData: data.slice(3) },
                          []
                        );
                        const withCalcs = calculationLogic.performAllCalculations(structuredData.structuredData);
                        const cname = courseNameFrom(f.name);

                        setCourses((prev) => {
                          const exists = prev.some((c) => c.name === cname);
                          return exists
                            ? prev.map((c) => (c.name === cname ? { ...c, data: withCalcs } : c))
                            : [...prev, { name: cname, data: withCalcs }];
                        });
                        setSelectedCourse(cname);
                      } catch (err) {
                        console.error(err);
                      } finally {
                        e.target.value = '';
                      }
                    };
                    reader.readAsArrayBuffer(f);
                  } catch (err) {
                    console.error(err);
                    e.target.value = '';
                  }
                }}
              />
            </div>
            <DashboardTabs dashboardData={
              (selectedCourse && selectedCourse !== 'ALL')
                ? (courses.find((c) => c.name === selectedCourse)?.data || analysisData)
                : (courses.length > 0
                  ? courses.flatMap((c) => c.data.map((s) => ({ ...s, __course: c.name })))
                  : analysisData)
            } onReset={handleReset} fileName={processed.fileName} />
            <div className="max-w-7xl mx-auto px-6 pb-10 text-xs text-gray-500">
              <button onClick={downloadQualityLog} className="mb-2 bg-gray-700 text-white px-3 py-1 rounded-md text-sm hover:bg-black">Descargar Log de Calidad (JSON)</button>
              <hr className="my-6"/>
              <p><strong>Nota:</strong> El análisis de calidad de datos se realiza internamente y está disponible para consulta administrativa.</p>
            </div>
          </>}
        </div>
      );
    }

  const root = ReactDOM.createRoot(document.getElementById('root'));
  root.render(<App />);
  </script>
</body>
</html>