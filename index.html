<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Acad√©mico Consolidado</title>

<script>
/** Hito 2 (C) ‚Äì Modo global determinista para todo el documento
 *  Regla: ?mode=prod fuerza PRODUCCI√ìN; ?mode=dev fuerza DESARROLLO.
 *  Si no hay query param y window.__PROD__ ya estaba definido, se respeta.
 *  Efecto: fija window.__PROD__ y data-mode en <html> para CSS/JS.
 */
(function () {
  var params = new URLSearchParams(location.search);
  var qp = (params.get("mode") || "").toLowerCase();

  if (qp === "prod")      window.__PROD__ = true;
  else if (qp === "dev")  window.__PROD__ = false;
  else if (typeof window.__PROD__ === "undefined") {
    window.__PROD__ = false; // por defecto, desarrollo
  }

  // Se√±al visible y utilizable por CSS/JS
  var mode = window.__PROD__ ? "prod" : "dev";
  document.documentElement.dataset.mode = mode;

  // Si activas __DASH_DEV__, muestra un aviso √∫til
  if (window.__DASH_DEV__) {
    console.log("[MODE]", "Aplicaci√≥n en modo:", mode.toUpperCase());
  }
})();
</script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // [THEME CONFIG] Configurar Tailwind para dark mode
    tailwind.config = {
      darkMode: 'class', // Enable class-based dark mode
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#eff6ff',
              500: '#3b82f6',
              900: '#1e3a8a'
            }
          }
        }
      }
    }
  </script>
  <!-- React + ReactDOM + Babel -->
  <!-- BACKUP (rollback r√°pido):
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
-->

<!-- BACKUP (rollback r√°pido) del switch previo con createElement(...) -->
<!--
<script>
/** Hito 2 (C) ‚Äì Switch Dev/Prod (React/ReactDOM UMD) sin romper Babel ni la app
 *  Modo por defecto: DEV. Forzar PROD con ?mode=prod o window.__PROD__=true.
 *  No tocar Babel por ahora (se mantiene para garantizar estabilidad).
 */
(function () {
  var REACT_DEV = "https://unpkg.com/react@18/umd/react.development.js";       // URL exacta previa (development.js)
  var REACTDOM_DEV = "https://unpkg.com/react-dom@18/umd/react-dom.development.js"; // URL exacta previa (development.js)

  // Derivar URLs de producci√≥n cambiando "development.js" por "production.min.js"
  var REACT_PROD = REACT_DEV.replace("development.js", "production.min.js");
  var REACTDOM_PROD = REACTDOM_DEV.replace("development.js", "production.min.js");

  var params = new URLSearchParams(location.search);
  var isProd = (params.get("mode") || "").toLowerCase() === "prod" || window.__PROD__ === true;

  function inject(src) {
    var s = document.createElement("script");
    s.src = src;
    s.defer = false; // mantener orden de carga
    document.head.appendChild(s);
  }

  inject(isProd ? REACT_PROD : REACT_DEV);
  inject(isProd ? REACTDOM_PROD : REACTDOM_DEV);
})();
</script>
-->

<!-- Hito 2 (C) ‚Äì Switch Dev/Prod S√çNCRONO para garantizar React antes de Babel -->
<script>
(function () {
  // [PinVersions] React 18.2.0 (UMD)
  var REACT_DEV     = "https://unpkg.com/react@18.2.0/umd/react.development.js";
  var REACTDOM_DEV  = "https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js";

  var REACT_PROD    = REACT_DEV.replace("development.js", "production.min.js");
  var REACTDOM_PROD = REACTDOM_DEV.replace("development.js", "production.min.js");

  var params = new URLSearchParams(location.search);
  var isProd = (params.get("mode") || "").toLowerCase() === "prod" || window.__PROD__ === true;

  var r1 = '<script src="' + (isProd ? REACT_PROD : REACT_DEV) + '" crossorigin="anonymous"><' + '/script>';
  var r2 = '<script src="' + (isProd ? REACTDOM_PROD : REACTDOM_DEV) + '" crossorigin="anonymous"><' + '/script>';
  document.write(r1); document.write(r2);
})();
</script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>
  <!-- Chart.js 4.4.4 UMD -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" crossorigin="anonymous"></script>
  <script>
    // Flag persistente para silenciar errores externos en DEV
    (function () {
      const KEY = 'suppressExternalErrors';
      if (localStorage.getItem(KEY) == null) {
        localStorage.setItem(KEY, 'true'); // por defecto ON
      }
      window.__SUPPRESS_EXTERNAL_CONSOLE_NOISE__ = localStorage.getItem(KEY) === 'true';

      // Helper para cambiar y persistir
      window.__setSuppressExternalErrors = (on) => {
        localStorage.setItem(KEY, on ? 'true' : 'false');
        window.__SUPPRESS_EXTERNAL_CONSOLE_NOISE__ = !!on;
      };
    })();
  </script>
  <script>
    // ===============================
    // DEV: Filtro de ruido de extensiones externas
    // - Filtra errores con source 'chrome-extension://', 'rc2Contentscript.js'
    // - Filtra 'Unchecked runtime.lastError', 'message port closed...'
    // - Captura: window.onerror, error event (capture), unhandledrejection,
    //   console.error y console.warn.
    // No afecta la l√≥gica del dashboard.
    // ===============================
    (function () {
      const isEnabled = () => !!window.__SUPPRESS_EXTERNAL_CONSOLE_NOISE__;
      const extSrc = (src) => typeof src === 'string' && (
        src.startsWith('chrome-extension://') || /rc2Contentscript\.js/i.test(src)
      );
      const msgHit = (msg) => {
        const s = String(msg || '');
        return /Unchecked runtime\.lastError/i.test(s)
            || /message port closed/i.test(s)
            || /rc2Contentscript\.js/i.test(s);
      };

      // 1) window.onerror (legacy)
      const originalOnError = window.onerror;
      window.onerror = function (message, source, lineno, colno, error) {
        try {
          if (isEnabled() && (extSrc(source) || msgHit(message))) {
            return true; // silenciado
          }
        } catch (_) {}
        return typeof originalOnError === 'function'
          ? originalOnError.apply(this, arguments)
          : false;
      };

      // 2) Captura en fase 'capture' de eventos 'error'
      window.addEventListener('error', function (ev) {
        try {
          const src = ev?.filename || ev?.target?.src || '';
          const msg = ev?.message || '';
          if (isEnabled() && (extSrc(src) || msgHit(msg))) {
            ev.preventDefault();
            ev.stopImmediatePropagation();
          }
        } catch (_) {}
      }, true);

      // 3) Promesas no manejadas
      window.addEventListener('unhandledrejection', function (ev) {
        try {
          const reason = ev?.reason;
          const text = reason && reason.message ? String(reason.message) : String(reason || '');
          if (isEnabled() && msgHit(text)) {
            ev.preventDefault();
            ev.stopImmediatePropagation();
          }
        } catch (_) {}
      }, true);

      // 4) console.error / console.warn
      const originalConsoleError = console.error;
      console.error = function () {
        try {
          const text = Array.from(arguments).map(a => (a && a.stack) ? a.stack : String(a)).join(' ');
          if (isEnabled() && (msgHit(text) || /chrome-extension:\/\//i.test(text))) {
            return;
          }
        } catch (_) {}
        return originalConsoleError.apply(console, arguments);
      };

      const originalConsoleWarn = console.warn;
      console.warn = function () {
        try {
          const text = Array.from(arguments).map(a => String(a)).join(' ');
          if (isEnabled() && (msgHit(text) || /chrome-extension:\/\//i.test(text))) {
            return;
          }
        } catch (_) {}
        return originalConsoleWarn.apply(console, arguments);
      };
    })();
  </script>
<script>
/** ResourceGuard ‚Äì Diagn√≥stico de CDNs y aviso de fallos (no intrusivo)
 *  - Loggea errores de recursos (CORS/SRI/bloqueos).
 *  - Verifica que Tailwind est√© aplicando estilos.
 *  - Muestra un banner discreto si algo falla.
 */
(function () {
  // Escucha errores de recursos (scripts/links)
  window.addEventListener('error', function (e) {
    var t = e.target || {};
    var isRes = t.tagName === 'SCRIPT' || t.tagName === 'LINK';
    if (!isRes) return;
    var url = t.src || t.href || '(desconocido)';
    console.warn('[ResourceGuard] Error cargando recurso:', t.tagName, url);
    showBanner('No se pudo cargar un recurso: ' + url + '. Revisa conexi√≥n, CORS o SRI.');
  }, true);

  // Tras DOM listo, valida que Tailwind aplique clases utilitarias b√°sicas
  document.addEventListener('DOMContentLoaded', function () {
    // Se usa un breve retraso para dar tiempo al script de Tailwind a escanear el DOM y aplicar estilos.
    setTimeout(function() {
      try {
        var probe = document.createElement('div');
        probe.className = 'hidden p-4';
        document.body.appendChild(probe);
        var cs = window.getComputedStyle(probe);
        var okHidden = cs.display === 'none';
        document.body.removeChild(probe);
        if (!okHidden) {
          console.warn('[ResourceGuard] Tailwind parece no estar activo (clase .hidden no aplicada).');
          showBanner('Tailwind no se aplic√≥ correctamente. Verifica la carga desde cdn.tailwindcss.com.');
        }
      } catch (err) {
        console.warn('[ResourceGuard] Error verificando Tailwind:', err);
      }
    }, 500);
  });

  // Banner minimalista y removible
  function showBanner(msg) {
    if (document.getElementById('res-guard-banner')) return;
    var b = document.createElement('div');
    b.id = 'res-guard-banner';
    b.setAttribute('role', 'status');
    b.textContent = '‚ö†Ô∏è ' + msg + ' ';
    var close = document.createElement('button');
    close.textContent = 'Cerrar';
    close.onclick = function () { b.remove(); };
    b.appendChild(close);
    document.body.appendChild(b);
  }
})();
</script>
  <script type="text/babel">
/** =========================================
 * Hito 1 (B): Flag DEV + DBG + profiling seguro
 * Producci√≥n silenciosa por defecto.
 * Para activar depuraci√≥n en runtime:
 *   window.__DASH_DEV__ = true
 * ========================================= */
window.__DASH_DEV__ = window.__DASH_DEV__ ?? false;

// [ErrorBoundary] Captura errores de render y muestra UI de recuperaci√≥n
class AppErrorBoundary extends React.Component {
  constructor(props){ super(props); this.state = { hasError: false, info: null }; }
  static getDerivedStateFromError(err){ return { hasError: true }; }
  componentDidCatch(error, info){ this.setState({ info }); if (window.__DASH_DEV__) console.error('[ErrorBoundary]', error, info); }
  handleRetry = () => {
    try { localStorage.setItem('lastErrorBoundaryAt', String(Date.now())); } catch (_) {}
    // Reintento suave: forzar un rerender del √°rbol sin recargar toda la p√°gina
    this.setState({ hasError: false, info: null });
    // Opcional: si persiste, ofrecer reload completo:
    // location.reload();
  };
  render(){
    if (this.state.hasError) {
      return (
        <div className="p-4 m-4 rounded-xl border border-gray-300 bg-white text-gray-800">
          <h2 className="text-base font-semibold mb-2">Ocurri√≥ un error inesperado</h2>
          <p className="text-sm mb-4">Puedes intentar continuar sin recargar. Si el problema persiste, refresca la p√°gina.</p>
          <button className="px-3 py-1.5 rounded-lg border border-gray-400" onClick={this.handleRetry}>Reintentar</button>
          {window.__DASH_DEV__ && this.state.info && (
            <pre className="mt-3 text-xs overflow-auto max-h-40">{JSON.stringify(this.state.info, null, 2)}</pre>
          )}
        </div>
      );
    }
    return this.props.children;
  }
}

// Evita aplicar el parche m√°s de una vez
if (!window.__DASH_PROF_PATCHED__) {
  window.__DASH_PROF_PATCHED__ = true;

  // Helper de depuraci√≥n controlado por flag
  window.DBG = (...args) => {
    if (window.__DASH_DEV__) console.log('[DBG]', ...args);
  };

  // Profiling sin "Timer already exists", dev-only
  (function () {
    const timers = new Map();
    const origLog = console.log.bind(console);

    const origTime = console.time?.bind(console);
    const origTimeEnd = console.timeEnd?.bind(console);

    console.time = (label = 'default') => {
      if (!window.__DASH_DEV__) return;        // no-op en prod
      if (timers.has(label)) return;           // evita timers duplicados
      timers.set(label, performance.now());
    };

    console.timeEnd = (label = 'default') => {
      if (!window.__DASH_DEV__) return;        // no-op en prod
      const start = timers.get(label);
      if (start == null) {
        origLog('[DBG] timeEnd sin time previo:', label);
        return;
      }
      const dur = performance.now() - start;
      timers.delete(label);
      origLog(`[time] ${label}: ${dur.toFixed(1)}ms`);
    };
  })();
}
    // ...existing imports and code...

    // =============================
    // Componente de Gr√°ficos (Chart.js) - Optimizado con React.memo
    // =============================
    const DashboardCharts = React.memo(({ rowsArea, rowsAsignatura }) => {
      console.time('render:DashboardCharts');
      const barRef = useRef(null);
      const pieRef = useRef(null);
      const radarRef = useRef(null);
      const charts = useRef({});

      const chartData = useMemo(() => {
        const data = rowsArea || [];
        if (!Array.isArray(data)) {
          return { estados: [], estadoCounts: [], areaLabels: [], areaProms: [] };
        }
        const estados = ['Perdido','En riesgo','Recuperable','Ganable','Ganado'];
        
        const studentStates = new Map();
        data.forEach(r => {
          if (r.estado && r.estado.text && r.estudiante) {
            if (!studentStates.has(r.estudiante)) {
              studentStates.set(r.estudiante, new Set());
            }
            studentStates.get(r.estudiante).add(r.estado.text);
          }
        });

        const estadoCounts = { Perdido: 0, 'En riesgo': 0, Recuperable: 0, Ganable: 0, Ganado: 0 };
        studentStates.forEach(stateSet => {
          stateSet.forEach(s => {
            if (estadoCounts.hasOwnProperty(s)) estadoCounts[s]++;
          });
        });

        const areaLabels = Array.from(new Set(data.map(s => s.area)));
        const areaProms = areaLabels.map(a => {
          const arr = data.filter(s => s.area === a).map(s => s.promActual);
          const nums = arr.filter(v => typeof v === 'number');
          return nums.length ? Number((nums.reduce((s,v)=>s+v,0)/nums.length).toFixed(2)) : 0;
        });

        return { estados, estadoCounts: estados.map(e => estadoCounts[e]), areaLabels, areaProms };
      }, [rowsArea]);

      useEffect(() => {
        if (!chartData) return;
        const { estados, estadoCounts, areaLabels, areaProms } = chartData;

        const mk = (key, ref, cfg) => {
          if (!ref.current) return;
          charts.current[key]?.destroy();
          charts.current[key] = new window.Chart(ref.current, cfg);
        };

        mk('bar', barRef, {
          type: 'bar',
          data: {
            labels: estados,
            datasets: [{ 
              label: 'Distribuci√≥n de Estados', 
              data: estadoCounts, 
              backgroundColor: ['#ef4444','#fbbf24','#3b82f6','#06b6d4','#22c55e'],
              borderColor: ['#dc2626','#f59e0b','#2563eb','#0891b2','#16a34a'],
              borderWidth: 1,
              borderRadius: 4 // [MODERN] Esquinas redondeadas
            }]
          },
          options: { 
            responsive: true, 
            plugins: { 
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return `${context.label}: ${context.parsed.y} estudiantes`;
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  color: document.documentElement.classList.contains('dark') ? '#374151' : '#e5e7eb'
                },
                ticks: {
                  color: document.documentElement.classList.contains('dark') ? '#d1d5db' : '#374151'
                }
              },
              x: {
                grid: {
                  display: false
                },
                ticks: {
                  color: document.documentElement.classList.contains('dark') ? '#d1d5db' : '#374151'
                }
              }
            }
          }
        });

        mk('pie', pieRef, {
          type: 'doughnut', // [UPGRADE] Cambiado a doughnut para look m√°s moderno
          data: {
            labels: estados,
            datasets: [{ 
              label: 'Estados', 
              data: estadoCounts, 
              backgroundColor: ['#ef4444','#fbbf24','#3b82f6','#06b6d4','#22c55e'],
              borderWidth: 2,
              borderColor: '#ffffff', // Borde blanco entre segmentos
              hoverBorderWidth: 3
            }]
          },
          options: { 
            responsive: true,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  padding: 15,
                  usePointStyle: true,
                  font: { size: 11 }
                }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.parsed || 0;
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = ((value / total) * 100).toFixed(1);
                    return `${label}: ${value} estudiantes (${percentage}%)`;
                  }
                }
              }
            },
            cutout: '60%' // [DONUT] Agujero en el centro
          }
        });

        mk('radar', radarRef, {
          type: 'radar',
          data: {
            labels: areaLabels,
            datasets: [{ 
              label: 'Promedio por √Årea', 
              data: areaProms, 
              backgroundColor: 'rgba(59,130,246,0.2)', 
              borderColor: '#3b82f6',
              borderWidth: 2,
              pointBackgroundColor: '#3b82f6',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2,
              pointRadius: 5,
              pointHoverRadius: 7
            }]
          },
          options: { 
            responsive: true,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  color: document.documentElement.classList.contains('dark') ? '#d1d5db' : '#374151'
                }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return `${context.label}: ${context.parsed.r.toFixed(2)} promedio`;
                  }
                }
              }
            },
            scales: {
              r: {
                beginAtZero: true,
                max: 5,
                grid: {
                  color: document.documentElement.classList.contains('dark') ? '#374151' : '#e5e7eb'
                },
                angleLines: {
                  color: document.documentElement.classList.contains('dark') ? '#374151' : '#e5e7eb'
                },
                ticks: {
                  color: document.documentElement.classList.contains('dark') ? '#9ca3af' : '#6b7280',
                  backdropColor: 'transparent'
                },
                pointLabels: {
                  color: document.documentElement.classList.contains('dark') ? '#d1d5db' : '#374151',
                  font: { size: 10 }
                }
              }
            }
          }
        });

        return () => {
          Object.values(charts.current).forEach(c => c?.destroy());
          charts.current = {};
        };
      }, [chartData]);

      const { estados, estadoCounts, areaLabels, areaProms } = chartData || { estados: [], estadoCounts: [], areaLabels: [], areaProms: [] };

      useEffect(() => {
        console.timeEnd('render:DashboardCharts');
      });

      return (
        <div className="grid grid-cols-1 md:grid-cols-3 gap-8 p-4">
          <div className="bg-white dark:bg-gray-800 rounded-lg p-4 shadow transition-colors">
            <h3 className="font-semibold mb-2 text-center text-gray-900 dark:text-white">Distribuci√≥n de Estados</h3>
            <p className="text-xs text-gray-500 dark:text-gray-400 text-center mb-2">Cantidad de estudiantes por estado acad√©mico (√°rea principal).</p>
            <canvas ref={barRef} height="180" aria-label="Distribuci√≥n de estados (barras)" role="img"></canvas>
            <button
              className="mt-2 px-3 py-1.5 rounded-md border border-gray-300 dark:border-gray-600 text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors"
              onClick={() => downloadCanvasPNG(
                barRef.current,
                `grafico_distribucion_estados_${new Date().toISOString().slice(0,10)}.png`
              )}
            >
              Exportar PNG
            </button>
            <table className="mt-2 text-xs w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800">
              <caption className="sr-only">Distribuci√≥n de estudiantes por estado acad√©mico</caption>
              <thead>
                <tr className="bg-gray-100 dark:bg-gray-700">
                  <th scope="col" className="border border-gray-300 dark:border-gray-600 px-1 text-gray-900 dark:text-white">Estado</th>
                  <th scope="col" className="border border-gray-300 dark:border-gray-600 px-1 text-gray-900 dark:text-white">Cantidad</th>
                </tr>
              </thead>
              <tbody>
                {estados.map((e, i) => (
                  <tr key={e} className="bg-white dark:bg-gray-800">
                    <td className="border border-gray-300 dark:border-gray-600 px-1 text-gray-900 dark:text-white">{e}</td>
                    <td className="border border-gray-300 dark:border-gray-600 px-1 text-gray-900 dark:text-white">{estadoCounts[i]}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          <div className="bg-white dark:bg-gray-800 rounded-lg p-4 shadow transition-colors">
            <h3 className="font-semibold mb-2 text-center text-gray-900 dark:text-white">Estados (Donut)</h3>
            <p className="text-xs text-gray-500 dark:text-gray-400 text-center mb-2">Proporci√≥n de estudiantes por estado acad√©mico.</p>
            <canvas ref={pieRef} height="180" aria-label="Distribuci√≥n de estados (pastel)" role="img"></canvas>
            <button
              className="mt-2 px-3 py-1.5 rounded-md border border-gray-300 dark:border-gray-600 text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors"
              onClick={() => downloadCanvasPNG(
                pieRef.current,
                `grafico_estados_donut_${new Date().toISOString().slice(0,10)}.png`
              )}
            >
              Exportar PNG
            </button>
            <table className="mt-2 text-xs w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800">
              <caption className="sr-only">Proporci√≥n de estudiantes por estado acad√©mico</caption>
              <thead>
                <tr className="bg-gray-100 dark:bg-gray-700">
                  <th scope="col" className="border border-gray-300 dark:border-gray-600 px-1 text-gray-900 dark:text-white">Estado</th>
                  <th scope="col" className="border border-gray-300 dark:border-gray-600 px-1 text-gray-900 dark:text-white">Cantidad</th>
                </tr>
              </thead>
              <tbody>
                {estados.map((e, i) => (
                  <tr key={e} className="bg-white dark:bg-gray-800">
                    <td className="border border-gray-300 dark:border-gray-600 px-1 text-gray-900 dark:text-white">{e}</td>
                    <td className="border border-gray-300 dark:border-gray-600 px-1 text-gray-900 dark:text-white">{estadoCounts[i]}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          <div className="bg-white dark:bg-gray-800 rounded-lg p-4 shadow transition-colors">
            <h3 className="font-semibold mb-2 text-center text-gray-900 dark:text-white">Promedio por √Årea (Radar)</h3>
            <p className="text-xs text-gray-500 dark:text-gray-400 text-center mb-2">Promedio general de notas por √°rea acad√©mica.</p>
            <canvas ref={radarRef} height="180" aria-label="Promedio por √°rea (radar)" role="img"></canvas>
            <button
              className="mt-2 px-3 py-1.5 rounded-md border border-gray-300 dark:border-gray-600 text-sm bg-white dark:bg-gray-700 text-gray-900 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors"
              onClick={() => downloadCanvasPNG(
                radarRef.current,
                `grafico_promedio_area_${new Date().toISOString().slice(0,10)}.png`
              )}
            >
              Exportar PNG
            </button>
            <table className="mt-2 text-xs w-full border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800">
              <caption className="sr-only">Promedio general de notas por √°rea acad√©mica</caption>
              <thead>
                <tr className="bg-gray-100 dark:bg-gray-700">
                  <th scope="col" className="border border-gray-300 dark:border-gray-600 px-1 text-gray-900 dark:text-white">√Årea</th>
                  <th scope="col" className="border border-gray-300 dark:border-gray-600 px-1 text-gray-900 dark:text-white">Promedio</th>
                </tr>
              </thead>
              <tbody>
                {(areaLabels || []).map((a, i) => (
                  <tr key={a}>
                    <td className="border border-gray-300 dark:border-gray-600 px-1 text-gray-900 dark:text-white">{a}</td>
                    <td className="border border-gray-300 dark:border-gray-600 px-1 text-gray-900 dark:text-white">{areaProms[i]}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );
    }, (prevProps, nextProps) => {
      // [Performance] Comparaci√≥n granular para evitar re-renders innecesarios
      return (
        Array.isArray(prevProps.rowsArea) && Array.isArray(nextProps.rowsArea) &&
        Array.isArray(prevProps.rowsAsignatura) && Array.isArray(nextProps.rowsAsignatura) &&
        prevProps.rowsArea.length === nextProps.rowsArea.length &&
        prevProps.rowsAsignatura.length === nextProps.rowsAsignatura.length &&
        // Comparaci√≥n superficial de primeros elementos para detectar cambios estructurales
        (prevProps.rowsArea.length === 0 || JSON.stringify(prevProps.rowsArea[0]) === JSON.stringify(nextProps.rowsArea[0])) &&
        (prevProps.rowsAsignatura.length === 0 || JSON.stringify(prevProps.rowsAsignatura[0]) === JSON.stringify(nextProps.rowsAsignatura[0]))
      );
    });

    // =============================
    // Tabs para navegaci√≥n (An√°lisis / Gr√°ficos) con A11y
    // =============================
        // [A11yTabs] manejo de teclas ‚Üê ‚Üí Home End
    function onTabListKeyDown(e) {
      const LEFT = 'ArrowLeft', RIGHT = 'ArrowRight', HOME = 'Home', END = 'End';
      const list = e.currentTarget;
      const tabs = Array.from(list.querySelectorAll('[role="tab"]')).filter(el => !el.hasAttribute('disabled'));
      const current = document.activeElement;
      const idx = tabs.indexOf(current);
      if (idx === -1) return;

      let nextIdx = idx;
      if (e.key === LEFT) nextIdx = (idx - 1 + tabs.length) % tabs.length;
      else if (e.key === RIGHT) nextIdx = (idx + 1) % tabs.length;
      else if (e.key === HOME) nextIdx = 0;
      else if (e.key === END) nextIdx = tabs.length - 1;
      else return;

      e.preventDefault();
      tabs[nextIdx].focus();
      tabs[nextIdx].click(); // asegura selecci√≥n al navegar
    }

    function DashboardTabs({ dashboardData, onReset, fileName, derived, setDerived, syncChartsWithFilters, setSyncChartsWithFilters }) {
      console.debug('[Tabs] received derived', { has: !!derived, rowsArea: Array.isArray(derived?.rowsArea) ? derived.rowsArea.length : 'NA' });
      // [TabsPersist] estado de pesta√±a con persistencia
      const [tab, setTab] = React.useState(() => localStorage.getItem('ui_tab') || 'analisis');

      // [TabsPersist] guardar pesta√±a al cambiar
      React.useEffect(() => {
        try { localStorage.setItem('ui_tab', tab); } catch(_) {}
      }, [tab]);

      // [FiltersPersist] LIFTED STATE from DashboardView, inicializaci√≥n desde localStorage
      const [courseFilterDV, setCourseFilterDV] = React.useState(() => localStorage.getItem('flt_curso') || 'ALL');
      const [studentFilter, setStudentFilter] = React.useState(() => localStorage.getItem('flt_student') || '');
      const [areaFilter, setAreaFilter] = React.useState(() => localStorage.getItem('flt_area') || '');
      const [asigFilter, setAsigFilter] = React.useState(() => localStorage.getItem('flt_asig') || '');
      const [estadoFilter, setEstadoFilter] = React.useState(() => localStorage.getItem('flt_estado') || '');

      // [FiltersPersist] escritura en localStorage
      React.useEffect(() => { localStorage.setItem('flt_curso', courseFilterDV || 'ALL'); }, [courseFilterDV]);
      React.useEffect(() => { localStorage.setItem('flt_student', studentFilter || ''); }, [studentFilter]);
      React.useEffect(() => { localStorage.setItem('flt_area', areaFilter || ''); }, [areaFilter]);
      React.useEffect(() => { localStorage.setItem('flt_asig', asigFilter || ''); }, [asigFilter]);
      React.useEffect(() => { localStorage.setItem('flt_estado', estadoFilter || ''); }, [estadoFilter]);

      const dataForAnalysis = useMemo(() => {
        if (!Array.isArray(dashboardData)) return [];
        if (courseFilterDV === 'ALL') return dashboardData;
        return dashboardData.filter(s => (s?.CURSO || '') === courseFilterDV);
      }, [dashboardData, courseFilterDV]);

      const rowsAreaSource = useMemo(() => {
        if (derived && Array.isArray(derived.rowsArea)) {
          return derived.rowsArea;
        }
        // Fallback
        if (!Array.isArray(dataForAnalysis)) return [];
        const fallbackRows = [];
        dataForAnalysis.forEach(st => {
          Object.entries(st.areas).forEach(([areaName, areaData]) => {
            fallbackRows.push({
              id: `${st.id}-${areaName}`, CURSO: st.CURSO, estudiante: st.name, area: areaName,
              defP1: areaData.DEF?.P1, defP2: areaData.DEF?.P2, defP3: areaData.DEF?.P3,
              promActual: areaData.areaStats?.promedioActual, p4Min: areaData.areaStats?.p4Min, estado: areaData.areaStats?.estado
            });
          });
        });
        return fallbackRows;
      }, [dataForAnalysis, derived?.rowsArea]);

      const rowsAsigSource = useMemo(() => {
        if (derived && Array.isArray(derived.rowsAsignatura)) {
          return derived.rowsAsignatura;
        }
        // Fallback
        if (!Array.isArray(dataForAnalysis)) return [];
        const fallbackRows = [];
        dataForAnalysis.forEach(st => {
          Object.entries(st.areas).forEach(([areaName, areaData]) => {
            Object.entries(areaData.asignaturas).forEach(([asigName, asigData]) => {
              fallbackRows.push({
                id: `${st.id}-${areaName}-${asigName}`, CURSO: st.CURSO, estudiante: st.name, area: areaName, asignatura: asigName,
                p1: asigData.P1, p2: asigData.P2, p3: asigData.P3,
                promActual: asigData.promedioActual, p4Min: asigData.p4Min, estado: asigData.estado
              });
            });
          });
        });
        return fallbackRows;
      }, [dataForAnalysis, derived?.rowsAsignatura]);

      const rowsAreaByCourse = useMemo(() => {
        if (courseFilterDV === 'ALL') return rowsAreaSource;
        return rowsAreaSource.filter(r => (r.CURSO || '') === courseFilterDV);
      }, [rowsAreaSource, courseFilterDV]);

      const filteredRowsArea = useMemo(() => {
        if (!rowsAreaByCourse) return [];
        const nStudent = normTxt(studentFilter);
        const nArea = normTxt(areaFilter);
        const nEstado = normTxt(estadoFilter);
        return rowsAreaByCourse.filter(row => {
            const matchStudent = !studentFilter || (row.EST_NORM ?? normTxt(row.estudiante)).includes(nStudent);
            const matchArea = !areaFilter || (row.AREA_NORM ?? normTxt(row.area)).includes(nArea) || row.area === areaFilter;
            const matchEstado = !estadoFilter || (row.estado?.text && normTxt(row.estado.text).includes(nEstado));
            return matchStudent && matchArea && matchEstado;
        });
      }, [rowsAreaByCourse, studentFilter, areaFilter, estadoFilter]);

      const rowsAsigByCourse = useMemo(() => {
        if (courseFilterDV === 'ALL') return rowsAsigSource;
        return rowsAsigSource.filter(r => (r.CURSO || '') === courseFilterDV);
      }, [rowsAsigSource, courseFilterDV]);

      const filteredRowsAsignatura = useMemo(() => {
        if (!rowsAsigByCourse) return [];
        const nStudent = normTxt(studentFilter);
        const nArea = normTxt(areaFilter);
        const nAsig = normTxt(asigFilter);
        const nEstado = normTxt(estadoFilter);
        return rowsAsigByCourse.filter(row => {
          const matchStudent = !studentFilter || (row.EST_NORM ?? normTxt(row.estudiante)).includes(nStudent);
          const matchArea = !areaFilter || (row.AREA_NORM ?? normTxt(row.area)).includes(nArea) || row.area === areaFilter;
          const matchAsig = !asigFilter || (row.ASIG_NORM ?? normTxt(row.asignatura)).includes(nAsig) || row.asignatura === asigFilter;
          const matchEstado = !estadoFilter || (row.estado?.text && normTxt(row.estado.text).includes(nEstado));
          return matchStudent && matchArea && matchAsig && matchEstado;
        });
      }, [rowsAsigByCourse, studentFilter, areaFilter, asigFilter, estadoFilter]);

      // [ChartsSync] fuentes de datos para gr√°ficos
      const chartRowsArea = syncChartsWithFilters ? filteredRowsArea : rowsAreaSource;
      const chartRowsAsig = syncChartsWithFilters ? filteredRowsAsignatura : rowsAsigSource;

      return (
        <div className="w-full">
          <div role="tablist" aria-label="Secciones del Dashboard" onKeyDown={onTabListKeyDown} className="flex gap-2 mb-4">
            <button
              role="tab"
              id="tab-analisis"
              aria-controls="panel-analisis"
              aria-selected={tab === 'analisis'}
              tabIndex={tab === 'analisis' ? 0 : -1}
              className={tab === 'analisis'
                ? 'px-4 py-2 rounded-t-lg font-semibold bg-white shadow'
                : 'px-4 py-2 rounded-t-lg font-semibold bg-gray-200'}
              onClick={() => setTab('analisis')}
            >
              An√°lisis
            </button>

            <button
              role="tab"
              id="tab-graficos"
              aria-controls="panel-graficos"
              aria-selected={tab === 'graficos'}
              tabIndex={tab === 'graficos' ? 0 : -1}
              className={tab === 'graficos'
                ? 'px-4 py-2 rounded-t-lg font-semibold bg-white shadow'
                : 'px-4 py-2 rounded-t-lg font-semibold bg-gray-200'}
              onClick={() => setTab('graficos')}
            >
              Gr√°ficos
            </button>

            <button
              role="tab"
              id="tab-consultas"
              aria-controls="panel-consultas"
              aria-selected={tab === 'consultas'}
              tabIndex={tab === 'consultas' ? 0 : -1}
              className={tab === 'consultas'
                ? 'px-4 py-2 rounded-t-lg font-semibold bg-white shadow'
                : 'px-4 py-2 rounded-t-lg font-semibold bg-gray-200'}
              onClick={() => setTab('consultas')}
            >
              Consultas/Reportes R√°pidos
            </button>

            <button
              role="tab"
              id="tab-informes"
              aria-controls="panel-informes"
              aria-selected={tab === 'informes'}
              tabIndex={tab === 'informes' ? 0 : -1}
              className={tab === 'informes'
                ? 'px-4 py-2 rounded-t-lg font-semibold bg-white shadow'
                : 'px-4 py-2 rounded-t-lg font-semibold bg-gray-200'}
              onClick={() => setTab('informes')}
            >
              üìä Informes por Periodos
            </button>
          </div>

          <div className="bg-white rounded-lg shadow p-4">
            {tab === 'analisis' && (
                            <div role="tabpanel" id="panel-analisis" aria-labelledby="tab-analisis">
                              <div className="flex justify-end mb-2 gap-2">
                                  {/* [FiltersReset] bot√≥n para limpiar filtros */}
                                  <button
                                    className="px-3 py-1.5 rounded-md border border-gray-300 text-sm"
                                    onClick={() => {
                                      setCourseFilterDV('ALL');
                                      setStudentFilter('');
                                      setAreaFilter('');
                                      setAsigFilter('');
                                      setEstadoFilter('');
                                    }}
                                  >
                                    Limpiar filtros
                                  </button>
                                  {/* [BackupJSON] bot√≥n Exportar backup (.json) */}
                                  <button
                                    className="px-3 py-1.5 rounded-md border border-gray-300 text-sm"
                                    onClick={() => downloadJSON(
                                      `dashboard_backup_${new Date().toISOString().slice(0,10)}.json`,
                                      {
                                        dashboardData: dashboardData,
                                        rowsArea: filteredRowsArea,
                                        rowsAsignatura: filteredRowsAsignatura,
                                        filtroCurso: courseFilterDV,
                                        filtroEstudiante: studentFilter,
                                        filtroArea: areaFilter,
                                        filtroAsignatura: asigFilter,
                                        filtroEstado: estadoFilter,
                                        syncChartsWithFilters: syncChartsWithFilters
                                      }
                                    )}
                                  >
                                    Exportar backup (.json)
                                  </button>
                                  {/* [RestoreJSON] bot√≥n para restaurar desde backup */}
                                  <button
                                    className="px-3 py-1.5 rounded-md border border-gray-300 text-sm"
                                    onClick={() => restoreFromJSONFile((data) => {
                                      setDerived(prev => ({
                                        ...prev,
                                        rowsArea: data.rowsArea || prev?.rowsArea || [],
                                        rowsAsignatura: data.rowsAsignatura || prev?.rowsAsignatura || [],
                                      }));
                                      if ('filtroCurso' in data) setCourseFilterDV(data.filtroCurso || 'ALL');
                                      if ('filtroArea' in data) setAreaFilter(data.filtroArea || '');
                                      if ('filtroAsignatura' in data) setAsigFilter(data.filtroAsignatura || '');
                                      if ('filtroEstudiante' in data) setStudentFilter(data.filtroEstudiante || '');
                                      if ('filtroEstado' in data) setEstadoFilter(data.filtroEstado || '');
                                      if ('syncChartsWithFilters' in data) setSyncChartsWithFilters(!!data.syncChartsWithFilters);
                                    })}
                                  >
                                    Restaurar backup (.json)
                                  </button>
                              </div>
                               <DashboardView                  data={dataForAnalysis}
                  onReset={onReset}
                  fileName={fileName}
                  derived={derived}
                  // Pass down lifted state and setters
                  filters={{ courseFilterDV, studentFilter, areaFilter, asigFilter, estadoFilter }}
                  setFilters={{ setCourseFilterDV, setStudentFilter, setAreaFilter, setAsigFilter, setEstadoFilter }}
                  // Pass down calculated rows
                  filteredRowsArea={filteredRowsArea}
                  filteredRowsAsignatura={filteredRowsAsignatura}
                />
              </div>
            )}
            {tab === 'graficos' && (
              <div role="tabpanel" id="panel-graficos" aria-labelledby="tab-graficos">
                {/* [ChartsSync] toggle en UI de Gr√°ficos */}
                <div className="flex justify-end mb-4">
                  <label className="inline-flex items-center gap-2 text-sm">
                    <input type="checkbox"
                          className="rounded"
                          checked={syncChartsWithFilters}
                          onChange={e => setSyncChartsWithFilters(e.target.checked)} />
                    Sincronizar con filtros de An√°lisis
                  </label>
                </div>
                <p className="mt-2 text-xs text-gray-600 text-right max-w-md ml-auto">
                  Cuando est√° desactivado, los gr√°ficos muestran el panorama general del conjunto de datos cargado.
                  Al activarlo, los gr√°ficos se sincronizan con los mismos filtros aplicados en las tablas de An√°lisis.
                </p>
                <DashboardCharts
                  rowsArea={chartRowsArea}
                  rowsAsignatura={chartRowsAsig}
                />
              </div>
            )}
            {tab === 'consultas' && (
              <div role="tabpanel" id="panel-consultas" aria-labelledby="tab-consultas">
                <QuickReportsView data={dashboardData} />
              </div>
            )}
            {tab === 'informes' && (
              <div role="tabpanel" id="panel-informes" aria-labelledby="tab-informes">
                <InformesView 
                  dashboardData={dashboardData} 
                  derived={derived} 
                  filters={{ courseFilterDV, studentFilter, areaFilter, asigFilter, estadoFilter }}
                />
              </div>
            )}
          </div>
        </div>
      );
    }
    // =============================
    // Componente Consultas/Reportes R√°pidos - Optimizado con React.memo
    // =============================
    const QuickReportsView = React.memo(({ data }) => {
      console.time('render:QuickReportsView');
      const [courseFilter, setCourseFilter] = useState('ALL');

      const courseOptions = useMemo(() => {
        if (!Array.isArray(data)) return ['ALL'];
        // [Fix-CURSO] conjunto de cursos consistente
        const getCurso = (r) => r.CURSO ?? r.curso;
        const set = new Set(data.map(getCurso).filter(Boolean));
        return ['ALL', ...Array.from(set)];
      }, [data]);

      const filteredData = useMemo(() => {
        if (!Array.isArray(data)) return [];
        if (courseFilter === 'ALL') return data;
        return data.filter(s => (s.CURSO ?? s.curso) === courseFilter);
      }, [data, courseFilter]);

      const areaLabels = useMemo(() => Array.from(new Set(filteredData.flatMap(s => Object.keys(s.areas)))), [filteredData]);

      const lowAverages = useMemo(() => areaLabels.map(area => {
        const students = filteredData.map(s => ({
          name: s.name,
          prom: s.areas[area]?.areaStats?.promedioActual ?? null
        })).filter(s => typeof s.prom === 'number' && s.prom < 3.0);
        students.sort((a,b) => a.prom-b.prom);
        return { area, students };
      }).filter(a => a.students.length > 0), [filteredData, areaLabels]);

      const topLost = useMemo(() => {
        const lostAreas = filteredData.map(s => ({
          name: s.name,
          perdidas: Object.values(s.areas).filter(a => a.areaStats?.estado?.text==='Perdido').length
        }));
        lostAreas.sort((a,b)=>b.perdidas-a.perdidas);
        return lostAreas.filter(s=>s.perdidas>0);
      }, [filteredData]);

      const topRisk = useMemo(() => {
        const riskAreas = filteredData.map(s => ({
          name: s.name,
          riesgo: Object.values(s.areas).filter(a => a.areaStats?.estado?.text==='En riesgo').length
        }));
        riskAreas.sort((a,b)=>b.riesgo-a.riesgo);
        return riskAreas.filter(s=>s.riesgo>0);
      }, [filteredData]);

      const topRecup = useMemo(() => {
        const recupAreas = filteredData.map(s => ({
          name: s.name,
          recup: Object.values(s.areas).filter(a => a.areaStats?.estado?.text==='Recuperable').length
        }));
        recupAreas.sort((a,b)=>b.recup-a.recup);
        return recupAreas.filter(s=>s.recup>0);
      }, [filteredData]);

      const areaRisk = useMemo(() => areaLabels.map(area => {
        const riesgo = filteredData.filter(s => s.areas[area]?.areaStats?.estado?.text==='En riesgo').length;
        return { area, riesgo };
      }).filter(a=>a.riesgo>0).sort((a,b)=>b.riesgo-a.riesgo), [filteredData, areaLabels]);

      const { topGlobal, worstGlobal } = useMemo(() => {
        const globalProms = filteredData.map(s => {
          const proms = Object.values(s.areas).map(a => a.areaStats?.promedioActual).filter(v=>typeof v==='number');
          const prom = proms.length ? proms.reduce((a,b)=>a+b,0)/proms.length : null;
          return { name: s.name, prom };
        }).filter(s=>typeof s.prom==='number');
        globalProms.sort((a,b)=>b.prom-a.prom);
        const topGlobal = globalProms.slice(0, 10);
        const worstGlobal = globalProms.filter(s=>s.prom < 3.0).sort((a,b)=>a.prom-b.prom);
        return { topGlobal, worstGlobal };
      }, [filteredData]);

      useEffect(() => {
        console.timeEnd('render:QuickReportsView');
      });

      return (
        <div className="space-y-8">
          <h2 className="text-xl font-bold mb-4 text-blue-700">Consultas y Reportes R√°pidos</h2>
          <div className="flex items-center gap-2 mb-4">
            <label className="text-sm font-medium">Curso:</label>
            <select
              className="border rounded px-2 py-1 text-sm"
              value={courseFilter}
              onChange={(e) => setCourseFilter(e.target.value)}
            >
              {courseOptions.map(opt => (
                <option key={opt} value={opt}>{opt === 'ALL' ? 'Todos' : opt}</option>
              ))}
            </select>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div className="bg-white border rounded-xl p-4 shadow">
              <h3 className="font-semibold mb-2 text-blue-600">Promedios m√°s bajos por √Årea</h3>
              <div className="max-h-64 overflow-auto pr-2">
                {lowAverages.map(a=>(
                  <div key={a.area} className="mb-3">
                    <div className="font-bold text-sm mb-1">{a.area}</div>
                    <ul className="text-xs">
                      {a.students.map(s=>(<li key={s.name}>{s.name}: <span className="font-semibold text-red-600">{s.prom.toFixed(2)}</span></li>))}
                    </ul>
                  </div>
                ))}
              </div>
            </div>
            <div className="bg-white border rounded-xl p-4 shadow">
              <h3 className="font-semibold mb-2 text-red-600">Estudiantes con m√°s √Åreas Perdidas</h3>
              <div className="max-h-64 overflow-auto pr-2">
                <ul className="text-xs">
                  {topLost.map(s=>(<li key={s.name}>{s.name}: <span className="font-semibold text-red-600">{s.perdidas}</span> √°reas</li>))}
                </ul>
              </div>
            </div>
            <div className="bg-white border rounded-xl p-4 shadow">
              <h3 className="font-semibold mb-2 text-yellow-600">Estudiantes con m√°s √Åreas en Riesgo</h3>
              <div className="max-h-64 overflow-auto pr-2">
                <ul className="text-xs">
                  {topRisk.map(s=>(<li key={s.name}>{s.name}: <span className="font-semibold text-yellow-600">{s.riesgo}</span> √°reas</li>))}
                </ul>
              </div>
            </div>
            <div className="bg-white border rounded-xl p-4 shadow">
              <h3 className="font-semibold mb-2 text-blue-600">Estudiantes con m√°s √Åreas Recuperables</h3>
              <div className="max-h-64 overflow-auto pr-2">
                <ul className="text-xs">
                  {topRecup.map(s=>(<li key={s.name}>{s.name}: <span className="font-semibold text-blue-600">{s.recup}</span> √°reas</li>))}
                </ul>
              </div>
            </div>
            <div className="bg-white border rounded-xl p-4 shadow">
              <h3 className="font-semibold mb-2 text-yellow-700">√Åreas con m√°s estudiantes en riesgo</h3>
              <div className="max-h-64 overflow-auto pr-2">
                <ul className="text-xs">
                  {areaRisk.map(a=>(<li key={a.area}>{a.area}: <span className="font-semibold text-yellow-700">{a.riesgo}</span> estudiantes</li>))}
                </ul>
              </div>
            </div>
            <div className="bg-white border rounded-xl p-4 shadow">
              <h3 className="font-semibold mb-2 text-green-700">Top estudiantes con mejor desempe√±o global</h3>
              <div className="max-h-64 overflow-auto pr-2">
                <ul className="text-xs">
                  {topGlobal.map(s=>(<li key={s.name}>{s.name}: <span className="font-semibold text-green-700">{s.prom.toFixed(2)}</span></li>))}
                </ul>
              </div>
            </div>
            <div className="bg-white border rounded-xl p-4 shadow">
              <h3 className="font-semibold mb-2 text-red-700">Top estudiantes con peor desempe√±o global</h3>
              <div className="max-h-64 overflow-auto pr-2">
                <ul className="text-xs">
                  {worstGlobal.map(s=>(<li key={s.name}>{s.name}: <span className="font-semibold text-red-700">{s.prom.toFixed(2)}</span></li>))}
                </ul>
              </div>
            </div>
          </div>
        </div>
      );
    }, (prevProps, nextProps) => {
      // [Performance] Solo re-renderizar si cambia la data
      return (
        Array.isArray(prevProps.data) && Array.isArray(nextProps.data) &&
        prevProps.data.length === nextProps.data.length &&
        // Comparaci√≥n r√°pida de hash para detectar cambios de contenido
        (prevProps.data.length === 0 || 
         prevProps.data[0]?.id === nextProps.data[0]?.id &&
         prevProps.data[0]?.name === nextProps.data[0]?.name)
      );
    });
    // ...resto del c√≥digo React...

    // =============================
    // Componentes Optimizados para Tablas
    // =============================
    // [Performance] Row components memoizados para evitar re-renders innecesarios
    const AsignaturaTableRow = React.memo(({ row, showCourseCol, getRowClass }) => (
  <tr key={`${row.CURSO || 'SINGLE'}-${row.id}`} className={`hover:bg-gray-100 dark:hover:bg-gray-800 dark:text-gray-100 ${getRowClass(row.estado)}`}>
        {showCourseCol && <td className="px-3 py-3 text-sm text-gray-600">{row.CURSO || ''}</td>}
        <td className="px-3 py-3 font-medium text-gray-900 align-top border-r" style={{minWidth:'120px',maxWidth:'200px'}}>{row.estudiante}</td>
        <td className="px-3 py-3 text-sm font-medium text-gray-700">{row.area}</td>
        <td className="px-3 py-3 text-sm text-gray-600">{row.asignatura}</td>
        <td className="px-3 py-3 text-sm text-right">{formatNota(row.p1)}</td>
        <td className="px-3 py-3 text-sm text-right">{formatNota(row.p2)}</td>
        <td className="px-3 py-3 text-sm text-right">{formatNota(row.p3)}</td>
        <td className="px-3 py-3 text-sm text-right font-semibold">{formatNota(row.promActual)}</td>
        <td className="px-3 py-3 text-sm text-right font-semibold">{formatNota(row.p4Min)}</td>
        <td className="px-3 py-3 text-sm text-center"><StatusBadge status={row.estado} /></td>
      </tr>
    ), (prevProps, nextProps) => {
      // Comparaci√≥n optimizada: solo re-renderizar si cambi√≥ la fila espec√≠fica
      return (
        prevProps.row.id === nextProps.row.id &&
        prevProps.row.promActual === nextProps.row.promActual &&
        prevProps.row.estado?.text === nextProps.row.estado?.text &&
        prevProps.showCourseCol === nextProps.showCourseCol
      );
    });

    const AreaTableRow = React.memo(({ row, showCourseCol, getRowClass }) => (
  <tr key={`${row.CURSO || 'SINGLE'}-${row.id}`} className={`hover:bg-gray-100 dark:hover:bg-gray-800 dark:text-gray-100 ${getRowClass(row.estado)}`}>
        {showCourseCol && <td className="px-3 py-3 text-sm text-gray-600">{row.CURSO || ''}</td>}
        <td className="px-3 py-3 font-medium text-gray-900 align-top border-r" style={{minWidth:'120px',maxWidth:'200px'}}>{row.estudiante}</td>
        <td className="px-3 py-3 text-sm font-medium text-gray-700">{row.area}</td>
        <td className="px-3 py-3 text-sm text-right">{formatNota(row.defP1)}</td>
        <td className="px-3 py-3 text-sm text-right">{formatNota(row.defP2)}</td>
        <td className="px-3 py-3 text-sm text-right">{formatNota(row.defP3)}</td>
        <td className="px-3 py-3 text-sm text-right font-semibold">{formatNota(row.promActual)}</td>
        <td className="px-3 py-3 text-sm text-right font-semibold">{formatNota(row.p4Min)}</td>
        <td className="px-3 py-3 text-sm text-center"><StatusBadge status={row.estado} /></td>
      </tr>
    ), (prevProps, nextProps) => {
      // Comparaci√≥n optimizada para filas de √°rea
      return (
        prevProps.row.id === nextProps.row.id &&
        prevProps.row.promActual === nextProps.row.promActual &&
        prevProps.row.estado?.text === nextProps.row.estado?.text &&
        prevProps.showCourseCol === nextProps.showCourseCol
      );
    });
  </script>
  <!-- SheetJS/XLSX 0.18.5 (build completo) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" crossorigin="anonymous"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, "Noto Sans", 'Apple Color Emoji', 'Segoe UI Emoji'; }
    .highlight-unitary { background-color: #f0f9ff; border-left: 3px solid #3b82f6; }
    #dev-badge {
      position: fixed;
      top: 8px;
      right: 8px;
      z-index: 9999;
      padding: 4px 8px;
      border-radius: 8px;
      background: #111827;
      color: #F9FAFB;
      font: 12px/1 system-ui,Segoe UI,Roboto;
      box-shadow: 0 2px 8px rgba(0,0,0,.25);
      display: none;
    }
    #res-guard-banner {
      position: fixed;
      bottom: 8px;
      left: 8px;
      right: 8px;
      z-index: 9999;
      padding: 10px;
      border-radius: 8px;
      background: #111827;
      color: #F9FAFB;
      font: 14px/1.4 system-ui,Segoe UI,Roboto;
      box-shadow: 0 4px 16px rgba(0,0,0,.2);
    }
    #res-guard-banner button {
      margin-left: 8px;
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid #374151;
      background: #1F2937;
      color: #F3F4F6;
      cursor: pointer;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
<!-- [DevBadge] insertar tras <body> o antes del root -->
<div id="dev-badge">DEV</div>

<script>
// [DevBadge] mostrar solo en desarrollo
(function(){
  try {
    var isDevMode = (document.documentElement?.dataset?.mode || '').toLowerCase() === 'dev';
    var dashDev = !!window.__DASH_DEV__;
    var el = document.getElementById('dev-badge');
    if (!el) return;
    if (isDevMode || dashDev) { el.style.display = 'inline-block'; }
    // actualizar si el usuario activa __DASH_DEV__ en runtime
    Object.defineProperty(window, '__DASH_DEV__', {
      set(v){ this.__dash_dev_flag=v; el.style.display = (v || isDevMode) ? 'inline-block' : 'none'; },
      get(){ return this.__dash_dev_flag === true; }
    });
  } catch(_) {}
})();
</script>
  <header class="w-full bg-gradient-to-r from-blue-900 via-yellow-400 to-green-700 shadow-lg py-3 px-4 flex items-center justify-between">
    <div class="flex items-center gap-4">
  <img src="escudo-el-carmen.jpg" alt="Escudo IE El Carmen" class="rounded-full border-2 border-white shadow-md bg-white object-cover w-12 h-12" />
      <div>
        <h1 class="text-2xl md:text-3xl font-bold text-white drop-shadow">IE EL CARMEN</h1>
        <span class="text-xs md:text-sm text-white/80 font-semibold">Dashboard Institucional</span>
      </div>
    </div>
    
    <!-- [THEME TOGGLE] Bot√≥n de cambio de tema -->
    <div class="flex items-center gap-3">
      <button 
        id="theme-toggle" 
        class="p-2 rounded-lg bg-white/10 hover:bg-white/20 transition-colors duration-200 text-white"
        title="Cambiar tema"
        aria-label="Alternar modo oscuro"
      >
        <svg id="theme-icon-light" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd" />
        </svg>
        <svg id="theme-icon-dark" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
          <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" />
        </svg>
      </button>
    </div>
  </header>
    <div id="root"></div>
  
    <div id="loading-overlay" class="fixed inset-0 z-[9999] bg-gray-100 dark:bg-gray-900 flex items-center justify-center transition-colors">
      <div class="text-center">
          <p class="text-lg font-semibold text-gray-800 dark:text-white">Cargando aplicaci√≥n...</p>
          <p class="text-sm text-gray-600 dark:text-gray-300">Por favor, espera un momento.</p>
      </div>
    </div>
  
    <input id="restore-json-input" type="file" accept="application/json" className="hidden" aria-label="Cargar archivo de backup en formato JSON">
  
    <!-- [THEME SYSTEM] Gesti√≥n de temas oscuro/claro -->
    <script>
      // Theme management with localStorage persistence
      const ThemeManager = {
        getStoredTheme: () => localStorage.getItem('theme') || 'light',
        setStoredTheme: (theme) => localStorage.setItem('theme', theme),
        
        applyTheme: (theme) => {
          const html = document.documentElement;
          const lightIcon = document.getElementById('theme-icon-light');
          const darkIcon = document.getElementById('theme-icon-dark');
          
          if (theme === 'dark') {
            html.classList.add('dark');
            if (lightIcon) lightIcon.classList.remove('hidden');
            if (darkIcon) darkIcon.classList.add('hidden');
          } else {
            html.classList.remove('dark');
            if (lightIcon) lightIcon.classList.add('hidden');
            if (darkIcon) darkIcon.classList.remove('hidden');
          }
        },
        
        toggle: () => {
          const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
          const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
          ThemeManager.setStoredTheme(newTheme);
          ThemeManager.applyTheme(newTheme);
        },
        
        init: () => {
          const storedTheme = ThemeManager.getStoredTheme();
          ThemeManager.applyTheme(storedTheme);
          
          // Add click listener to toggle button
          const toggleBtn = document.getElementById('theme-toggle');
          if (toggleBtn) {
            toggleBtn.addEventListener('click', ThemeManager.toggle);
          }
        }
      };
      
      // Initialize theme system when DOM is ready
      document.addEventListener('DOMContentLoaded', ThemeManager.init);
      
      // Also try immediate initialization for dynamic content
      setTimeout(ThemeManager.init, 100);
    </script>

     <script type="text/babel">    const { useState, useRef, useEffect, Fragment, useMemo } = React;

    // ==============================
    // Iconos (Lucide-like minimal)
    // ==============================
    const Icon = ({path, className}) => (
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
        {path}
      </svg>
    );
    const UploadCloudIcon = (p) => <Icon {...p} path={<Fragment><path d="M4 14.9A7 7 0 1 1 15.7 8h1.8A4.5 4.5 0 0 1 20 16.2"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></Fragment>} />
    const CheckCircleIcon = (p) => <Icon {...p} path={<Fragment><path d="M22 11.08V12A10 10 0 1 1 16.07 2.86"/><polyline points="22 4 12 14.01 9 11.01"/></Fragment>} />
    const AlertTriangleIcon = (p) => <Icon {...p} path={<Fragment><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></Fragment>} />
    const InfoIcon = (p) => <Icon {...p} path={<Fragment><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></Fragment>} />
    const DatabaseIcon = (p) => <Icon {...p} path={<Fragment><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5v14a9 3 0 0 0 18 0V5"/><path d="M3 12a9 3 0 0 0 18 0"/></Fragment>} />
    const BarChartIcon = (p) => <Icon {...p} path={<Fragment><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></Fragment>} />

    // =============================================
    // [TOOLTIP] Componente informativo reutilizable
    // =============================================
    const Tooltip = ({ children, content, position = 'top' }) => {
      const [isVisible, setIsVisible] = useState(false);
      
      const positionClasses = {
        top: 'bottom-full left-1/2 transform -translate-x-1/2 mb-2',
        bottom: 'top-full left-1/2 transform -translate-x-1/2 mt-2',
        left: 'right-full top-1/2 transform -translate-y-1/2 mr-2',
        right: 'left-full top-1/2 transform -translate-y-1/2 ml-2'
      };

      return (
        <div 
          className="relative inline-block"
          onMouseEnter={() => setIsVisible(true)}
          onMouseLeave={() => setIsVisible(false)}
        >
          {children}
          {isVisible && (
            <div className={`absolute z-[10000] px-3 py-2 text-xs bg-gray-900 dark:bg-gray-700 text-white rounded-lg shadow-lg max-w-xs whitespace-normal ${positionClasses[position]}`}>
              {content}
              <div className={`absolute w-2 h-2 bg-gray-900 dark:bg-gray-700 transform rotate-45 ${
                position === 'top' ? 'top-full left-1/2 -translate-x-1/2 -mt-1' :
                position === 'bottom' ? 'bottom-full left-1/2 -translate-x-1/2 -mb-1' :
                position === 'left' ? 'left-full top-1/2 -translate-y-1/2 -ml-1' :
                'right-full top-1/2 -translate-y-1/2 -mr-1'
              }`}></div>
            </div>
          )}
        </div>
      );
    };

    // =============================================
    // Utilidades: normalizaci√≥n y helpers del parser
    // ==============================================
// [NotesZero][Paso 1] Normaliza nota desde celda XLSX:
// - vac√≠o/null/undefined  -> 0.0
// - string num√©rico       -> n√∫mero [0..5]
// - no num√©rico real      -> null (se seguir√° mostrando "-")
function notaFromCell(v) {
  if (v === null || v === undefined) return 0.0;
  if (typeof v === 'string') {
    const t = v.trim();
    if (t === '') return 0.0;
    const n = parseFloat(t.replace(',', '.'));
    if (!Number.isFinite(n)) return null;
    v = n;
  }
  if (typeof v === 'number' && Number.isFinite(v)) {
    const n = Math.max(0, Math.min(5, v));
    return Number(n.toFixed(2));
  }
  return null;
}
    const textNormalize = (v) => (typeof v === 'string' ? v.trim() : v);
    const toUpperSafe = (v) => (v == null ? '' : String(v).trim().toUpperCase());

    const removeDiacritics = (str) => (str || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '');

    function normTxt(s){ return (s==null?'':String(s)).toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').trim(); }

// [ExportCSV] convierte filas de objetos a CSV y dispara descarga
function exportToCSV(filename, rows, columns) {
  const esc = (v) => {
    if (v == null) return '';
    const s = String(v).replace(/\r?\n/g, ' ');
    return /[",;]/.test(s) ? `"${s.replace(/"/g, '""')}"` : s;
  };
  const header = columns.map(c => esc(c.header || c.title || c.key || c)).join(',');
  const csv = [header].concat(
    rows.map(r => columns.map(c => {
      const key = c.key || c.accessorKey || c.id || c;
      const val = typeof c.accessor === 'function' ? c.accessor(r) : r[key];
      return esc(val);
    }).join(','))
  ).join('\r\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 1000);
}

// [ExportPNG] descarga un <canvas> como PNG
function downloadCanvasPNG(canvas, filename) {
  if (!canvas) return;
  const url = canvas.toDataURL('image/png');
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL?.(url), 500);
}

// [BackupJSON] descarga un objeto como .json
function downloadJSON(filename, data) {
  try {
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 500);
  } catch (err) {
    console.error('[BackupJSON]', err);
    (window.showBanner || ((m)=>alert(m)))('No se pudo exportar el backup JSON.');
  }
}

// ======================================
// [FASE 5] Sistema de Exportaci√≥n de Informes por Periodos
// ======================================

// Exporta informe de estad√≠sticas consolidadas a CSV
function exportConsolidatedStatsToCSV(filename, stats) {
  const rows = [];
  
  // Informaci√≥n general
  rows.push(['RESUMEN GENERAL', '', '', '']);
  rows.push(['M√©trica', 'Valor', '', '']);
  rows.push(['Periodos Disponibles', stats.overview.totalPeriods, '', '']);
  rows.push(['Total Estudiantes', stats.overview.totalStudents, '', '']);
  rows.push(['Total Materias', stats.overview.totalSubjects, '', '']);
  rows.push(['Promedio General', formatGradeForReport(stats.overview.overallAverageGrade), '', '']);
  rows.push(['Tasa Bajo Rendimiento', formatPercentageForReport(stats.overview.overallLowPerformanceRate), '', '']);
  rows.push(['', '', '', '']);
  
  // Comparaci√≥n por periodo
  rows.push(['COMPARACI√ìN POR PERIODO', '', '', '']);
  rows.push(['Periodo', 'Promedio', 'Bajo Rendimiento', 'Tasa Aprobaci√≥n']);
  Object.entries(stats.periodComparison).forEach(([period, data]) => {
    rows.push([
      period,
      formatGradeForReport(data.averageGrade),
      data.lowPerformanceCount,
      formatPercentageForReport(data.approvalRate)
    ]);
  });
  rows.push(['', '', '', '']);
  
  // Tendencias
  rows.push(['TENDENCIAS', '', '', '']);
  rows.push(['Tipo', 'Cantidad', '', '']);
  rows.push(['Mejorando', stats.trends.improving, '', '']);
  rows.push(['Declinando', stats.trends.declining, '', '']);
  rows.push(['Estable', stats.trends.stable, '', '']);
  rows.push(['', '', '', '']);
  
  // Alertas
  if (stats.alerts && stats.alerts.length > 0) {
    rows.push(['ALERTAS AUTOM√ÅTICAS', '', '', '']);
    rows.push(['Tipo', 'T√≠tulo', 'Mensaje', 'Recomendaci√≥n']);
    stats.alerts.forEach(alert => {
      rows.push([alert.type, alert.title, alert.message, alert.recommendation]);
    });
  }

  const columns = [
    { key: 0, header: 'Campo' },
    { key: 1, header: 'Valor' },
    { key: 2, header: 'Extra1' },
    { key: 3, header: 'Extra2' }
  ];

  exportToCSV(filename, rows.map(row => ({ 0: row[0], 1: row[1], 2: row[2], 3: row[3] })), columns);
}

// Exporta informe de bajo rendimiento a CSV
function exportLowPerformanceToCSV(filename, report) {
  const rows = [];
  
  // Resumen por periodo
  Object.entries(report.summary).forEach(([period, data]) => {
    rows.push([`BAJO RENDIMIENTO - ${period}`, '', '', '', '', '']);
    rows.push(['Estudiante', 'Curso', '√Årea', 'Materia', 'Calificaci√≥n', 'Estado']);
    
    data.studentDetails.forEach(student => {
      student.subjects.forEach(subject => {
        rows.push([
          student.student,
          student.course,
          subject.area,
          subject.subject,
          formatGradeForReport(subject.grade),
          'Bajo Rendimiento'
        ]);
      });
    });
    rows.push(['', '', '', '', '', '']);
  });

  // Recomendaciones
  if (report.recommendations && report.recommendations.length > 0) {
    rows.push(['RECOMENDACIONES', '', '', '', '', '']);
    rows.push(['Prioridad', 'T√≠tulo', 'Descripci√≥n', 'Acciones', '', '']);
    
    report.recommendations.forEach(rec => {
      rows.push([
        rec.priority,
        rec.title,
        rec.description,
        rec.actionItems.join('; '),
        '',
        ''
      ]);
    });
  }

  const columns = [
    { key: 0, header: 'Campo1' },
    { key: 1, header: 'Campo2' },
    { key: 2, header: 'Campo3' },
    { key: 3, header: 'Campo4' },
    { key: 4, header: 'Campo5' },
    { key: 5, header: 'Campo6' }
  ];

  exportToCSV(filename, rows.map(row => ({ 
    0: row[0], 1: row[1], 2: row[2], 3: row[3], 4: row[4], 5: row[5] 
  })), columns);
}

// Exporta informe comparativo a CSV
function exportComparativeToCSV(filename, report) {
  const rows = [];
  
  report.comparisons.forEach((comparison, index) => {
    rows.push([`COMPARACI√ìN ${comparison.period1} vs ${comparison.period2}`, '', '', '', '']);
    rows.push(['Estad√≠stica', 'Valor', '', '', '']);
    rows.push(['Total Comparaciones', comparison.statistics.totalComparisons, '', '', '']);
    rows.push(['Mejoras', comparison.statistics.improvementCount, '', '', '']);
    rows.push(['Declives', comparison.statistics.declineCount, '', '', '']);
    rows.push(['Estables', comparison.statistics.stableCount, '', '', '']);
    rows.push(['Cambio Promedio', formatGradeForReport(comparison.statistics.averageChange), '', '', '']);
    rows.push(['', '', '', '', '']);
    
    // Top mejoras
    if (comparison.improvements.length > 0) {
      rows.push(['PRINCIPALES MEJORAS', '', '', '', '']);
      rows.push(['Estudiante', 'Materia', comparison.period1, comparison.period2, 'Cambio']);
      comparison.improvements.slice(0, 10).forEach(item => {
        rows.push([
          item.student,
          item.subject,
          formatGradeForReport(item.period1Grade),
          formatGradeForReport(item.period2Grade),
          `+${formatGradeForReport(item.change)}`
        ]);
      });
      rows.push(['', '', '', '', '']);
    }
    
    // Top declives
    if (comparison.declines.length > 0) {
      rows.push(['PRINCIPALES DECLIVES', '', '', '', '']);
      rows.push(['Estudiante', 'Materia', comparison.period1, comparison.period2, 'Cambio']);
      comparison.declines.slice(0, 10).forEach(item => {
        rows.push([
          item.student,
          item.subject,
          formatGradeForReport(item.period1Grade),
          formatGradeForReport(item.period2Grade),
          formatGradeForReport(item.change)
        ]);
      });
      rows.push(['', '', '', '', '']);
    }
  });

  const columns = [
    { key: 0, header: 'Campo1' },
    { key: 1, header: 'Campo2' },
    { key: 2, header: 'Campo3' },
    { key: 3, header: 'Campo4' },
    { key: 4, header: 'Campo5' }
  ];

  exportToCSV(filename, rows.map(row => ({ 
    0: row[0], 1: row[1], 2: row[2], 3: row[3], 4: row[4] 
  })), columns);
}

// Exporta a Excel usando SheetJS (XLSX)
function exportReportToExcel(filename, report, reportType) {
  try {
    const workbook = XLSX.utils.book_new();
    
    switch (reportType) {
      case 'consolidated_statistics':
        exportConsolidatedStatsToExcel(workbook, report);
        break;
      case 'low_performance':
        exportLowPerformanceToExcel(workbook, report);
        break;
      case 'comparative':
        exportComparativeToExcel(workbook, report);
        break;
      case 'student_performance':
        exportStudentPerformanceToExcel(workbook, report);
        break;
    }
    
    // Agregar hoja de metadatos
    const metaData = [
      ['Informe', reportType],
      ['Generado', new Date().toLocaleString()],
      ['Sistema', 'IE El Carmen - Dashboard Acad√©mico'],
      ['Versi√≥n', '2.0 - Sistema de Informes por Periodos']
    ];
    const metaWS = XLSX.utils.aoa_to_sheet(metaData);
    XLSX.utils.book_append_sheet(workbook, metaWS, 'Metadatos');
    
    // Descargar archivo
    XLSX.writeFile(workbook, filename);
  } catch (error) {
    console.error('Error exportando a Excel:', error);
    alert('Error al exportar a Excel: ' + error.message);
  }
}

// Exporta estad√≠sticas consolidadas a Excel
function exportConsolidatedStatsToExcel(workbook, stats) {
  // Hoja de resumen
  const summaryData = [
    ['RESUMEN GENERAL'],
    ['M√©trica', 'Valor'],
    ['Periodos Disponibles', stats.overview.totalPeriods],
    ['Total Estudiantes', stats.overview.totalStudents],
    ['Total Materias', stats.overview.totalSubjects],
    ['Promedio General', parseFloat(formatGradeForReport(stats.overview.overallAverageGrade))],
    ['Tasa Bajo Rendimiento (%)', parseFloat(stats.overview.overallLowPerformanceRate.toFixed(1))],
    [],
    ['COMPARACI√ìN POR PERIODO'],
    ['Periodo', 'Promedio', 'Bajo Rendimiento', 'Tasa Aprobaci√≥n (%)']
  ];
  
  Object.entries(stats.periodComparison).forEach(([period, data]) => {
    summaryData.push([
      period,
      parseFloat(formatGradeForReport(data.averageGrade)),
      data.lowPerformanceCount,
      parseFloat(data.approvalRate.toFixed(1))
    ]);
  });
  
  summaryData.push([]);
  summaryData.push(['TENDENCIAS']);
  summaryData.push(['Tipo', 'Cantidad']);
  summaryData.push(['Mejorando', stats.trends.improving]);
  summaryData.push(['Declinando', stats.trends.declining]);
  summaryData.push(['Estable', stats.trends.stable]);
  
  const summaryWS = XLSX.utils.aoa_to_sheet(summaryData);
  XLSX.utils.book_append_sheet(workbook, summaryWS, 'Resumen');
  
  // Hoja de alertas
  if (stats.alerts && stats.alerts.length > 0) {
    const alertsData = [
      ['ALERTAS AUTOM√ÅTICAS'],
      ['Tipo', 'T√≠tulo', 'Mensaje', 'Recomendaci√≥n']
    ];
    
    stats.alerts.forEach(alert => {
      alertsData.push([alert.type, alert.title, alert.message, alert.recommendation]);
    });
    
    const alertsWS = XLSX.utils.aoa_to_sheet(alertsData);
    XLSX.utils.book_append_sheet(workbook, alertsWS, 'Alertas');
  }
}

// Exporta bajo rendimiento a Excel
function exportLowPerformanceToExcel(workbook, report) {
  Object.entries(report.summary).forEach(([period, data]) => {
    const sheetData = [
      [`BAJO RENDIMIENTO - ${period}`],
      ['Estudiante', 'Curso', '√Årea', 'Materia', 'Calificaci√≥n']
    ];
    
    data.studentDetails.forEach(student => {
      student.subjects.forEach(subject => {
        sheetData.push([
          student.student,
          student.course,
          subject.area,
          subject.subject,
          parseFloat(formatGradeForReport(subject.grade))
        ]);
      });
    });
    
    const ws = XLSX.utils.aoa_to_sheet(sheetData);
    XLSX.utils.book_append_sheet(workbook, ws, `Bajo_Rendimiento_${period}`);
  });
  
  // Hoja de recomendaciones
  if (report.recommendations && report.recommendations.length > 0) {
    const recData = [
      ['RECOMENDACIONES'],
      ['Prioridad', 'T√≠tulo', 'Descripci√≥n', 'Acciones']
    ];
    
    report.recommendations.forEach(rec => {
      recData.push([
        rec.priority,
        rec.title,
        rec.description,
        rec.actionItems.join('; ')
      ]);
    });
    
    const recWS = XLSX.utils.aoa_to_sheet(recData);
    XLSX.utils.book_append_sheet(workbook, recWS, 'Recomendaciones');
  }
}

// Exporta comparativo a Excel
function exportComparativeToExcel(workbook, report) {
  report.comparisons.forEach((comparison, index) => {
    const sheetData = [
      [`COMPARACI√ìN ${comparison.period1} vs ${comparison.period2}`],
      ['Estad√≠stica', 'Valor'],
      ['Total Comparaciones', comparison.statistics.totalComparisons],
      ['Mejoras', comparison.statistics.improvementCount],
      ['Declives', comparison.statistics.declineCount],
      ['Estables', comparison.statistics.stableCount],
      ['Cambio Promedio', parseFloat(formatGradeForReport(comparison.statistics.averageChange))],
      []
    ];
    
    if (comparison.improvements.length > 0) {
      sheetData.push(['PRINCIPALES MEJORAS']);
      sheetData.push(['Estudiante', 'Materia', comparison.period1, comparison.period2, 'Cambio']);
      comparison.improvements.slice(0, 15).forEach(item => {
        sheetData.push([
          item.student,
          item.subject,
          parseFloat(formatGradeForReport(item.period1Grade)),
          parseFloat(formatGradeForReport(item.period2Grade)),
          parseFloat(formatGradeForReport(item.change))
        ]);
      });
      sheetData.push([]);
    }
    
    if (comparison.declines.length > 0) {
      sheetData.push(['PRINCIPALES DECLIVES']);
      sheetData.push(['Estudiante', 'Materia', comparison.period1, comparison.period2, 'Cambio']);
      comparison.declines.slice(0, 15).forEach(item => {
        sheetData.push([
          item.student,
          item.subject,
          parseFloat(formatGradeForReport(item.period1Grade)),
          parseFloat(formatGradeForReport(item.period2Grade)),
          parseFloat(formatGradeForReport(item.change))
        ]);
      });
    }
    
    const ws = XLSX.utils.aoa_to_sheet(sheetData);
    XLSX.utils.book_append_sheet(workbook, ws, `Comparacion_${index + 1}`);
  });
}

// Exporta rendimiento por estudiante a Excel
function exportStudentPerformanceToExcel(workbook, report) {
  // Hoja de resumen por periodos individuales
  const individualData = [
    ['RENDIMIENTO POR PERIODO INDIVIDUAL'],
    ['Periodo', 'Total Materias', 'Aprobadas', 'Reprobadas', 'Bajo Rendimiento', 'Promedio']
  ];
  
  Object.entries(report.individualPeriods || {}).forEach(([period, data]) => {
    individualData.push([
      period,
      data.totalSubjects,
      data.approvedSubjects,
      data.failedSubjects,
      data.lowPerformanceSubjects,
      parseFloat(formatGradeForReport(data.averageGrade))
    ]);
  });
  
  const individualWS = XLSX.utils.aoa_to_sheet(individualData);
  XLSX.utils.book_append_sheet(workbook, individualWS, 'Por_Periodo');
  
  // Hoja de an√°lisis acumulativo
  const cumulativeData = [
    ['AN√ÅLISIS ACUMULATIVO'],
    ['Periodos', 'Total Materias', 'Promedio', 'Mejorando', 'Declinando', 'Estable', 'Bajo Rendimiento']
  ];
  
  Object.entries(report.cumulativeAnalysis || {}).forEach(([key, data]) => {
    cumulativeData.push([
      data.periodsIncluded.join('+'),
      data.totalSubjects,
      parseFloat(formatGradeForReport(data.averagePerformance)),
      data.improvingSubjects,
      data.decliningSubjects,
      data.stableSubjects,
      data.lowPerformanceSubjects
    ]);
  });
  
  const cumulativeWS = XLSX.utils.aoa_to_sheet(cumulativeData);
  XLSX.utils.book_append_sheet(workbook, cumulativeWS, 'Acumulativo');
}

// Genera PDF usando bibliotecas del navegador (b√°sico)
function exportReportToPDF(filename, report, reportType) {
  try {
    // Crear contenido HTML para el PDF
    const htmlContent = generatePDFContent(report, reportType);
    
    // Crear ventana nueva para imprimir/guardar como PDF
    const printWindow = window.open('', '_blank');
    printWindow.document.write(htmlContent);
    printWindow.document.close();
    
    // Esperar a que se cargue y luego imprimir
    printWindow.onload = () => {
      printWindow.print();
    };
    
  } catch (error) {
    console.error('Error exportando a PDF:', error);
    alert('Error al exportar a PDF: ' + error.message);
  }
}

// Genera contenido HTML para PDF
function generatePDFContent(report, reportType) {
  const currentDate = new Date().toLocaleString();
  let content = '';
  
  switch (reportType) {
    case 'consolidated_statistics':
      content = generateConsolidatedStatsPDFContent(report);
      break;
    case 'low_performance':
      content = generateLowPerformancePDFContent(report);
      break;
    case 'comparative':
      content = generateComparativePDFContent(report);
      break;
    case 'student_performance':
      content = generateStudentPerformancePDFContent(report);
      break;
  }
  
  return `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>Informe Acad√©mico - IE El Carmen</title>
      <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.4; }
        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
        .logo { font-size: 24px; font-weight: bold; color: #2563eb; }
        .institution { font-size: 18px; margin: 10px 0; }
        .report-title { font-size: 16px; color: #666; }
        .generated { font-size: 12px; color: #888; margin-top: 10px; }
        .section { margin: 30px 0; page-break-inside: avoid; }
        .section-title { font-size: 18px; font-weight: bold; color: #1f2937; border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f3f4f6; font-weight: bold; }
        .metric-value { font-weight: bold; color: #059669; }
        .alert-critical { background-color: #fef2f2; border-left: 4px solid #dc2626; padding: 10px; margin: 10px 0; }
        .alert-warning { background-color: #fffbeb; border-left: 4px solid #d97706; padding: 10px; margin: 10px 0; }
        .page-break { page-break-before: always; }
        @media print { body { margin: 0; } .page-break { page-break-before: always; } }
      </style>
    </head>
    <body>
      <div class="header">
        <div class="logo">IE EL CARMEN</div>
        <div class="institution">Dashboard Institucional - Sistema de Informes por Periodos</div>
        <div class="report-title">Informe de ${getReportTypeName(reportType)}</div>
        <div class="generated">Generado el: ${currentDate}</div>
      </div>
      ${content}
    </body>
    </html>
  `;
}

// Obtiene el nombre descriptivo del tipo de reporte
function getReportTypeName(reportType) {
  const names = {
    'consolidated_statistics': 'Estad√≠sticas Consolidadas',
    'low_performance': 'Bajo Rendimiento',
    'comparative': 'An√°lisis Comparativo',
    'student_performance': 'Rendimiento por Estudiante'
  };
  return names[reportType] || reportType;
}

// Genera contenido PDF para estad√≠sticas consolidadas
function generateConsolidatedStatsPDFContent(stats) {
  let content = `
    <div class="section">
      <div class="section-title">üìä Resumen General</div>
      <table>
        <tr><th>M√©trica</th><th>Valor</th></tr>
        <tr><td>Periodos Disponibles</td><td class="metric-value">${stats.overview.totalPeriods}</td></tr>
        <tr><td>Total Estudiantes</td><td class="metric-value">${stats.overview.totalStudents}</td></tr>
        <tr><td>Total Materias</td><td class="metric-value">${stats.overview.totalSubjects}</td></tr>
        <tr><td>Promedio General</td><td class="metric-value">${formatGradeForReport(stats.overview.overallAverageGrade)}</td></tr>
        <tr><td>Tasa Bajo Rendimiento</td><td class="metric-value">${formatPercentageForReport(stats.overview.overallLowPerformanceRate)}</td></tr>
      </table>
    </div>
    
    <div class="section">
      <div class="section-title">üìà Comparaci√≥n por Periodo</div>
      <table>
        <tr><th>Periodo</th><th>Promedio</th><th>Bajo Rendimiento</th><th>Tasa Aprobaci√≥n</th></tr>
  `;
  
  Object.entries(stats.periodComparison).forEach(([period, data]) => {
    content += `
      <tr>
        <td>${period}</td>
        <td>${formatGradeForReport(data.averageGrade)}</td>
        <td>${data.lowPerformanceCount}</td>
        <td>${formatPercentageForReport(data.approvalRate)}</td>
      </tr>
    `;
  });
  
  content += `
      </table>
    </div>
    
    <div class="section">
      <div class="section-title">üìä Tendencias</div>
      <table>
        <tr><th>Tipo</th><th>Cantidad</th></tr>
        <tr><td>Mejorando</td><td class="metric-value">${stats.trends.improving}</td></tr>
        <tr><td>Declinando</td><td class="metric-value">${stats.trends.declining}</td></tr>
        <tr><td>Estable</td><td class="metric-value">${stats.trends.stable}</td></tr>
      </table>
    </div>
  `;
  
  if (stats.alerts && stats.alerts.length > 0) {
    content += `
      <div class="section">
        <div class="section-title">üö® Alertas Autom√°ticas</div>
    `;
    
    stats.alerts.forEach(alert => {
      const alertClass = alert.type === 'critical' ? 'alert-critical' : 'alert-warning';
      content += `
        <div class="${alertClass}">
          <strong>${alert.title}</strong><br>
          ${alert.message}<br>
          <em>Recomendaci√≥n: ${alert.recommendation}</em>
        </div>
      `;
    });
    
    content += `</div>`;
  }
  
  return content;
}

// Genera contenido PDF para bajo rendimiento  
function generateLowPerformancePDFContent(report) {
  let content = '';
  
  Object.entries(report.summary).forEach(([period, data]) => {
    content += `
      <div class="section">
        <div class="section-title">üìã Bajo Rendimiento - ${period}</div>
        <p><strong>Estudiantes Afectados:</strong> ${data.totalStudentsAffected} | 
           <strong>Materias Afectadas:</strong> ${data.totalSubjectsAffected} | 
           <strong>Promedio:</strong> ${formatGradeForReport(data.averageGrade)}</p>
        
        <table>
          <tr><th>Estudiante</th><th>Curso</th><th>Materias Problem√°ticas</th></tr>
    `;
    
    data.studentDetails.slice(0, 20).forEach(student => {
      const subjects = student.subjects.map(s => `${s.subject} (${formatGradeForReport(s.grade)})`).join(', ');
      content += `
        <tr>
          <td>${student.student}</td>
          <td>${student.course}</td>
          <td>${subjects}</td>
        </tr>
      `;
    });
    
    content += `</table></div>`;
  });
  
  if (report.recommendations && report.recommendations.length > 0) {
    content += `
      <div class="section">
        <div class="section-title">üí° Recomendaciones</div>
    `;
    
    report.recommendations.forEach(rec => {
      content += `
        <div class="alert-warning">
          <strong>${rec.title}</strong><br>
          ${rec.description}<br>
          <strong>Acciones:</strong>
          <ul>
            ${rec.actionItems.map(item => `<li>${item}</li>`).join('')}
          </ul>
        </div>
      `;
    });
    
    content += `</div>`;
  }
  
  return content;
}

// Genera contenido PDF para comparativo
function generateComparativePDFContent(report) {
  let content = '';
  
  report.comparisons.forEach((comparison, index) => {
    content += `
      <div class="section">
        <div class="section-title">üìä ${comparison.period1} vs ${comparison.period2}</div>
        
        <table>
          <tr><th>Estad√≠stica</th><th>Valor</th></tr>
          <tr><td>Total Comparaciones</td><td>${comparison.statistics.totalComparisons}</td></tr>
          <tr><td>Mejoras</td><td class="metric-value">${comparison.statistics.improvementCount}</td></tr>
          <tr><td>Declives</td><td>${comparison.statistics.declineCount}</td></tr>
          <tr><td>Estables</td><td>${comparison.statistics.stableCount}</td></tr>
          <tr><td>Cambio Promedio</td><td>${formatGradeForReport(comparison.statistics.averageChange)}</td></tr>
        </table>
      </div>
    `;
    
    if (comparison.improvements.length > 0) {
      content += `
        <div class="section">
          <div class="section-title">üéØ Principales Mejoras</div>
          <table>
            <tr><th>Estudiante</th><th>Materia</th><th>${comparison.period1}</th><th>${comparison.period2}</th><th>Cambio</th></tr>
      `;
      
      comparison.improvements.slice(0, 10).forEach(item => {
        content += `
          <tr>
            <td>${item.student}</td>
            <td>${item.subject}</td>
            <td>${formatGradeForReport(item.period1Grade)}</td>
            <td>${formatGradeForReport(item.period2Grade)}</td>
            <td class="metric-value">+${formatGradeForReport(item.change)}</td>
          </tr>
        `;
      });
      
      content += `</table></div>`;
    }
    
    if (comparison.declines.length > 0) {
      content += `
        <div class="section">
          <div class="section-title">‚ö†Ô∏è Principales Declives</div>
          <table>
            <tr><th>Estudiante</th><th>Materia</th><th>${comparison.period1}</th><th>${comparison.period2}</th><th>Cambio</th></tr>
      `;
      
      comparison.declines.slice(0, 10).forEach(item => {
        content += `
          <tr>
            <td>${item.student}</td>
            <td>${item.subject}</td>
            <td>${formatGradeForReport(item.period1Grade)}</td>
            <td>${formatGradeForReport(item.period2Grade)}</td>
            <td style="color: #dc2626;">${formatGradeForReport(item.change)}</td>
          </tr>
        `;
      });
      
      content += `</table></div>`;
    }
  });
  
  return content;
}

// Genera contenido PDF para rendimiento por estudiante
function generateStudentPerformancePDFContent(report) {
  let content = `
    <div class="section">
      <div class="section-title">üë§ Rendimiento por Periodo Individual</div>
      <table>
        <tr><th>Periodo</th><th>Total Materias</th><th>Aprobadas</th><th>Reprobadas</th><th>Bajo Rendimiento</th><th>Promedio</th></tr>
  `;
  
  Object.entries(report.individualPeriods || {}).forEach(([period, data]) => {
    content += `
      <tr>
        <td>${period}</td>
        <td>${data.totalSubjects}</td>
        <td class="metric-value">${data.approvedSubjects}</td>
        <td>${data.failedSubjects}</td>
        <td>${data.lowPerformanceSubjects}</td>
        <td>${formatGradeForReport(data.averageGrade)}</td>
      </tr>
    `;
  });
  
  content += `
      </table>
    </div>
    
    <div class="section">
      <div class="section-title">üìà An√°lisis Acumulativo</div>
      <table>
        <tr><th>Periodos</th><th>Total Materias</th><th>Promedio</th><th>Mejorando</th><th>Declinando</th><th>Estable</th></tr>
  `;
  
  Object.entries(report.cumulativeAnalysis || {}).forEach(([key, data]) => {
    content += `
      <tr>
        <td>${data.periodsIncluded.join(' + ')}</td>
        <td>${data.totalSubjects}</td>
        <td class="metric-value">${formatGradeForReport(data.averagePerformance)}</td>
        <td class="metric-value">${data.improvingSubjects}</td>
        <td>${data.decliningSubjects}</td>
        <td>${data.stableSubjects}</td>
      </tr>
    `;
  });
  
  content += `</table></div>`;
  
  return content;
}

// Funci√≥n principal para exportar informes
function exportReport(report, reportType, format, filename) {
  const timestamp = new Date().toISOString().slice(0, 10);
  const baseFilename = filename || `informe_${reportType}_${timestamp}`;
  
  switch (format) {
    case 'csv':
      switch (reportType) {
        case 'consolidated_statistics':
          exportConsolidatedStatsToCSV(`${baseFilename}.csv`, report);
          break;
        case 'low_performance':
          exportLowPerformanceToCSV(`${baseFilename}.csv`, report);
          break;
        case 'comparative':
          exportComparativeToCSV(`${baseFilename}.csv`, report);
          break;
        default:
          alert('Exportaci√≥n CSV no disponible para este tipo de reporte');
      }
      break;
      
    case 'xlsx':
      exportReportToExcel(`${baseFilename}.xlsx`, report, reportType);
      break;
      
    case 'pdf':
      exportReportToPDF(`${baseFilename}.pdf`, report, reportType);
      break;
      
    case 'json':
      downloadJSON(`${baseFilename}.json`, report);
      break;
      
    default:
      alert('Formato de exportaci√≥n no soportado: ' + format);
  }
}

// ======================================
// [FASE 6] Sistema de Pruebas y Validaci√≥n
// ======================================

// Sistema de testing para validar funcionalidades de informes por periodos
const validatePeriodicAnalysisSystem = (derived, dashboardData) => {
  const validationResults = {
    timestamp: new Date().toISOString(),
    passed: true,
    tests: [],
    errors: [],
    warnings: [],
    performance: {}
  };

  const addTest = (name, condition, message, level = 'test') => {
    const result = { name, passed: !!condition, message, level };
    validationResults.tests.push(result);
    
    if (!condition) {
      validationResults.passed = false;
      if (level === 'error') {
        validationResults.errors.push(result);
      } else if (level === 'warning') {
        validationResults.warnings.push(result);
      }
    }
    
    return result;
  };

  // Test 1: Validar estructura b√°sica
  console.time('[VALIDATION] Basic Structure');
  addTest(
    'Estructura Derived Data',
    derived && derived.periodicAnalysis,
    'El objeto derived debe contener periodicAnalysis'
  );

  addTest(
    'Dashboard Data disponible',
    Array.isArray(dashboardData) && dashboardData.length > 0,
    'Debe haber datos de estudiantes cargados'
  );

  if (!derived?.periodicAnalysis) {
    console.timeEnd('[VALIDATION] Basic Structure');
    return validationResults;
  }

  const { periodicAnalysis } = derived;
  
  // Test 2: Validar periodos disponibles
  addTest(
    'Periodos disponibles',
    Array.isArray(periodicAnalysis.availablePeriods) && periodicAnalysis.availablePeriods.length > 0,
    'Debe detectar al menos un periodo con datos'
  );

  // Test 3: Validar an√°lisis por periodo
  periodicAnalysis.availablePeriods?.forEach(period => {
    const periodData = periodicAnalysis.byPeriod?.[period];
    addTest(
      `Datos del ${period}`,
      periodData && periodData.available && Array.isArray(periodData.data),
      `El periodo ${period} debe tener datos v√°lidos`
    );

    if (periodData?.data) {
      const hasValidGrades = periodData.data.some(item => 
        typeof item.grade === 'number' && item.grade >= 0 && item.grade <= 5
      );
      addTest(
        `Calificaciones v√°lidas ${period}`,
        hasValidGrades,
        `El periodo ${period} debe tener calificaciones en rango 0-5`
      );
    }
  });

  // Test 4: Validar an√°lisis acumulativo
  const cumulativeKeys = Object.keys(periodicAnalysis.cumulative || {});
  addTest(
    'An√°lisis acumulativo generado',
    cumulativeKeys.length > 0,
    'Debe generar an√°lisis acumulativo cuando hay m√∫ltiples periodos',
    periodicAnalysis.availablePeriods?.length >= 2 ? 'test' : 'warning'
  );

  // Test 5: Validar detecci√≥n de bajo rendimiento
  const lowPerfPeriods = Object.keys(periodicAnalysis.lowPerformanceByPeriod || {});
  addTest(
    'Detecci√≥n de bajo rendimiento',
    lowPerfPeriods.length > 0,
    'Debe detectar estudiantes con bajo rendimiento'
  );

  // Test 6: Validar resumen de bajo rendimiento
  addTest(
    'Resumen de bajo rendimiento',
    Array.isArray(periodicAnalysis.lowPerformanceSummary),
    'Debe generar resumen de bajo rendimiento por periodo'
  );

  console.timeEnd('[VALIDATION] Basic Structure');

  // Test 7: Validar generaci√≥n de reportes
  console.time('[VALIDATION] Report Generation');
  
  try {
    const consolidatedStats = generateReport(derived, 'consolidated_statistics');
    addTest(
      'Generaci√≥n de estad√≠sticas consolidadas',
      consolidatedStats && !consolidatedStats.error,
      'Debe generar estad√≠sticas consolidadas sin errores'
    );

    const lowPerfReport = generateReport(derived, 'low_performance');
    addTest(
      'Generaci√≥n de reporte de bajo rendimiento',
      lowPerfReport && !lowPerfReport.error,
      'Debe generar reporte de bajo rendimiento sin errores'
    );

    const comparativeReport = generateReport(derived, 'comparative');
    addTest(
      'Generaci√≥n de reporte comparativo',
      comparativeReport && !comparativeReport.error,
      'Debe generar reporte comparativo sin errores'
    );

  } catch (error) {
    addTest(
      'Generaci√≥n de reportes',
      false,
      `Error generando reportes: ${error.message}`,
      'error'
    );
  }
  
  console.timeEnd('[VALIDATION] Report Generation');

  // Test 8: Validar funciones utilitarias
  console.time('[VALIDATION] Utility Functions');
  
  addTest(
    'Formato de calificaciones',
    formatGradeForReport(3.75) === '3.75' && formatGradeForReport(null) === 'N/A',
    'La funci√≥n formatGradeForReport debe manejar n√∫meros y valores nulos'
  );

  addTest(
    'Formato de porcentajes',
    formatPercentageForReport(85.7) === '85.7%' && formatPercentageForReport(null) === 'N/A',
    'La funci√≥n formatPercentageForReport debe manejar n√∫meros y valores nulos'
  );

  addTest(
    'Estado de calificaciones',
    getGradeStatus(4.5).status === 'excellent' && getGradeStatus(2.5).status === 'low',
    'La funci√≥n getGradeStatus debe clasificar correctamente las calificaciones'
  );

  console.timeEnd('[VALIDATION] Utility Functions');

  // Test 9: Validar c√°lculos de tendencias
  console.time('[VALIDATION] Trend Calculations');
  
  addTest(
    'C√°lculo de tendencias',
    calculateTrend([3.0, 3.5, 4.0]) === 'Mejorando' && calculateTrend([4.0, 3.5, 3.0]) === 'Declinando',
    'La funci√≥n calculateTrend debe detectar correctamente mejoras y declives'
  );

  console.timeEnd('[VALIDATION] Trend Calculations');

  // Test 10: Validar detecci√≥n autom√°tica de alertas
  if (periodicAnalysis.lowPerformanceSummary) {
    const totalLowPerf = periodicAnalysis.lowPerformanceSummary.reduce(
      (sum, period) => sum + period.subjectsWithLowPerformance, 0
    );
    
    addTest(
      'Detecci√≥n de alertas cr√≠ticas',
      totalLowPerf > 0,
      'Debe detectar situaciones que requieren alertas autom√°ticas',
      'warning'
    );
  }

  // M√©tricas de rendimiento
  const performanceStart = performance.now();
  try {
    generateReport(derived, 'consolidated_statistics');
    validationResults.performance.reportGeneration = performance.now() - performanceStart;
    
    addTest(
      'Rendimiento de generaci√≥n',
      validationResults.performance.reportGeneration < 1000,
      `Generaci√≥n de reportes debe ser < 1000ms (actual: ${validationResults.performance.reportGeneration.toFixed(2)}ms)`,
      validationResults.performance.reportGeneration > 1000 ? 'warning' : 'test'
    );
  } catch (error) {
    validationResults.performance.reportGeneration = -1;
    addTest(
      'Rendimiento de generaci√≥n',
      false,
      `Error midiendo rendimiento: ${error.message}`,
      'error'
    );
  }

  return validationResults;
};

// Genera datos de prueba para testing
const generateTestData = () => {
  const students = ['Ana Garc√≠a', 'Juan P√©rez', 'Mar√≠a L√≥pez', 'Carlos Ruiz', 'Sof√≠a Chen'];
  const areas = ['MATEMATICAS', 'CIENCIAS', 'LENGUAJE', 'SOCIALES'];
  const subjects = {
    'MATEMATICAS': ['Algebra', 'Geometr√≠a', 'Estad√≠stica'],
    'CIENCIAS': ['Biolog√≠a', 'Qu√≠mica', 'F√≠sica'],
    'LENGUAJE': ['Gram√°tica', 'Literatura', 'Redacci√≥n'],
    'SOCIALES': ['Historia', 'Geograf√≠a', 'C√≠vica']
  };

  const testData = students.map((name, index) => {
    const student = {
      id: `EST${index + 1}`,
      name: name,
      CURSO: `10${String.fromCharCode(65 + index % 3)}`, // 10A, 10B, 10C
      areas: {}
    };

    areas.forEach(areaName => {
      const areaData = {
        DEF: {},
        asignaturas: {}
      };

      // Generar calificaciones por periodo
      ['P1', 'P2', 'P3'].forEach(period => {
        // Simular tendencia: algunos estudiantes mejoran, otros empeoran
        let baseGrade = 2.5 + Math.random() * 2; // Base entre 2.5 y 4.5
        if (index % 3 === 0) baseGrade += (period === 'P3' ? 0.5 : period === 'P2' ? 0.2 : 0); // Mejora
        if (index % 3 === 1) baseGrade -= (period === 'P3' ? 0.3 : period === 'P2' ? 0.1 : 0); // Declina
        
        areaData.DEF[period] = Math.min(5.0, Math.max(0.0, baseGrade + (Math.random() - 0.5) * 0.4));
      });

      // Generar calificaciones por asignatura
      subjects[areaName].forEach(subjectName => {
        const subjectData = {};
        ['P1', 'P2', 'P3'].forEach(period => {
          const areaGrade = areaData.DEF[period];
          subjectData[period] = Math.min(5.0, Math.max(0.0, areaGrade + (Math.random() - 0.5) * 0.5));
        });
        areaData.asignaturas[subjectName] = subjectData;
      });

      student.areas[areaName] = areaData;
    });

    return student;
  });

  return testData;
};

// Ejecuta todas las pruebas de validaci√≥n
const runCompleteValidation = (derived, dashboardData) => {
  console.group('[VALIDATION] Sistema de Informes por Periodos - Pruebas Completas');
  console.time('[VALIDATION] Total Time');

  const results = validatePeriodicAnalysisSystem(derived, dashboardData);
  
  console.timeEnd('[VALIDATION] Total Time');
  
  // Mostrar resumen
  console.log('üìä RESUMEN DE VALIDACI√ìN:');
  console.log(`‚úÖ Pruebas exitosas: ${results.tests.filter(t => t.passed).length}`);
  console.log(`‚ùå Pruebas fallidas: ${results.tests.filter(t => !t.passed).length}`);
  console.log(`‚ö†Ô∏è  Advertencias: ${results.warnings.length}`);
  console.log(`üö® Errores cr√≠ticos: ${results.errors.length}`);
  
  if (results.performance.reportGeneration) {
    console.log(`‚ö° Rendimiento generaci√≥n: ${results.performance.reportGeneration.toFixed(2)}ms`);
  }

  // Mostrar detalles de errores y advertencias
  if (results.errors.length > 0) {
    console.group('üö® ERRORES CR√çTICOS:');
    results.errors.forEach(error => {
      console.error(`‚ùå ${error.name}: ${error.message}`);
    });
    console.groupEnd();
  }

  if (results.warnings.length > 0) {
    console.group('‚ö†Ô∏è ADVERTENCIAS:');
    results.warnings.forEach(warning => {
      console.warn(`‚ö†Ô∏è ${warning.name}: ${warning.message}`);
    });
    console.groupEnd();
  }

  console.groupEnd();
  return results;
};

// Prueba espec√≠fica de exportaci√≥n
const testExportFunctionality = () => {
  console.group('[VALIDATION] Pruebas de Exportaci√≥n');
  
  const exportTests = {
    passed: true,
    tests: []
  };

  const addExportTest = (name, testFn) => {
    try {
      const result = testFn();
      exportTests.tests.push({ name, passed: true, message: 'Prueba exitosa' });
      console.log(`‚úÖ ${name}: OK`);
      return result;
    } catch (error) {
      exportTests.tests.push({ name, passed: false, message: error.message });
      exportTests.passed = false;
      console.error(`‚ùå ${name}: ${error.message}`);
      return null;
    }
  };

  // Crear datos de prueba
  const testData = generateTestData();
  const testDerived = buildDerived(testData);

  if (!testDerived?.periodicAnalysis) {
    console.error('‚ùå No se puede probar exportaci√≥n sin datos v√°lidos');
    console.groupEnd();
    return { passed: false, tests: [] };
  }

  // Probar generaci√≥n de reportes
  addExportTest('Generaci√≥n de estad√≠sticas consolidadas', () => {
    return generateReport(testDerived, 'consolidated_statistics');
  });

  addExportTest('Generaci√≥n de reporte de bajo rendimiento', () => {
    return generateReport(testDerived, 'low_performance');
  });

  addExportTest('Generaci√≥n de reporte comparativo', () => {
    return generateReport(testDerived, 'comparative');
  });

  // Probar funciones de formato de exportaci√≥n
  addExportTest('Funci√≥n exportConsolidatedStatsToCSV', () => {
    const stats = generateReport(testDerived, 'consolidated_statistics');
    if (!stats || stats.error) throw new Error('No se pueden generar estad√≠sticas para CSV');
    // Simular exportaci√≥n sin descargar archivo
    return true;
  });

  addExportTest('Funci√≥n exportReportToExcel', () => {
    const stats = generateReport(testDerived, 'consolidated_statistics');
    if (!stats || stats.error) throw new Error('No se pueden generar estad√≠sticas para Excel');
    // Verificar que XLSX est√© disponible
    if (typeof XLSX === 'undefined') throw new Error('Biblioteca XLSX no disponible');
    return true;
  });

  addExportTest('Funci√≥n generatePDFContent', () => {
    const stats = generateReport(testDerived, 'consolidated_statistics');
    if (!stats || stats.error) throw new Error('No se pueden generar estad√≠sticas para PDF');
    const pdfContent = generatePDFContent(stats, 'consolidated_statistics');
    if (!pdfContent || pdfContent.length < 100) throw new Error('Contenido PDF muy corto');
    return true;
  });

  console.log(`\nüìä RESUMEN EXPORTACI√ìN:`);
  console.log(`‚úÖ Pruebas exitosas: ${exportTests.tests.filter(t => t.passed).length}`);
  console.log(`‚ùå Pruebas fallidas: ${exportTests.tests.filter(t => !t.passed).length}`);

  console.groupEnd();
  return exportTests;
};

// Benchmark de rendimiento
const benchmarkPerformance = (dashboardData) => {
  console.group('[BENCHMARK] Rendimiento del Sistema');
  
  const benchmarks = {};
  
  // Benchmark 1: buildDerived
  console.time('[BENCHMARK] buildDerived');
  const start1 = performance.now();
  const derived = buildDerived(dashboardData);
  const end1 = performance.now();
  console.timeEnd('[BENCHMARK] buildDerived');
  benchmarks.buildDerived = end1 - start1;

  if (!derived?.periodicAnalysis) {
    console.warn('‚ö†Ô∏è No se puede hacer benchmark sin datos v√°lidos');
    console.groupEnd();
    return benchmarks;
  }

  // Benchmark 2: Generaci√≥n de reportes
  console.time('[BENCHMARK] generateReport');
  const start2 = performance.now();
  generateReport(derived, 'consolidated_statistics');
  generateReport(derived, 'low_performance');
  generateReport(derived, 'comparative');
  const end2 = performance.now();
  console.timeEnd('[BENCHMARK] generateReport');
  benchmarks.reportGeneration = end2 - start2;

  // Benchmark 3: buildPeriodicAnalysis espec√≠ficamente
  console.time('[BENCHMARK] buildPeriodicAnalysis');
  const start3 = performance.now();
  buildPeriodicAnalysis(dashboardData);
  const end3 = performance.now();
  console.timeEnd('[BENCHMARK] buildPeriodicAnalysis');
  benchmarks.periodicAnalysis = end3 - start3;

  // Evaluaci√≥n de rendimiento
  const evalPerformance = (time, name, thresholds) => {
    if (time < thresholds.good) {
      console.log(`üü¢ ${name}: ${time.toFixed(2)}ms (Excelente)`);
    } else if (time < thresholds.acceptable) {
      console.log(`üü° ${name}: ${time.toFixed(2)}ms (Aceptable)`);
    } else {
      console.log(`üî¥ ${name}: ${time.toFixed(2)}ms (Necesita optimizaci√≥n)`);
    }
  };

  console.log('\nüìä RESULTADOS DE RENDIMIENTO:');
  evalPerformance(benchmarks.buildDerived, 'buildDerived', { good: 100, acceptable: 300 });
  evalPerformance(benchmarks.reportGeneration, 'Generaci√≥n de reportes', { good: 50, acceptable: 150 });
  evalPerformance(benchmarks.periodicAnalysis, 'buildPeriodicAnalysis', { good: 50, acceptable: 150 });

  console.groupEnd();
  return benchmarks;
};

// Funci√≥n principal de validaci√≥n que se puede llamar desde consola
window.validatePeriodicReportsSystem = (dashboardData, derived) => {
  console.clear();
  console.log('üß™ INICIANDO VALIDACI√ìN COMPLETA DEL SISTEMA DE INFORMES POR PERIODOS');
  console.log('====================================================================');
  
  const data = dashboardData || (window.app && window.app.dashboardData);
  const derivedData = derived || (window.app && window.app.derived);
  
  if (!data || !Array.isArray(data) || data.length === 0) {
    console.warn('‚ö†Ô∏è No hay datos de dashboard disponibles. Generando datos de prueba...');
    const testData = generateTestData();
    const testDerived = buildDerived(testData);
    
    console.log('üìä Datos de prueba generados:');
    console.log(`- ${testData.length} estudiantes`);
    console.log(`- ${Object.keys(testData[0].areas).length} √°reas acad√©micas`);
    console.log(`- 3 periodos (P1, P2, P3)`);
    
    const validationResults = runCompleteValidation(testDerived, testData);
    const exportResults = testExportFunctionality();
    const performanceResults = benchmarkPerformance(testData);
    
    return {
      validation: validationResults,
      export: exportResults,
      performance: performanceResults,
      testData: testData,
      testDerived: testDerived
    };
  } else {
    console.log('üìä Usando datos reales del dashboard');
    const validationResults = runCompleteValidation(derivedData, data);
    const exportResults = testExportFunctionality();
    const performanceResults = benchmarkPerformance(data);
    
    return {
      validation: validationResults,
      export: exportResults,
      performance: performanceResults
    };
  }
};

// Funci√≥n para ejecutar pruebas autom√°ticas al cargar
const runAutoValidation = () => {
  // Solo ejecutar si hay datos disponibles y estamos en modo desarrollo
  if (typeof window !== 'undefined' && window.location?.hostname === 'localhost') {
    setTimeout(() => {
      if (window.app?.dashboardData && window.app?.derived) {
        console.log('üîÑ Ejecutando validaci√≥n autom√°tica...');
        window.validatePeriodicReportsSystem();
      }
    }, 2000); // Esperar 2 segundos despu√©s de cargar
  }
};

// [RestoreJSON] lee un archivo .json y aplica estado derivado de forma segura
function restoreFromJSONFile(onData){
  const input = document.getElementById('restore-json-input');
  if (!input) return;
  input.value = '';
  input.onchange = async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    try {
      const text = await file.text();
      const data = JSON.parse(text);
      // Validaci√≥n m√≠nima de esquema
      if (!Array.isArray(data?.rowsArea) || !Array.isArray(data?.rowsAsignatura)) {
        throw new Error('Estructura inv√°lida: faltan rowsArea/rowsAsignatura');
      }
      onData(data);
      (window.showBanner || ((m)=>alert(m)))('Backup restaurado correctamente.');
    } catch (err) {
      console.error('[RestoreJSON]', err);
      (window.showBanner || ((m)=>alert(m)))('No se pudo restaurar el backup JSON.');
    }
  };
  input.click();
}

// [RestoreJSON][Nav] llevar a la vista de Dashboard de forma resiliente
function navigateToDashboard(){
  try { if (typeof setActiveTab === 'function') setActiveTab('Analisis'); } catch(_) {}
  try { if (typeof setShowUpload === 'function') setShowUpload(false); } catch(_) {}
  try { if (typeof setCurrentView === 'function') setCurrentView('Dashboard'); } catch(_) {}
  try { if (typeof setRoute === 'function') setRoute('dashboard'); } catch(_) {}
  try { if (typeof setScreen === 'function') setScreen('dashboard'); } catch(_) {}
  try { if (typeof setHasData === 'function') setHasData(true); } catch(_) {}
  try { localStorage.setItem('hasDerivedData','true'); } catch(_) {}
  // scroll al inicio por claridad
  try { window.scrollTo({top:0, behavior:'auto'}); } catch(_) {}
}

// [Debounce] util simple
function debounce(fn, wait=200){
  let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); };
}

    const normalizeName = (s) => {
      let v = toUpperSafe(s);
      v = removeDiacritics(v);
      return v.replace(/\s+/g, ' ').trim();
    }

    const normalizeAsignatura = (s) => {
      const v = normalizeName(s);
      // Corrected regex: escaped dot and word boundary
      if (/^(DEF(\.|INIT)?|DEFINITIVA|DEF AREA|AREA DEF)\b/.test(v)) return 'DEF';
      return v;
    };

    const normalizeArea = (s) => normalizeName(s);
    const normalizeComponente = (s) => {
      let v = toUpperSafe(s);
      v = removeDiacritics(v);
      v = v.replace(/\s+/g, '');
      if (/^(P1|1P|PRIMERO|PER1|PERIODO1)$/i.test(v)) return 'P1';
      if (/^(P2|2P|SEGUNDO|PER2|PERIODO2)$/i.test(v)) return 'P2';
      if (/^(P3|3P|TERCERO|PER3|PERIODO3)$/i.test(v)) return 'P3';
      if (/^(A|ACUMULADO|ACUM)$/.test(v)) return 'A';
      const defPx = v.match(/^DEF(P[123])$/);
      if (defPx) return defPx[1];
      return v || '';
    };

    // ========================================
    // (3) PARSER de encabezados (robustecido)
    // ========================================
    const profilingLogic = {
      parseHeaders: (headerRows, log) => {
        // Aseguramos que cada fila de encabezado tenga el mismo largo
        const maxLen = Math.max(...headerRows.map(r => r.length));
        const [rawAreas, rawAsignaturas, rawComponentes] = headerRows.map(row => {
          const fullRow = [...row];
          while (fullRow.length < maxLen) fullRow.push(undefined);
          return fullRow;
        });
        log.push({ level: 'info', message: `Filas de encabezado detectadas: ${headerRows.length}` });

        // 1. Forward fill en √Åreas
        for (let i = 1; i < rawAreas.length; i++) {
          if (!textNormalize(rawAreas[i])) rawAreas[i] = rawAreas[i - 1];
        }
        log.push({ level: 'info', message: `√Åreas despu√©s de forward-fill: ${JSON.stringify(rawAreas)}` });

        // 2. Forward fill contextual en Asignaturas
        for (let i = 1; i < rawAsignaturas.length; i++) {
          if (!textNormalize(rawAsignaturas[i]) && textNormalize(rawAreas[i]) === textNormalize(rawAreas[i - 1])) {
            rawAsignaturas[i] = rawAsignaturas[i - 1];
          }
        }
        log.push({ level: 'info', message: `Asignaturas despu√©s de forward-fill contextual: ${JSON.stringify(rawAsignaturas)}` });

        // 3. Relleno de Asignatura con √Årea para √°reas 1:1
        for (let i = 0; i < rawAsignaturas.length; i++) {
          if (!textNormalize(rawAsignaturas[i])) {
            rawAsignaturas[i] = rawAreas[i];
          }
        }
        log.push({ level: 'info', message: `Asignaturas despu√©s de relleno 1:1: ${JSON.stringify(rawAsignaturas)}` });

        // 4. Estructurar y normalizar, OMITIENDO las primeras dos columnas (No, Estudiante)
        let structuredHeaders = rawComponentes.map((comp, i) => ({
          index: i,
          area: normalizeArea(rawAreas[i]),
          asignatura: normalizeAsignatura(rawAsignaturas[i]),
          componente: normalizeComponente(comp),
          raw: { area: rawAreas[i], asignatura: rawAsignaturas[i], componente: comp }
        }));
        log.push({ level: 'info', message: `structuredHeaders before slice(2): ${JSON.stringify(structuredHeaders)}` });

        // Omitimos las dos primeras columnas (No, Estudiante)
        structuredHeaders = structuredHeaders.slice(2);
        log.push({ level: 'info', message: `structuredHeaders after slice(2): ${JSON.stringify(structuredHeaders)}` });

        // Filtramos solo las cabeceras v√°lidas
        structuredHeaders = structuredHeaders.filter(h => h.area && h.asignatura);
        log.push({ level: 'info', message: `structuredHeaders after filter: ${JSON.stringify(structuredHeaders)}` });

        log.push({ level: 'info', message: `Cabeceras estructuradas y normalizadas generadas.` });
        return structuredHeaders;
      },
      getCountsFromSource: (headers) => {
        console.log("getCountsFromSource: headers received:", headers); // Added log
        const areas = new Set();
        const asignaturas = new Set();
        headers.forEach(h => {
          if (h.area && h.area !== 'META') {
            areas.add(h.area);
          }
          // FIX: Contar nombres de asignaturas √∫nicas, excluyendo 'DEF' y columnas 'META'.
          if (h.asignatura && h.asignatura !== 'DEF' && h.area !== 'META') {
            asignaturas.add(h.asignatura);
          }
        });
        console.log("getCountsFromSource: unique areas:", Array.from(areas)); // Added log
        console.log("getCountsFromSource: unique asignaturas:", Array.from(asignaturas)); // Added log
        return { areaCount: areas.size, asignaturaCount: asignaturas.size };
      }
    };

    // ================================================
    // (4) Limpieza, estructura, y s√≠ntesis de DEF 1:1
    // ================================================
    const cleaningLogic = {
      normalizeText: (t) => (typeof t === 'string' ? t.trim().replace(/\s+/g, ' ') : t),
      convertToNumber: (value) => {
        if (value === null || value === undefined) return null;
        let s = String(value).trim();
        if (!s || s === '‚Äî' || s.toUpperCase() === 'NA') return null;
        const num = parseFloat(s.replace(',', '.'));
        return Number.isFinite(num) ? num : null;
      },
      structureData: (profile, log) => {
        const { tableHeaders, tableData } = profile;
        const structured = [];
        const studentNames = new Set();

        tableData.forEach((row, rowIndex) => {
          const studentName = cleaningLogic.normalizeText(row[1]);
          if (!studentName) {
            log.push({ type: 'error', message: `Fila ${rowIndex + 4}: Estudiante sin nombre. Fila omitida.` });
            return;
          }
          if (studentNames.has(studentName)) {
            log.push({ type: 'warning', message: `Estudiante duplicado: "${studentName}". Se procesar√°, pero revise duplicidad.` });
          }
          studentNames.add(studentName);

          const student = { id: cleaningLogic.normalizeText(row[0]), name: studentName, areas: {} };

          tableHeaders.forEach(h => {
            const { area, asignatura, componente, index } = h;
            if (!area || area === 'META' || !asignatura || !componente) return;
            if (!student.areas[area]) student.areas[area] = { asignaturas: {}, DEF: {} };

            let note = notaFromCell(row[index]);
            // Si hay texto no num√©rico visible
            if (row[index] !== null && String(row[index]).trim() !== '' && note === null) {
              log.push({ type: 'warning', message: `'${studentName}': Valor no num√©rico '${row[index]}' en ${area}>${asignatura}>${componente} ‚Üí nulo.` });
            }
            // Validaci√≥n de rango (BUG FIX: forzar note=null cuando est√© fuera de 0..5)
            if (note !== null && (note < 0 || note > 5)) {
              log.push({ type: 'error', message: `'${studentName}': Nota fuera de rango '${row[index]}' en ${area}>${asignatura}>${componente} ‚Üí nulo.` });
              note = null; // <-- correcci√≥n clave
            }

            // Registrar
            if (asignatura === 'DEF') {
              if (['P1','P2','P3'].includes(componente)) student.areas[area].DEF[componente] = note;
            } else {
              if (!student.areas[area].asignaturas[asignatura]) student.areas[area].asignaturas[asignatura] = {};
              if (['P1','P2','P3'].includes(componente)) student.areas[area].asignaturas[asignatura][componente] = note;
            }
          });

          // S√≠ntesis de DEF para √°reas unitarias
          Object.entries(student.areas).forEach(([areaName, areaData]) => {
            const hasExplicitDEF = Object.values(areaData.DEF).some(v => v !== null);
            if (!hasExplicitDEF) {
              const mainAsignatura = areaData.asignaturas[areaName];
              if (mainAsignatura) {
                areaData.DEF = { ...mainAsignatura };
                log.push({ type: 'info', message: `√Årea unitaria "${areaName}": DEF sintetizado desde asignatura.` });
              }
            }
          });

          structured.push(student);
        });

        return { structuredData: structured, log };
      }
    };

    // ======================================
    // (5) C√°lculos y proyecci√≥n P4 m√≠nima
    // ======================================
    const calculationLogic = {
      getStatus: (p4Min) => {
        if (p4Min === null) return { text: 'N/A', color: 'gray' };
        if (p4Min >= 5.0) return { text: 'Perdido', color: 'red' };
        if (p4Min >= 4.0) return { text: 'En riesgo', color: 'yellow' };
        if (p4Min >= 3.0) return { text: 'Recuperable', color: 'blue' };
        if (p4Min >= 1.0) return { text: 'Ganable', color: 'cyan' };
        return { text: 'Ganado', color: 'green' };
      },
      calcPromYMin: (p1, p2, p3) => {
        // [NotesZero][Paso 2] Promedio incluye 0.0 y divide por 3 fijo
        const n1 = Number.isFinite(p1) ? p1 : 0;
        const n2 = Number.isFinite(p2) ? p2 : 0;
        const n3 = Number.isFinite(p3) ? p3 : 0;
        const suma = n1 + n2 + n3;
        const promedioActual = Number(((suma) / 3).toFixed(2));
        const p4Min = Number(Math.max(0, 12 - suma).toFixed(2)); // regla vigente
        return { promedioActual, p4Min, estado: calculationLogic.getStatus(p4Min) };
      },
      performAllCalculations: (structuredData) => structuredData.map(student => {
        const out = { ...student, areas: {} };
        Object.entries(student.areas).forEach(([areaName, areaData]) => {
          // Asignaturas
          const nuevas = {};
          Object.entries(areaData.asignaturas).forEach(([asigName, asigData]) => {
            const { promedioActual, p4Min, estado } = calculationLogic.calcPromYMin(asigData.P1, asigData.P2, asigData.P3);
            nuevas[asigName] = { ...asigData, promedioActual, p4Min, estado };
          });
          // √Årea (DEF)
          const def = areaData.DEF || {};
          const areaStats = calculationLogic.calcPromYMin(def.P1, def.P2, def.P3);
          out.areas[areaName] = { ...areaData, asignaturas: nuevas, areaStats };
        });
        return out;
      })
    };

    // ======================================
    // (6.1) Importador multi-hojas por archivo
    // ======================================
    const makeCourseName = (fileBase, sheetName) => {
      const s = String(sheetName || '').trim();
      return s ? `${fileBase} - ${s}` : fileBase;
    };

    const ensureUniqueName = (existingCourses, desired) => {
      const exists = (name) => existingCourses.some(c => c.name === name);
      if (!exists(desired)) return desired;
      let i = 2;
      while (exists(`${desired} (${i})`)) i++;
      return `${desired} (${i})`;
    };

    const importWorkbookToProfiles = (wb, fileName) => {
      const out = [];
      const fileBase = String(fileName || '').replace(/\.(xlsx|xls|csv)$/i, '');
      (wb.SheetNames || []).forEach((sheetName) => {
        try {
          const ws = wb.Sheets[sheetName];
          if (!ws) return;
          const data = XLSX.utils.sheet_to_json(ws, { header: 1, blankrows: false });
          if (!data || data.length < 4) return; // 3 header rows + data

          // Normalizar las 3 filas de encabezados al mismo largo
          const maxCols = Math.max(...data.slice(0,3).map(r => r.length));
          const headerRows = data.slice(0,3).map(row => {
            const full = [...row];
            while (full.length < maxCols) full.push(undefined);
            return full;
          });
          const tableData = data.slice(3);

          out.push({ fileName, sheetName, headerRows, tableData, courseBase: fileBase });
        } catch (e) {
          console.warn('Hoja omitida por error:', sheetName, e);
        }
      });
      return out;
    };

    // ======================================
    // (6) Componentes de Interfaz
    // ======================================
// [NotesZero][Paso 3] Render estable para notas
function formatNota(n){
  return Number.isFinite(n) ? n.toFixed(2) : '-';
}

    const StatusBadge = ({ status }) => {
      const color = {
        red: 'bg-red-200 text-red-900 border border-red-400',
        yellow: 'bg-yellow-100 text-yellow-900 border border-yellow-400',
        blue: 'bg-blue-100 text-blue-900 border border-blue-400',
        cyan: 'bg-cyan-100 text-cyan-900 border border-cyan-400',
        green: 'bg-green-100 text-green-900 border border-green-400',
        gray: 'bg-gray-100 text-gray-800 border border-gray-300'
      }[status.color] || 'bg-gray-100 text-gray-800 border border-gray-300';
      const icon = {
        red: <AlertTriangleIcon className="inline w-4 h-4 mr-1" />,
        yellow: <InfoIcon className="inline w-4 h-4 mr-1" />,
        blue: <BarChartIcon className="inline w-4 h-4 mr-1" />,
        cyan: <CheckCircleIcon className="inline w-4 h-4 mr-1" />,
        green: <CheckCircleIcon className="inline w-4 h-4 mr-1" />,
        gray: <InfoIcon className="inline w-4 h-4 mr-1" />
      }[status.color] || null;
      return <span className={`px-2 inline-flex items-center text-xs leading-5 font-semibold rounded-full ${color}`}>{icon}{status.text}</span>;
    };

        const UploadView = ({ onWorkbookProcessed, onRestore, onLoading }) => {
          const safeLoading = {
            start: (msg) => { try { onLoading?.start?.(msg); } catch {} },
            update: (msg) => { try { onLoading?.update?.(msg); } catch {} },
            stop: () => { try { onLoading?.stop?.(); } catch {} },
          };
          const [pendingFile, setPendingFile] = useState(null);
          const [isDragging, setIsDragging] = useState(false);
          const inputRef = useRef(null);
          const [overlayVisible, setOverlayVisible] = useState(false);
          // [OverlayPhase] estado de fase de procesamiento
          const [processingPhase, setProcessingPhase] = useState('');
    
          // [FileValidation] Validaci√≥n robusta de archivos
          const validateFile = (file) => {
            const MAX_SIZE = 15 * 1024 * 1024; // 15MB l√≠mite razonable
            const ALLOWED_TYPES = [
              'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx
              'application/vnd.ms-excel', // .xls
              'text/csv',
              'application/csv',
              'text/plain' // algunos CSV llegan como text/plain
            ];
            const ALLOWED_EXTENSIONS = ['.xlsx', '.xls', '.csv'];
            
            // Validar tama√±o
            if (file.size > MAX_SIZE) {
              throw new Error(`Archivo demasiado grande (${(file.size/1024/1024).toFixed(1)}MB). M√°ximo permitido: 15MB`);
            }
            
            // Validar extensi√≥n (m√°s confiable que MIME type)
            const ext = file.name.toLowerCase().match(/\.[^.]+$/)?.[0];
            if (!ALLOWED_EXTENSIONS.includes(ext)) {
              throw new Error(`Tipo de archivo no soportado: ${ext || 'sin extensi√≥n'}. Use: .xlsx, .xls o .csv`);
            }
            
            // Validar MIME type si est√° disponible (algunos browsers no lo detectan bien)
            if (file.type && !ALLOWED_TYPES.includes(file.type) && !file.type.includes('sheet') && !file.type.includes('excel') && !file.type.includes('csv')) {
              console.warn(`MIME type no reconocido: ${file.type}, pero extensi√≥n v√°lida: ${ext}`);
            }
            
            return true;
          };

          const handleSelected = (flist) => {
            if (!flist || flist.length === 0) return;
            const f = flist[0];
            
            try {
              // [FileValidation] Validar archivo antes de aceptarlo
              validateFile(f);
              setPendingFile(f);
              if (inputRef.current) inputRef.current.value = '';
            } catch (error) {
              // Mostrar error al usuario de forma amigable
              const showError = window.showBanner || alert;
              showError(`‚ùå ${error.message}`);
              
              // Limpiar input para permitir reselecci√≥n
              if (inputRef.current) inputRef.current.value = '';
              setPendingFile(null);
              
              // Log para desarrollo
              if (window.__DASH_DEV__) {
                console.error('[FileValidation]', error, { fileName: f.name, size: f.size, type: f.type });
              }
            }
          };
    
          const handleProcessClick = async () => {
            if (!pendingFile) return;
    
            setProcessingPhase('');
            setOverlayVisible(true);
            await new Promise(resolve => requestAnimationFrame(resolve));
    
            const f = pendingFile;
            const reader = new FileReader();
    
            reader.onload = (e) => {
              // [SafeProcess] manejo robusto de errores y cierre de overlay
              try {
                // [OverlayPhase] secuencia de fases
                setProcessingPhase?.('Importando‚Ä¶');
                const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
    
                if (!wb.SheetNames || wb.SheetNames.length === 0) {
                  setProcessingPhase('Error: El archivo no contiene hojas.');
                  setTimeout(() => setOverlayVisible(false), 2000);
                  setPendingFile(null);
                  return;
                }
                
                setProcessingPhase?.('Analizando‚Ä¶');
                const profiles = importWorkbookToProfiles(wb, f.name);
    
                if (profiles.length === 0) {
                  setProcessingPhase('Error: Estructura inv√°lida.');
                  setTimeout(() => setOverlayVisible(false), 2000);
                  setPendingFile(null);
                  return;
                }
                
                setProcessingPhase?.('Consolidando‚Ä¶');
                onWorkbookProcessed(profiles);
              } catch (err) {
                console.error('[Procesar] Error durante el procesamiento:', err);
                // muestra banner no intrusivo (reusa ResourceGuard si lo tienes)
                (window.showBanner || ((m)=>alert(m)))('Ocurri√≥ un error procesando el archivo. Revisa el formato y vuelve a intentar.');
              } finally {
                setProcessingPhase?.('');
                // oculta overlay de forma segura (ajusta a tu API actual)
                setOverlayVisible?.(false);
              }
            };
    
            reader.onerror = () => {
              setProcessingPhase('Error al leer el archivo.');
              setTimeout(() => setOverlayVisible(false), 2000);
              setPendingFile(null);
            };
    
            reader.readAsArrayBuffer(f);
          };
    
          const handleDrop = (e) => { e.preventDefault(); e.stopPropagation(); setIsDragging(false); handleSelected(e.dataTransfer.files); };
          const handleDrag = (e) => { e.preventDefault(); e.stopPropagation(); setIsDragging(e.type === 'dragenter' || e.type === 'dragover'); };
    
          return (
            <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-gray-50 dark:bg-gray-900 transition-colors">
              <div className="w-full max-w-3xl">
                <h1 className="text-3xl font-bold text-center text-gray-900 dark:text-white">Dashboard Acad√©mico</h1>
                <p className="text-center text-gray-600 dark:text-gray-300 mb-6">Sube un archivo de Excel para analizar las notas (soporte multi-hojas).</p>
                <div className="space-y-4">
                  <div
                    onDrop={handleDrop}
                    onDragEnter={handleDrag}
                    onDragOver={handleDrag}
                    onDragLeave={handleDrag}
                    className={`relative flex flex-col items-center justify-center w-full p-10 border-2 border-dashed rounded-xl cursor-pointer transition ${isDragging ? 'border-blue-500 bg-blue-50' : 'border-gray-300 bg-white hover:border-gray-400'}`}
                    onClick={() => inputRef.current?.click()}
                  >
                    <div className="flex flex-col items-center gap-2">
                      <div className="w-10 h-10 rounded-full border-2 border-gray-300 flex items-center justify-center">
                        <span className="text-sm font-mono">XLSX</span>
                      </div>
                      <p className="font-semibold text-gray-800">Arrastra y suelta un archivo aqu√≠</p>
                      <p className="text-sm text-gray-500">o</p>
                      <button
                        type="button"
                        className="mt-1 inline-flex items-center px-4 py-2 rounded-md text-white bg-blue-600 hover:bg-blue-700"
                      >
                        Seleccionar archivo
                      </button>
                      <p className="text-xs text-gray-500 mt-2">Cada hoja se importar√° como curso.</p>
                    </div>
    
                    {/* input real */}
                    <input
                      ref={inputRef}
                      type="file"
                      className="hidden"
                      onChange={(e)=>handleSelected(e.target.files)}
                      accept=".xlsx,.xls,.csv"
                      aria-label="Seleccionar archivo Excel o CSV para importar cursos"
                    />
                  </div>
                  {pendingFile && (
                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 flex items-center justify-between">
                      <div>
                        <p className="text-sm font-medium text-blue-800">Archivo seleccionado:</p>
                        <p className="text-sm text-blue-700">{pendingFile.name}</p>
                      </div>
                      <button
                        onClick={handleProcessClick}
                        className="px-4 py-2 rounded-md text-white bg-green-600 hover:bg-green-700"
                      >
                        Procesar archivo
                      </button>
                    </div>
                  )}
                </div>
                <div className="mt-4 text-center">
                    {/* [RestoreJSON][Inicio] bot√≥n en pantalla inicial */}
                    <button
                      className="mt-2 px-3 py-1.5 rounded-md border border-gray-300 text-sm"
                      onClick={() => restoreFromJSONFile(onRestore)}
                    >
                      Restaurar backup (.json)
                    </button>
                </div>
               </div>          {overlayVisible && (
            <div className="fixed inset-0 z-50 bg-white/70 backdrop-blur-sm flex items-center justify-center" role="status" aria-live="assertive">
              <div className="flex flex-col items-center">
                <div className="animate-spin h-10 w-10 rounded-full border-4 border-blue-300 border-t-blue-600"></div>
                {/* [OverlayPhase] texto din√°mico */}
                <div aria-live="polite" className="mt-3 font-semibold text-blue-800">
                  {processingPhase || 'Preparando‚Ä¶'}
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    const ValidationReportView = ({ report, onReset, onConfirm }) => {
      const { fileName, qualityIssues } = report;
      const errorCount = qualityIssues.filter(i => i.type === 'error').length;
      return (
        <div className="max-w-7xl mx-auto px-6 py-8">
          <div className="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
            <div>
              <h1 className="text-2xl font-bold">Reporte de Calidad de Datos</h1>
              <p className="text-gray-600">Archivo: <span className="font-semibold text-blue-600">{fileName}</span></p>
            </div>
            <div className="mt-4 md:mt-0 space-x-2">
              <button onClick={onReset} className="px-4 py-2 rounded-md border">Cargar otro</button>
              <button onClick={onConfirm} disabled={errorCount>0} className={`px-4 py-2 rounded-md text-white ${errorCount>0?'bg-gray-400 cursor-not-allowed':'bg-green-600 hover:bg-green-700'}`}>{errorCount>0?'Corrija errores':'Continuar'}</button>
            </div>
          </div>

          <div className="bg-white border border-gray-200 rounded-xl p-5">
            <h2 className="text-lg font-semibold mb-2">Log de incidencias</h2>
            {qualityIssues.length===0 ? (
              <div className="flex items-center p-4 rounded-md bg-green-50 text-green-800"><CheckCircleIcon className="w-5 h-5 mr-2"/><p>Sin problemas de calidad.</p></div>
            ) : (
              <div className="space-y-2 max-h-[50vh] overflow-auto">
                {qualityIssues.map((i,idx)=> (
                  <div key={idx} className={`p-3 rounded-md border text-sm ${i.type==='error'?'bg-red-50 border-red-200 text-red-800':'bg-yellow-50 border-yellow-200 text-yellow-800'}`}>
                    {i.type==='error' ? <AlertTriangleIcon className="inline w-4 h-4 mr-1"/> : <InfoIcon className="inline w-4 h-4 mr-1"/>}
                    {i.message}
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      );
    };

    function DebouncedInput({ value: propValue, onChange, wait = 300, ...props }) {
      const [localValue, setLocalValue] = useState(propValue);

      const debouncedOnChange = useMemo(
        () => debounce(onChange, wait),
        [onChange, wait]
      );

      useEffect(() => {
        // Sincroniza el valor local si el valor de la prop cambia desde fuera
        // (ej. al limpiar filtros)
        if (propValue !== localValue) {
          setLocalValue(propValue);
        }
      }, [propValue]);

      const handleChange = (e) => {
        const newValue = e.target.value;
        setLocalValue(newValue);
        debouncedOnChange(newValue);
      };

      return <input {...props} value={localValue} onChange={handleChange} />;
    }

    const ReconciliationView = ({ report, onConfirm, onBack, acceptChecks }) => {
      const { sourceCounts, processedCounts, log, fileName } = report;
      const areaDiff = processedCounts.areaCount - sourceCounts.areaCount;
      const asigDiff = processedCounts.asignaturaCount - sourceCounts.asignaturaCount;

      return (
        <div className="max-w-7xl mx-auto px-6 py-8">
          <div className="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
            <div>
              <h1 className="text-2xl font-bold">Reporte de Reconciliaci√≥n</h1>
              <p className="text-gray-600">Verificaci√≥n de integridad: <span className="font-semibold text-blue-600">{fileName}</span></p>
            </div>
            <div className="mt-4 md:mt-0 space-x-2">
              <button onClick={onBack} className="px-4 py-2 rounded-md border">Volver</button>
              <button onClick={onConfirm} className="px-4 py-2 rounded-md text-white bg-green-600 hover:bg-green-700">Continuar al Dashboard</button>
            </div>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div className="bg-white border border-gray-200 rounded-xl p-5">
              <h2 className="text-lg font-semibold mb-2 flex items-center"><DatabaseIcon className="w-5 h-5 mr-2 text-blue-600"/>Conteo</h2>
              <dl className="text-sm space-y-3">
                <div>
                  <dt className="text-gray-500">√Åreas √∫nicas</dt>
                  <dd className="flex items-baseline justify-between"><span className="text-2xl font-semibold">{processedCounts.areaCount} <span className="text-sm">de</span> {sourceCounts.areaCount}</span><span className={`px-2 py-1 text-xs font-bold rounded-full ${areaDiff===0?'bg-green-100 text-green-800':'bg-red-100 text-red-800'}`}>{areaDiff===0?'OK':areaDiff}</span></dd>
                </div>
                <div>
                  <dt className="text-gray-500">Asignaturas √∫nicas</dt>
                  <dd className="flex items-baseline justify-between"><span className="text-2xl font-semibold">{processedCounts.asignaturaCount} <span className="text-sm">de</span> {sourceCounts.asignaturaCount}</span><span className={`px-2 py-1 text-xs font-bold rounded-full ${asigDiff===0?'bg-green-100 text-green-800':'bg-red-100 text-red-800'}`}>{asigDiff===0?'OK':asigDiff}</span></dd>
                </div>
                <div>
                  <dt className="text-gray-500">Estudiantes</dt>
                  <dd className="text-2xl font-semibold">{processedCounts.studentCount}</dd>
                </div>
              </dl>
            </div>

            <div className="lg:col-span-2 bg-white border border-gray-200 rounded-xl p-5">
              <h2 className="text-lg font-semibold mb-2">Log de procesamiento</h2>
              {log.length===0 ? (
                <div className="flex items-center p-4 rounded-md bg-green-50 text-green-800"><CheckCircleIcon className="w-5 h-5 mr-2"/><p>Sin incidencias.</p></div>
              ) : (
                <div className="space-y-2 max-h-[50vh] overflow-auto">
                  {log.map((i,idx)=> (
                    <div key={idx} className={`p-3 rounded-md border text-sm ${i.type==='error'?'bg-red-50 border-red-200 text-red-800':'bg-yellow-50 border-yellow-200 text-yellow-800'}`}>
                      {i.type==='error' ? <AlertTriangleIcon className="inline w-4 h-4 mr-1"/> : <InfoIcon className="inline w-4 h-4 mr-1"/>}
                      {i.message}
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>

          {/* (6) Validaci√≥n contra criterios de aceptaci√≥n */}
          <div className="mt-6 bg-white border border-gray-200 rounded-xl p-5">
            <h2 className="text-lg font-semibold mb-3">Validaci√≥n (Criterios de Aceptaci√≥n)</h2>
            <ul className="text-sm space-y-2">
              <li>1. Propagaci√≥n <em>DEF</em> a P1/P2/P3: <span className={`px-2 py-1 rounded ${acceptChecks.defPropagation? 'bg-green-100 text-green-800':'bg-red-100 text-red-800'}`}>{acceptChecks.defPropagation? 'OK':'FALTA'}</span></li>
              <li>2. √Åreas 1:1 visibles (ej. INGL√âS, INFORM√ÅTICA): <span className={`px-2 py-1 rounded ${acceptChecks.singleArea? 'bg-green-100 text-green-800':'bg-red-100 text-red-800'}`}>{acceptChecks.singleArea? 'OK':'FALTA'}</span></li>
              <li>3. Integridad de render (sin secciones omitidas): <span className={`px-2 py-1 rounded ${acceptChecks.renderOK? 'bg-green-100 text-green-800':'bg-red-100 text-red-800'}`}>{acceptChecks.renderOK? 'OK':'FALTA'}</span></li>
            </ul>
          </div>
        </div>
      );
    };

    // ======================================
    // [FASE 4] Componente Informes por Periodos - Nueva pesta√±a
    // ======================================
    const InformesView = React.memo(({ dashboardData, derived, filters }) => {
      console.time('render:InformesView');
      
      // Estados para la interfaz de informes
      const [reportType, setReportType] = useState('consolidated_statistics');
      const [selectedPeriod, setSelectedPeriod] = useState('P1');
      const [selectedStudent, setSelectedStudent] = useState('');
      const [courseFilter, setCourseFilter] = useState('ALL');
      const [comparisonType, setComparisonType] = useState('sequential');
      const [currentReport, setCurrentReport] = useState(null);
      const [isGeneratingReport, setIsGeneratingReport] = useState(false);
      const [progressInfo, setProgressInfo] = useState({ step: '', percentage: 0 });
      const [lastGeneratedTime, setLastGeneratedTime] = useState(null);
      const [reportGenerationStats, setReportGenerationStats] = useState(null);
      const [showDiagnostics, setShowDiagnostics] = useState(false);
      const [diagnosticResults, setDiagnosticResults] = useState(null);

      // Opciones disponibles para estudiantes
      const studentOptions = useMemo(() => {
        if (!Array.isArray(dashboardData)) return [];
        const uniqueStudents = [...new Set(dashboardData.map(s => s.name))].sort();
        return uniqueStudents;
      }, [dashboardData]);

      // Opciones disponibles para cursos
      const courseOptions = useMemo(() => {
        if (!Array.isArray(dashboardData)) return ['ALL'];
        const uniqueCourses = [...new Set(dashboardData.map(s => s.CURSO || s.__course).filter(Boolean))].sort();
        return ['ALL', ...uniqueCourses];
      }, [dashboardData]);

      // Periodos disponibles basados en el an√°lisis
      const availablePeriods = useMemo(() => {
        if (!derived?.periodicAnalysis?.availablePeriods) return ['P1', 'P2', 'P3', 'P4'];
        return derived.periodicAnalysis.availablePeriods;
      }, [derived]);

      // Funci√≥n para generar informes con indicadores de progreso
      const handleGenerateReport = useCallback(async () => {
        if (!derived) return;
        
        const startTime = performance.now();
        setIsGeneratingReport(true);
        setProgressInfo({ step: 'Iniciando generaci√≥n de reporte...', percentage: 0 });
        
        try {
          // Paso 1: Preparar opciones
          setProgressInfo({ step: 'Configurando par√°metros del reporte...', percentage: 20 });
          await new Promise(resolve => setTimeout(resolve, 100)); // Permitir actualizaci√≥n de UI
          
          const options = {};
          
          // Configurar opciones seg√∫n el tipo de reporte
          switch (reportType) {
            case 'student_performance':
              if (selectedStudent) {
                options.studentId = dashboardData.find(s => s.name === selectedStudent)?.id;
              }
              break;
            case 'low_performance':
              if (courseFilter !== 'ALL') {
                options.courseFilter = courseFilter;
              }
              break;
            case 'comparative':
              options.comparisonType = comparisonType;
              break;
          }

          // Paso 2: Generar reporte
          setProgressInfo({ step: 'Procesando datos y generando an√°lisis...', percentage: 40 });
          await new Promise(resolve => setTimeout(resolve, 150));
          
          const report = generateReport(derived, reportType, options);
          
          // Paso 3: Finalizar
          setProgressInfo({ step: 'Finalizando reporte...', percentage: 80 });
          await new Promise(resolve => setTimeout(resolve, 100));
          
          setCurrentReport(report);
          
          // Estad√≠sticas de generaci√≥n
          const endTime = performance.now();
          const generationTime = Math.round(endTime - startTime);
          const now = new Date();
          
          setLastGeneratedTime(now.toLocaleString());
          setReportGenerationStats({
            generationTime,
            reportType,
            dataPoints: Array.isArray(dashboardData) ? dashboardData.length : 0,
            timestamp: now.toISOString()
          });
          
          setProgressInfo({ step: 'Reporte generado exitosamente', percentage: 100 });
          
        } catch (error) {
          console.error('Error generando reporte:', error);
          setCurrentReport({ error: 'Error generando el reporte: ' + error.message });
          setProgressInfo({ step: 'Error en la generaci√≥n', percentage: 0 });
        } finally {
          // Breve pausa para mostrar el 100% antes de ocultar
          setTimeout(() => {
            setIsGeneratingReport(false);
            setProgressInfo({ step: '', percentage: 0 });
          }, 500);
        }
      }, [reportType, selectedStudent, courseFilter, comparisonType, derived, dashboardData]);

      // Auto-generar estad√≠sticas consolidadas al cargar
      useEffect(() => {
        if (derived && reportType === 'consolidated_statistics') {
          handleGenerateReport();
        }
      }, [derived, reportType, handleGenerateReport]);

      // Funci√≥n para ejecutar diagn√≥sticos del sistema
      const runDiagnostics = useCallback(async () => {
        setIsGeneratingReport(true);
        try {
          console.log('üß™ Iniciando diagn√≥sticos del sistema...');
          const results = window.validatePeriodicReportsSystem(dashboardData, derived);
          setDiagnosticResults(results);
          console.log('‚úÖ Diagn√≥sticos completados');
        } catch (error) {
          console.error('‚ùå Error en diagn√≥sticos:', error);
          setDiagnosticResults({ error: error.message });
        } finally {
          setIsGeneratingReport(false);
        }
      }, [dashboardData, derived]);

      useEffect(() => {
        console.timeEnd('render:InformesView');
      });

      // Renderizar resumen de estad√≠sticas consolidadas
      const renderConsolidatedStats = (stats) => {
        if (!stats || stats.error) {
          return <div className="text-red-600">Error: {stats?.error || 'Sin datos disponibles'}</div>;
        }

        return (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {/* Resumen General */}
            <div className="bg-white border border-gray-200 rounded-xl p-5">
              <h3 className="font-bold text-lg mb-4 text-gray-800">üìä Resumen General</h3>
              <div className="space-y-3">
                <div className="flex justify-between">
                  <span className="text-gray-600">Periodos Disponibles:</span>
                  <span className="font-semibold">{stats.overview.totalPeriods}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-600">Total Estudiantes:</span>
                  <span className="font-semibold">{stats.overview.totalStudents}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-600">Total Materias:</span>
                  <span className="font-semibold">{stats.overview.totalSubjects}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-600">Promedio General:</span>
                  <span className={`font-semibold ${stats.overview.overallAverageGrade >= 3.0 ? 'text-green-600' : 'text-red-600'}`}>
                    {formatGradeForReport(stats.overview.overallAverageGrade)}
                  </span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-600">Bajo Rendimiento:</span>
                  <span className={`font-semibold ${stats.overview.overallLowPerformanceRate > 25 ? 'text-red-600' : 'text-yellow-600'}`}>
                    {formatPercentageForReport(stats.overview.overallLowPerformanceRate)}
                  </span>
                </div>
              </div>
            </div>

            {/* Comparaci√≥n por Periodo */}
            <div className="bg-white border border-gray-200 rounded-xl p-5">
              <h3 className="font-bold text-lg mb-4 text-gray-800">üìà Por Periodo</h3>
              <div className="space-y-3">
                {Object.entries(stats.periodComparison).map(([period, data]) => (
                  <div key={period} className="border-b border-gray-100 pb-2">
                    <div className="flex justify-between items-center">
                      <span className="font-medium text-gray-700">{period}</span>
                      <div className="text-right">
                        <div className="text-sm font-semibold">{formatGradeForReport(data.averageGrade)}</div>
                        <div className={`text-xs ${data.approvalRate >= 70 ? 'text-green-600' : 'text-red-600'}`}>
                          {formatPercentageForReport(data.approvalRate)} aprobaci√≥n
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {/* Tendencias */}
            <div className="bg-white border border-gray-200 rounded-xl p-5">
              <h3 className="font-bold text-lg mb-4 text-gray-800">üìä Tendencias</h3>
              <div className="space-y-3">
                <div className="flex justify-between">
                  <span className="text-green-600">‚Üó Mejorando:</span>
                  <span className="font-semibold">{stats.trends.improving}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-red-600">‚Üò Declinando:</span>
                  <span className="font-semibold">{stats.trends.declining}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-gray-600">‚Üí Estable:</span>
                  <span className="font-semibold">{stats.trends.stable}</span>
                </div>
              </div>
            </div>

            {/* Alertas */}
            {stats.alerts && stats.alerts.length > 0 && (
              <div className="md:col-span-2 lg:col-span-3 bg-orange-50 border border-orange-200 rounded-xl p-5">
                <h3 className="font-bold text-lg mb-4 text-orange-800">üö® Alertas Autom√°ticas</h3>
                <div className="space-y-3">
                  {stats.alerts.map((alert, index) => (
                    <div key={index} className={`p-3 rounded-lg border-l-4 ${
                      alert.type === 'critical' ? 'bg-red-50 border-red-500' : 
                      alert.type === 'warning' ? 'bg-yellow-50 border-yellow-500' : 
                      'bg-blue-50 border-blue-500'
                    }`}>
                      <h4 className="font-semibold text-gray-800">{alert.title}</h4>
                      <p className="text-sm text-gray-600 mt-1">{alert.message}</p>
                      <p className="text-xs text-gray-500 mt-2 italic">{alert.recommendation}</p>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        );
      };

      // Renderizar reporte de bajo rendimiento
      const renderLowPerformanceReport = (report) => {
        if (!report || report.error) {
          return <div className="text-red-600">Error: {report?.error || 'Sin datos disponibles'}</div>;
        }

        return (
          <div className="space-y-6">
            {Object.entries(report.summary).map(([period, data]) => (
              <div key={period} className="bg-white border border-gray-200 rounded-xl p-5">
                <h3 className="font-bold text-lg mb-4 text-gray-800">üìã Bajo Rendimiento - {period}</h3>
                
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                  <div className="text-center p-3 bg-red-50 rounded-lg">
                    <div className="text-2xl font-bold text-red-600">{data.totalStudentsAffected}</div>
                    <div className="text-sm text-gray-600">Estudiantes Afectados</div>
                  </div>
                  <div className="text-center p-3 bg-orange-50 rounded-lg">
                    <div className="text-2xl font-bold text-orange-600">{data.totalSubjectsAffected}</div>
                    <div className="text-sm text-gray-600">Materias Afectadas</div>
                  </div>
                  <div className="text-center p-3 bg-yellow-50 rounded-lg">
                    <div className="text-2xl font-bold text-yellow-600">{formatGradeForReport(data.averageGrade)}</div>
                    <div className="text-sm text-gray-600">Promedio</div>
                  </div>
                </div>

                {data.studentDetails.length > 0 && (
                  <div className="overflow-x-auto">
                    <table className="min-w-full border border-gray-300">
                      <thead className="bg-gray-100">
                        <tr>
                          <th className="border border-gray-300 px-3 py-2 text-left">Estudiante</th>
                          <th className="border border-gray-300 px-3 py-2 text-left">Curso</th>
                          <th className="border border-gray-300 px-3 py-2 text-left">Materias Afectadas</th>
                        </tr>
                      </thead>
                      <tbody>
                        {data.studentDetails.slice(0, 10).map((student, index) => (
                          <tr key={index} className="hover:bg-gray-50">
                            <td className="border border-gray-300 px-3 py-2">{student.student}</td>
                            <td className="border border-gray-300 px-3 py-2">{student.course}</td>
                            <td className="border border-gray-300 px-3 py-2">
                              <div className="text-sm">
                                {student.subjects.slice(0, 3).map((subj, i) => (
                                  <div key={i}>{subj.subject} ({formatGradeForReport(subj.grade)})</div>
                                ))}
                                {student.subjects.length > 3 && (
                                  <div className="text-gray-500">... y {student.subjects.length - 3} m√°s</div>
                                )}
                              </div>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
            ))}

            {/* Recomendaciones */}
            {report.recommendations && report.recommendations.length > 0 && (
              <div className="bg-blue-50 border border-blue-200 rounded-xl p-5">
                <h3 className="font-bold text-lg mb-4 text-blue-800">üí° Recomendaciones</h3>
                <div className="space-y-4">
                  {report.recommendations.map((rec, index) => (
                    <div key={index} className="bg-white p-4 rounded-lg border border-blue-100">
                      <h4 className="font-semibold text-gray-800 mb-2">{rec.title}</h4>
                      <p className="text-sm text-gray-600 mb-3">{rec.description}</p>
                      <ul className="text-sm text-gray-700">
                        {rec.actionItems.map((item, i) => (
                          <li key={i} className="flex items-start">
                            <span className="text-blue-500 mr-2">‚Ä¢</span>
                            {item}
                          </li>
                        ))}
                      </ul>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        );
      };

      // Renderizar reporte comparativo
      const renderComparativeReport = (report) => {
        if (!report || report.error) {
          return <div className="text-red-600">Error: {report?.error || 'Sin datos disponibles'}</div>;
        }

        return (
          <div className="space-y-6">
            {report.comparisons.map((comparison, index) => (
              <div key={index} className="bg-white border border-gray-200 rounded-xl p-5">
                <h3 className="font-bold text-lg mb-4 text-gray-800">
                  üìä {comparison.period1} vs {comparison.period2}
                </h3>
                
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                  <div className="text-center p-3 bg-green-50 rounded-lg">
                    <div className="text-2xl font-bold text-green-600">{comparison.statistics.improvementCount}</div>
                    <div className="text-sm text-gray-600">Mejoras</div>
                  </div>
                  <div className="text-center p-3 bg-red-50 rounded-lg">
                    <div className="text-2xl font-bold text-red-600">{comparison.statistics.declineCount}</div>
                    <div className="text-sm text-gray-600">Declives</div>
                  </div>
                  <div className="text-center p-3 bg-gray-50 rounded-lg">
                    <div className="text-2xl font-bold text-gray-600">{comparison.statistics.stableCount}</div>
                    <div className="text-sm text-gray-600">Estables</div>
                  </div>
                  <div className="text-center p-3 bg-blue-50 rounded-lg">
                    <div className="text-2xl font-bold text-blue-600">{formatGradeForReport(comparison.statistics.averageChange)}</div>
                    <div className="text-sm text-gray-600">Cambio Promedio</div>
                  </div>
                </div>

                {/* Top Mejoras */}
                {comparison.improvements.length > 0 && (
                  <div className="mb-4">
                    <h4 className="font-semibold text-green-700 mb-2">üéØ Principales Mejoras</h4>
                    <div className="overflow-x-auto">
                      <table className="min-w-full border border-gray-300 text-sm">
                        <thead className="bg-green-50">
                          <tr>
                            <th className="border border-gray-300 px-2 py-1 text-left">Estudiante</th>
                            <th className="border border-gray-300 px-2 py-1 text-left">Materia</th>
                            <th className="border border-gray-300 px-2 py-1 text-center">{comparison.period1}</th>
                            <th className="border border-gray-300 px-2 py-1 text-center">{comparison.period2}</th>
                            <th className="border border-gray-300 px-2 py-1 text-center">Cambio</th>
                          </tr>
                        </thead>
                        <tbody>
                          {comparison.improvements.slice(0, 5).map((item, i) => (
                            <tr key={i} className="hover:bg-green-25">
                              <td className="border border-gray-300 px-2 py-1">{item.student}</td>
                              <td className="border border-gray-300 px-2 py-1">{item.subject}</td>
                              <td className="border border-gray-300 px-2 py-1 text-center">{formatGradeForReport(item.period1Grade)}</td>
                              <td className="border border-gray-300 px-2 py-1 text-center">{formatGradeForReport(item.period2Grade)}</td>
                              <td className="border border-gray-300 px-2 py-1 text-center text-green-600 font-semibold">+{formatGradeForReport(item.change)}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}

                {/* Top Declives */}
                {comparison.declines.length > 0 && (
                  <div>
                    <h4 className="font-semibold text-red-700 mb-2">‚ö†Ô∏è Principales Declives</h4>
                    <div className="overflow-x-auto">
                      <table className="min-w-full border border-gray-300 text-sm">
                        <thead className="bg-red-50">
                          <tr>
                            <th className="border border-gray-300 px-2 py-1 text-left">Estudiante</th>
                            <th className="border border-gray-300 px-2 py-1 text-left">Materia</th>
                            <th className="border border-gray-300 px-2 py-1 text-center">{comparison.period1}</th>
                            <th className="border border-gray-300 px-2 py-1 text-center">{comparison.period2}</th>
                            <th className="border border-gray-300 px-2 py-1 text-center">Cambio</th>
                          </tr>
                        </thead>
                        <tbody>
                          {comparison.declines.slice(0, 5).map((item, i) => (
                            <tr key={i} className="hover:bg-red-25">
                              <td className="border border-gray-300 px-2 py-1">{item.student}</td>
                              <td className="border border-gray-300 px-2 py-1">{item.subject}</td>
                              <td className="border border-gray-300 px-2 py-1 text-center">{formatGradeForReport(item.period1Grade)}</td>
                              <td className="border border-gray-300 px-2 py-1 text-center">{formatGradeForReport(item.period2Grade)}</td>
                              <td className="border border-gray-300 px-2 py-1 text-center text-red-600 font-semibold">{formatGradeForReport(item.change)}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}
              </div>
            ))}
          </div>
        );
      };

      return (
        <div className="space-y-6">
          {/* Panel de Control */}
          <div className="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-6">
            <h2 className="text-2xl font-bold text-gray-800 mb-6">üìä Sistema de Informes por Periodos</h2>
            
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
              {/* Tipo de Reporte */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Tipo de Reporte</label>
                <select 
                  value={reportType} 
                  onChange={(e) => setReportType(e.target.value)}
                  className="w-full p-2 border border-gray-300 rounded-md text-sm"
                >
                  <option value="consolidated_statistics">üìà Estad√≠sticas Consolidadas</option>
                  <option value="student_performance">üë§ Rendimiento por Estudiante</option>
                  <option value="low_performance">‚ö†Ô∏è Bajo Rendimiento</option>
                  <option value="comparative">üîÑ Comparativo entre Periodos</option>
                </select>
              </div>

              {/* Filtro por Estudiante (solo para reporte de estudiante) */}
              {reportType === 'student_performance' && (
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Estudiante</label>
                  <select 
                    value={selectedStudent} 
                    onChange={(e) => setSelectedStudent(e.target.value)}
                    className="w-full p-2 border border-gray-300 rounded-md text-sm"
                  >
                    <option value="">Todos los estudiantes</option>
                    {studentOptions.map(student => (
                      <option key={student} value={student}>{student}</option>
                    ))}
                  </select>
                </div>
              )}

              {/* Filtro por Curso */}
              {reportType === 'low_performance' && (
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Curso</label>
                  <select 
                    value={courseFilter} 
                    onChange={(e) => setCourseFilter(e.target.value)}
                    className="w-full p-2 border border-gray-300 rounded-md text-sm"
                  >
                    {courseOptions.map(course => (
                      <option key={course} value={course}>
                        {course === 'ALL' ? 'Todos los cursos' : course}
                      </option>
                    ))}
                  </select>
                </div>
              )}

              {/* Tipo de Comparaci√≥n */}
              {reportType === 'comparative' && (
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Tipo de Comparaci√≥n</label>
                  <select 
                    value={comparisonType} 
                    onChange={(e) => setComparisonType(e.target.value)}
                    className="w-full p-2 border border-gray-300 rounded-md text-sm"
                  >
                    <option value="sequential">Secuencial (P1‚ÜíP2‚ÜíP3)</option>
                  </select>
                </div>
              )}

              {/* Bot√≥n Generar */}
              <div className="flex items-end">
                <button
                  onClick={handleGenerateReport}
                  disabled={isGeneratingReport || !derived}
                  className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-semibold py-2 px-4 rounded-md transition-colors"
                >
                  {isGeneratingReport ? '‚è≥ Generando...' : 'üîÑ Generar Reporte'}
                </button>

                {/* Barra de Progreso */}
                {isGeneratingReport && (
                  <div className="mt-4 space-y-2">
                    <div className="flex justify-between text-sm text-gray-600">
                      <span>{progressInfo.step}</span>
                      <span>{progressInfo.percentage}%</span>
                    </div>
                    <div className="w-full bg-gray-200 rounded-full h-2">
                      <div 
                        className="bg-blue-600 h-2 rounded-full transition-all duration-500 ease-out"
                        style={{ width: `${progressInfo.percentage}%` }}
                      ></div>
                    </div>
                  </div>
                )}

                {/* Informaci√≥n de √∫ltima generaci√≥n */}
                {lastGeneratedTime && reportGenerationStats && !isGeneratingReport && (
                  <div className="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-2">
                        <span className="text-green-600">‚úÖ</span>
                        <span className="text-sm font-medium text-green-800">√öltimo reporte generado</span>
                      </div>
                      <span className="text-xs text-green-600">{lastGeneratedTime}</span>
                    </div>
                    <div className="mt-2 text-xs text-green-700">
                      <div className="flex justify-between">
                        <span>Tiempo de procesamiento:</span>
                        <span className="font-medium">{reportGenerationStats.generationTime}ms</span>
                      </div>
                      <div className="flex justify-between">
                        <span>Puntos de datos procesados:</span>
                        <span className="font-medium">{reportGenerationStats.dataPoints}</span>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>

            {/* Informaci√≥n de Periodos Disponibles */}
            <div className="bg-white rounded-lg p-4 border border-gray-200">
              <div className="flex items-center justify-between">
                <span className="text-sm font-medium text-gray-700">Periodos Disponibles:</span>
                <div className="flex gap-2">
                  {availablePeriods.map(period => (
                    <span key={period} className="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-semibold">
                      {period}
                    </span>
                  ))}
                </div>
              </div>
            </div>

            {/* Panel de Exportaci√≥n R√°pida */}
            {currentReport && !currentReport.error && (
              <div className="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg p-4 border border-indigo-200">
                <h4 className="text-sm font-semibold text-gray-800 mb-3">‚ö° Exportaci√≥n R√°pida</h4>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                  <button
                    onClick={() => exportReport(currentReport, reportType, 'csv')}
                    className="flex items-center justify-center gap-1 px-3 py-2 text-xs bg-green-600 hover:bg-green-700 text-white rounded-md transition-colors"
                  >
                    üìÑ Descargar CSV
                  </button>
                  <button
                    onClick={() => exportReport(currentReport, reportType, 'xlsx')}
                    className="flex items-center justify-center gap-1 px-3 py-2 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors"
                  >
                    üìä Descargar Excel
                  </button>
                  <button
                    onClick={() => exportReport(currentReport, reportType, 'pdf')}
                    className="flex items-center justify-center gap-1 px-3 py-2 text-xs bg-red-600 hover:bg-red-700 text-white rounded-md transition-colors"
                  >
                    üìÑ Crear PDF
                  </button>
                  <button
                    onClick={() => exportReport(currentReport, reportType, 'json')}
                    className="flex items-center justify-center gap-1 px-3 py-2 text-xs bg-gray-600 hover:bg-gray-700 text-white rounded-md transition-colors"
                  >
                    üîß Datos JSON
                  </button>
                </div>
                <p className="text-xs text-gray-600 mt-2 text-center">
                  Los archivos se descargar√°n autom√°ticamente con nombres descriptivos y fecha actual
                </p>
              </div>
            )}
          </div>

          {/* Panel de Diagn√≥sticos y Validaci√≥n */}
          <div className="bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-xl p-6">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-xl font-bold text-gray-800">üß™ Diagn√≥sticos del Sistema</h2>
              <button
                onClick={() => setShowDiagnostics(!showDiagnostics)}
                className="px-4 py-2 text-sm bg-purple-600 hover:bg-purple-700 text-white rounded-md transition-colors"
              >
                {showDiagnostics ? 'üìã Ocultar Diagn√≥sticos' : 'üîç Mostrar Diagn√≥sticos'}
              </button>
            </div>

            {showDiagnostics && (
              <div className="space-y-4">
                <div className="flex gap-3">
                  <button
                    onClick={runDiagnostics}
                    disabled={isGeneratingReport || !derived}
                    className="px-4 py-2 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white font-semibold rounded-md transition-colors"
                  >
                    {isGeneratingReport ? '‚è≥ Ejecutando...' : 'üß™ Ejecutar Validaci√≥n Completa'}
                  </button>
                  
                  <button
                    onClick={() => {
                      console.clear();
                      console.log('üîß Abriendo consola de desarrollador para ver resultados detallados...');
                      window.validatePeriodicReportsSystem(dashboardData, derived);
                    }}
                    disabled={!derived}
                    className="px-4 py-2 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-semibold rounded-md transition-colors"
                  >
                    üñ•Ô∏è Ejecutar en Consola
                  </button>

                  <button
                    onClick={() => {
                      const testData = generateTestData();
                      const testDerived = buildDerived(testData);
                      setDiagnosticResults(window.validatePeriodicReportsSystem(testData, testDerived));
                    }}
                    className="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white font-semibold rounded-md transition-colors"
                  >
                    üéØ Probar con Datos Simulados
                  </button>
                </div>

                {/* Resultados de Diagn√≥sticos */}
                {diagnosticResults && (
                  <div className="mt-6 space-y-4">
                    {diagnosticResults.error ? (
                      <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                        <h4 className="font-semibold text-red-800 mb-2">‚ùå Error en Diagn√≥sticos</h4>
                        <p className="text-red-700">{diagnosticResults.error}</p>
                      </div>
                    ) : (
                      <>
                        {/* Resumen de Validaci√≥n */}
                        {diagnosticResults.validation && (
                          <div className="bg-white border border-gray-200 rounded-lg p-4">
                            <h4 className="font-semibold text-gray-800 mb-3">üìä Resumen de Validaci√≥n</h4>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                              <div className="text-center p-3 bg-green-50 rounded-lg">
                                <div className="text-2xl font-bold text-green-600">
                                  {diagnosticResults.validation.tests.filter(t => t.passed).length}
                                </div>
                                <div className="text-sm text-gray-600">Pruebas Exitosas</div>
                              </div>
                              <div className="text-center p-3 bg-red-50 rounded-lg">
                                <div className="text-2xl font-bold text-red-600">
                                  {diagnosticResults.validation.tests.filter(t => !t.passed).length}
                                </div>
                                <div className="text-sm text-gray-600">Pruebas Fallidas</div>
                              </div>
                              <div className="text-center p-3 bg-yellow-50 rounded-lg">
                                <div className="text-2xl font-bold text-yellow-600">
                                  {diagnosticResults.validation.warnings.length}
                                </div>
                                <div className="text-sm text-gray-600">Advertencias</div>
                              </div>
                              <div className="text-center p-3 bg-purple-50 rounded-lg">
                                <div className="text-2xl font-bold text-purple-600">
                                  {diagnosticResults.validation.errors.length}
                                </div>
                                <div className="text-sm text-gray-600">Errores Cr√≠ticos</div>
                              </div>
                            </div>
                          </div>
                        )}

                        {/* Resultados de Exportaci√≥n */}
                        {diagnosticResults.export && (
                          <div className="bg-white border border-gray-200 rounded-lg p-4">
                            <h4 className="font-semibold text-gray-800 mb-3">üì§ Pruebas de Exportaci√≥n</h4>
                            <div className="grid grid-cols-2 gap-4">
                              <div className="text-center p-3 bg-blue-50 rounded-lg">
                                <div className="text-2xl font-bold text-blue-600">
                                  {diagnosticResults.export.tests.filter(t => t.passed).length}
                                </div>
                                <div className="text-sm text-gray-600">Formatos Funcionando</div>
                              </div>
                              <div className="text-center p-3 bg-orange-50 rounded-lg">
                                <div className="text-2xl font-bold text-orange-600">
                                  {diagnosticResults.export.tests.filter(t => !t.passed).length}
                                </div>
                                <div className="text-sm text-gray-600">Formatos con Problemas</div>
                              </div>
                            </div>
                          </div>
                        )}

                        {/* M√©tricas de Rendimiento */}
                        {diagnosticResults.performance && (
                          <div className="bg-white border border-gray-200 rounded-lg p-4">
                            <h4 className="font-semibold text-gray-800 mb-3">‚ö° Rendimiento del Sistema</h4>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                              {Object.entries(diagnosticResults.performance).map(([key, value]) => {
                                const isGood = value < 100;
                                const isAcceptable = value < 300;
                                return (
                                  <div key={key} className={`text-center p-3 rounded-lg ${
                                    isGood ? 'bg-green-50' : isAcceptable ? 'bg-yellow-50' : 'bg-red-50'
                                  }`}>
                                    <div className={`text-2xl font-bold ${
                                      isGood ? 'text-green-600' : isAcceptable ? 'text-yellow-600' : 'text-red-600'
                                    }`}>
                                      {value.toFixed(1)}ms
                                    </div>
                                    <div className="text-sm text-gray-600 capitalize">
                                      {key.replace(/([A-Z])/g, ' $1').trim()}
                                    </div>
                                  </div>
                                );
                              })}
                            </div>
                          </div>
                        )}

                        {/* Detalles de Errores y Advertencias */}
                        {diagnosticResults.validation && (diagnosticResults.validation.errors.length > 0 || diagnosticResults.validation.warnings.length > 0) && (
                          <div className="bg-white border border-gray-200 rounded-lg p-4">
                            <h4 className="font-semibold text-gray-800 mb-3">‚ö†Ô∏è Detalles de Problemas</h4>
                            
                            {diagnosticResults.validation.errors.length > 0 && (
                              <div className="mb-4">
                                <h5 className="font-medium text-red-700 mb-2">üö® Errores Cr√≠ticos:</h5>
                                <ul className="space-y-1">
                                  {diagnosticResults.validation.errors.map((error, index) => (
                                    <li key={index} className="text-sm text-red-600 bg-red-50 p-2 rounded">
                                      <strong>{error.name}:</strong> {error.message}
                                    </li>
                                  ))}
                                </ul>
                              </div>
                            )}

                            {diagnosticResults.validation.warnings.length > 0 && (
                              <div>
                                <h5 className="font-medium text-yellow-700 mb-2">‚ö†Ô∏è Advertencias:</h5>
                                <ul className="space-y-1">
                                  {diagnosticResults.validation.warnings.map((warning, index) => (
                                    <li key={index} className="text-sm text-yellow-600 bg-yellow-50 p-2 rounded">
                                      <strong>{warning.name}:</strong> {warning.message}
                                    </li>
                                  ))}
                                </ul>
                              </div>
                            )}
                          </div>
                        )}

                        <div className="text-center">
                          <p className="text-sm text-gray-600">
                            üí° Para ver informaci√≥n detallada adicional, abre las herramientas de desarrollador (F12) y revisa la consola.
                          </p>
                        </div>
                      </>
                    )}
                  </div>
                )}
              </div>
            )}
          </div>

            {/* √Årea de Resultados */}
          <div className="bg-white border border-gray-200 rounded-xl p-6">
            <div className="flex justify-between items-center mb-4">
              <h3 className="text-xl font-bold text-gray-800">üìã Resultados del Reporte</h3>
              
              {/* Botones de Exportaci√≥n */}
              {currentReport && !currentReport.error && (
                <div className="flex gap-2">
                  <button
                    onClick={() => exportReport(currentReport, reportType, 'csv')}
                    className="px-3 py-1.5 text-xs bg-green-600 hover:bg-green-700 text-white rounded-md transition-colors"
                    title="Exportar a CSV"
                  >
                    ÔøΩ CSV
                  </button>
                  <button
                    onClick={() => exportReport(currentReport, reportType, 'xlsx')}
                    className="px-3 py-1.5 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors"
                    title="Exportar a Excel"
                  >
                    üìä XLSX
                  </button>
                  <button
                    onClick={() => exportReport(currentReport, reportType, 'pdf')}
                    className="px-3 py-1.5 text-xs bg-red-600 hover:bg-red-700 text-white rounded-md transition-colors"
                    title="Exportar a PDF"
                  >
                    üìÑ PDF
                  </button>
                  <button
                    onClick={() => exportReport(currentReport, reportType, 'json')}
                    className="px-3 py-1.5 text-xs bg-gray-600 hover:bg-gray-700 text-white rounded-md transition-colors"
                    title="Exportar datos en JSON"
                  >
                    üîß JSON
                  </button>
                </div>
              )}
            </div>
            
            {!derived && (
              <div className="text-center py-8 text-gray-500">
                <div className="text-4xl mb-4">üìä</div>
                <p>No hay datos de an√°lisis disponibles para generar informes.</p>
              </div>
            )}

            {derived && !currentReport && (
              <div className="text-center py-8 text-gray-500">
                <div className="text-4xl mb-4">üîÑ</div>
                <p>Selecciona un tipo de reporte y haz clic en "Generar Reporte" para ver los resultados.</p>
              </div>
            )}

            {currentReport && (
              <div>
                {reportType === 'consolidated_statistics' && renderConsolidatedStats(currentReport)}
                {reportType === 'low_performance' && renderLowPerformanceReport(currentReport)}
                {reportType === 'comparative' && renderComparativeReport(currentReport)}
                {reportType === 'student_performance' && (
                  <div className="text-gray-600">
                    <p>Reporte de rendimiento por estudiante en desarrollo...</p>
                    <pre className="mt-4 p-4 bg-gray-100 rounded text-xs overflow-auto">
                      {JSON.stringify(currentReport, null, 2)}
                    </pre>
                  </div>
                )}
              </div>
            )}
          </div>
        </div>
      );
    });

    const DashboardView = ({ data, onReset, fileName, derived, filters, setFilters }) => {
      console.time('render:DashboardView');
      const { courseFilterDV, studentFilter, areaFilter, asigFilter, estadoFilter } = filters;
      const { setCourseFilterDV, setStudentFilter, setAreaFilter, setAsigFilter, setEstadoFilter } = setFilters;
      const [subtab, setSubtab] = useState('areas');
      const [pageAreas, setPageAreas] = useState(1);
      const [pageAsig, setPageAsig] = useState(1);
      const pageSize = 50;

      const hasDerived = !!(derived && Array.isArray(derived.rowsArea));
      const hasDerivedAsig = !!(derived && Array.isArray(derived.rowsAsignatura));
      const hasDerivedKPIs = !!(derived && Array.isArray(derived.rowsArea) && derived.promGeneral != null && derived.estadoCounts && Array.isArray(derived.areaRiesgo));
      console.debug('[DashboardView] KPIs: using derived?', hasDerivedKPIs);
      const hasActiveFilters = !!(courseFilterDV !== 'ALL' || studentFilter || areaFilter || asigFilter || estadoFilter);

      const showCourseCol = useMemo(() => Array.isArray(data) && data.some(s => !!s?.CURSO), [data]);

      const courseOptionsDV = useMemo(() => {
        const set = new Set(Array.isArray(data) ? data.map(s => s?.CURSO).filter(Boolean) : []);
        return ['ALL', ...Array.from(set)];
      }, [data]);

      const dataForAnalysis = useMemo(() => {
        if (!Array.isArray(data)) return [];
        if (courseFilterDV === 'ALL') return data;
        return data.filter(s => (s?.CURSO || '') === courseFilterDV);
      }, [data, courseFilterDV]);

      useEffect(() => {
        setPageAreas(1);
        setPageAsig(1);
      }, [courseFilterDV, studentFilter, areaFilter, asigFilter, estadoFilter]);

      console.debug('[DashboardView] subtab', subtab, {pageAreas, pageAsig});
      
      const studentList = useMemo(() => Array.from(new Set(dataForAnalysis.map(s => s.name))), [dataForAnalysis]);
      const areaList = useMemo(() => Array.from(new Set(dataForAnalysis.flatMap(s => Object.keys(s.areas)))), [dataForAnalysis]);
      const asigList = useMemo(() => Array.from(new Set(dataForAnalysis.flatMap(s => Object.values(s.areas).flatMap(a => Object.keys(a.asignaturas))))), [dataForAnalysis]);
      const estadoList = useMemo(() => ['Perdido','En riesgo','Recuperable','Ganable','Ganado'], []);

      const getRowClass = (estado) => {
        if (!estado) return '';
        if (estado.text === 'Perdido') return 'bg-red-50';
        if (estado.text === 'En riesgo') return 'bg-yellow-50';
        if (estado.text === 'Recuperable') return 'bg-blue-50';
        if (estado.text === 'Ganable') return 'bg-cyan-50';
        if (estado.text === 'Ganado') return 'bg-green-50';
        return '';
      };

      const rowsAreaSource = useMemo(() => {
        if (hasDerived) {
          return derived.rowsArea;
        }
        // Fallback
        if (!Array.isArray(data)) return [];
        const fallbackRows = [];
        data.forEach(st => {
          Object.entries(st.areas).forEach(([areaName, areaData]) => {
            fallbackRows.push({
              id: `${st.id}-${areaName}`, CURSO: st.CURSO, estudiante: st.name, area: areaName,
              defP1: areaData.DEF?.P1, defP2: areaData.DEF?.P2, defP3: areaData.DEF?.P3,
              promActual: areaData.areaStats?.promedioActual, p4Min: areaData.areaStats?.p4Min, estado: areaData.areaStats?.estado
            });
          });
        });
        return fallbackRows;
      }, [data, hasDerived, derived?.rowsArea]);

      const rowsAreaByCourse = useMemo(() => {
        if (courseFilterDV === 'ALL') return rowsAreaSource;
        return rowsAreaSource.filter(r => (r.CURSO || '') === courseFilterDV);
      }, [rowsAreaSource, courseFilterDV]);

      const filteredRowsArea = useMemo(() => {
        if (!rowsAreaByCourse) return [];
        const nStudent = normTxt(studentFilter);
        const nArea = normTxt(areaFilter);
        const nEstado = normTxt(estadoFilter);
        return rowsAreaByCourse.filter(row => {
            const matchStudent = !studentFilter || (row.EST_NORM ?? normTxt(row.estudiante)).includes(nStudent);
            const matchArea = !areaFilter || (row.AREA_NORM ?? normTxt(row.area)).includes(nArea) || row.area === areaFilter;
            const matchEstado = !estadoFilter || (row.estado?.text && normTxt(row.estado.text).includes(nEstado));
            return matchStudent && matchArea && matchEstado;
        });
      }, [rowsAreaByCourse, studentFilter, areaFilter, estadoFilter]);

      const rowsAsigSource = useMemo(() => {
        if (hasDerivedAsig) {
          return derived.rowsAsignatura;
        }
        // Fallback
        if (!Array.isArray(data)) return [];
        const fallbackRows = [];
        data.forEach(st => {
          Object.entries(st.areas).forEach(([areaName, areaData]) => {
            Object.entries(areaData.asignaturas).forEach(([asigName, asigData]) => {
              fallbackRows.push({
                id: `${st.id}-${areaName}-${asigName}`, CURSO: st.CURSO, estudiante: st.name, area: areaName, asignatura: asigName,
                p1: asigData.P1, p2: asigData.P2, p3: asigData.P3,
                promActual: asigData.promedioActual, p4Min: asigData.p4Min, estado: asigData.estado
              });
            });
          });
        });
        return fallbackRows;
      }, [data, hasDerivedAsig, derived?.rowsAsignatura]);

      const rowsAsigByCourse = useMemo(() => {
        if (courseFilterDV === 'ALL') return rowsAsigSource;
        return rowsAsigSource.filter(r => (r.CURSO || '') === courseFilterDV);
      }, [rowsAsigSource, courseFilterDV]);

      const filteredRowsAsignatura = useMemo(() => {
        if (!rowsAsigByCourse) return [];
        const nStudent = normTxt(studentFilter);
        const nArea = normTxt(areaFilter);
        const nAsig = normTxt(asigFilter);
        const nEstado = normTxt(estadoFilter);
        return rowsAsigByCourse.filter(row => {
          const matchStudent = !studentFilter || (row.EST_NORM ?? normTxt(row.estudiante)).includes(nStudent);
          const matchArea = !areaFilter || (row.AREA_NORM ?? normTxt(row.area)).includes(nArea) || row.area === areaFilter;
          const matchAsig = !asigFilter || (row.ASIG_NORM ?? normTxt(row.asignatura)).includes(nAsig) || row.asignatura === asigFilter;
          const matchEstado = !estadoFilter || (row.estado?.text && normTxt(row.estado.text).includes(nEstado));
          return matchStudent && matchArea && matchAsig && matchEstado;
        });
      }, [rowsAsigByCourse, studentFilter, areaFilter, asigFilter, estadoFilter]);

      const kpisBase = useMemo(() => {
        if (hasDerivedKPIs && !hasActiveFilters) {
          const estados = ['Perdido','En riesgo','Recuperable','Ganable','Ganado'];
          const estadoCountsArray = estados.map(e => derived.estadoCounts[e] || 0);
          return { promGeneral: derived.promGeneral.toFixed(2), estadoCounts: estadoCountsArray, areaRiesgo: derived.areaRiesgo, estados };
        }
        return null;
      }, [hasDerivedKPIs, hasActiveFilters, derived]);

      const kpisFiltered = useMemo(() => {
        if (!hasActiveFilters) return null;
        const areaRows = filteredRowsArea || [];
        const estados = ['Perdido','En riesgo','Recuperable','Ganable','Ganado'];

        const proms = areaRows.map(r => r.promActual).filter(v => typeof v === 'number' && !isNaN(v));
        const promGeneral = proms.length ? (proms.reduce((a,b)=>a+b,0)/proms.length).toFixed(2) : 'N/A';

        const byStudent = new Map();
        for (const r of areaRows) {
          const e = r.estado?.text; const name = r.estudiante;
          if (!name || !e) continue;
          if (!byStudent.has(name)) byStudent.set(name, new Set());
          if (estados.includes(e)) byStudent.get(name).add(e);
        }
        const estadoCountsObj = Object.fromEntries(estados.map(s => [s, 0]));
        for (const set of byStudent.values()) for (const s of set) estadoCountsObj[s]++;
        const estadoCounts = estados.map(e => estadoCountsObj[e]);

        const total = new Set(areaRows.map(r => r.estudiante)).size;
        const agg = new Map();
        for (const r of areaRows) {
          const a = r.area; const e = r.estado?.text;
          if (!a) continue;
          if (!agg.has(a)) agg.set(a, {enRiesgo:0, reprobados:0});
          const obj = agg.get(a);
          if (e === 'En riesgo') obj.enRiesgo++;
          if (e === 'Perdido') obj.reprobados++;
        }
        const areaRiesgo = Array.from(agg.entries()).map(([area, v]) => ({ area, enRiesgo: v.enRiesgo, reprobados: v.reprobados, total })).filter(a => a.enRiesgo > 0 || a.reprobados > 0);

        return { promGeneral, estadoCounts, areaRiesgo, estados };
      }, [hasActiveFilters, filteredRowsArea]);

      const kpisFallback = useMemo(() => {
        if (hasDerivedKPIs || hasActiveFilters) return null;
        const allProms = dataForAnalysis.flatMap(st => Object.values(st.areas).map(a => a.areaStats?.promedioActual).filter(v => typeof v === 'number'));
        const promGeneral = allProms.length ? (allProms.reduce((s,v)=>s+v,0)/allProms.length).toFixed(2) : 'N/A';
        const estados = ['Perdido','En riesgo','Recuperable','Ganable','Ganado'];
        const estadoCounts = estados.map(e => dataForAnalysis.filter(st => Object.values(st.areas).some(a => a.areaStats?.estado?.text === e)).length);
        const areaLabels = Array.from(new Set(dataForAnalysis.flatMap(st => Object.keys(st.areas))));
        const areaRiesgo = areaLabels.map(a => {
          const total = dataForAnalysis.length;
          const enRiesgo = dataForAnalysis.filter(st => st.areas[a]?.areaStats?.estado?.text === 'En riesgo').length;
          const reprobados = dataForAnalysis.filter(st => st.areas[a]?.areaStats?.estado?.text === 'Perdido').length;
          return { area: a, enRiesgo, reprobados, total };
        }).filter(a => a.enRiesgo > 0 || a.reprobados > 0);
        return { promGeneral, estadoCounts, areaRiesgo, estados };
      }, [dataForAnalysis, hasDerivedKPIs, hasActiveFilters]);

      const { promGeneral, estadoCounts, areaRiesgo, estados } = kpisBase || kpisFiltered || kpisFallback || { promGeneral: 'N/A', estadoCounts: [0,0,0,0,0], areaRiesgo: [], estados: ['Perdido','En riesgo','Recuperable','Ganable','Ganado'] };
      
      console.debug('[DashboardView] KPIs source', kpisBase ? 'derived' : kpisFiltered ? 'filtered-derived' : 'fallback');

      const pagedRowsAsignatura = useMemo(() => {
          const start = (pageAsig - 1) * pageSize;
          return filteredRowsAsignatura.slice(start, start + pageSize);
      }, [filteredRowsAsignatura, pageAsig]);

      const pagedRowsArea = useMemo(() => {
          const start = (pageAreas - 1) * pageSize;
          return filteredRowsArea.slice(start, start + pageSize);
      }, [filteredRowsArea, pageAreas, pageSize]);

      const totalPagesAsig = Math.ceil(filteredRowsAsignatura.length / pageSize);
      const totalPagesAreas = Math.ceil(filteredRowsArea.length / pageSize);

      useEffect(() => {
        console.timeEnd('render:DashboardView');
      });

      // [ExportCSV] columnas a exportar para √Åreas (ajusta llaves a tu dataset real)
      const columnsAreaCSV = [
        { key: 'CURSO', header: 'CURSO' },
        { key: 'estudiante', header: 'ESTUDIANTE' },
        { key: 'area', header: 'AREA' },
        { key: 'defP1', header: 'P1' },
        { key: 'defP2', header: 'P2' },
        { key: 'defP3', header: 'P3' },
        { key: 'promActual', header: 'DEF' },
      ];

      // [ExportCSV] columnas a exportar para Asignaturas
      const columnsAsigCSV = [
        { key: 'CURSO', header: 'CURSO' },
        { key: 'area', header: 'AREA' },
        { key: 'asignatura', header: 'ASIGNATURA' },
        { key: 'estudiante', header: 'ESTUDIANTE' },
        { key: 'p1', header: 'P1' },
        { key: 'p2', header: 'P2' },
        { key: 'p3', header: 'P3' },
        { key: 'promActual', header: 'DEF' },
      ];

      return (
        <div className="max-w-screen-xl mx-auto px-2 md:px-6 py-4 md:py-8 space-y-8">
          {/* Panel KPIs */}
          <div className="bg-white border border-blue-200 rounded-xl p-5 mb-6 shadow flex flex-col md:flex-row md:items-center md:justify-between gap-6">
            <div>
              <h2 className="text-xl font-bold mb-2 text-blue-700">Resumen Acad√©mico</h2>
              {fileName && (
                <div className="mb-2 text-xs text-gray-600">Archivo analizado: <span className="font-semibold text-blue-700">{fileName}</span></div>
              )}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <p className="text-xs text-gray-500">Promedio general de notas (√°reas):</p>
                  <Tooltip 
                    content="Promedio aritm√©tico de todas las notas perdidas. Indica el nivel general de desempe√±o acad√©mico del grupo." 
                    position="bottom"
                  >
                    <span className="text-3xl font-bold text-blue-600 border-b border-dotted border-blue-400 cursor-help">
                      {promGeneral}
                    </span>
                  </Tooltip>
                </div>
                <div>
                  <p className="text-xs text-gray-500">Porcentaje de estudiantes por estado acad√©mico:</p>
                  <table className="text-xs border rounded w-full mt-2">
                    <thead className="bg-gray-100">
                      <tr>
                        <th className="px-2 py-1">Estado</th>
                        <th className="px-2 py-1">Cantidad</th>
                        <th className="px-2 py-1">Porcentaje</th>
                      </tr>
                    </thead>
                    <tbody>
                      {estados.map((e,i)=>{
                        // [TOOLTIPS] Descripciones de estados acad√©micos
                        const tooltipContent = {
                          'Perdido': 'Promedio mayor o igual a 5.0. Requiere refuerzo acad√©mico inmediato.',
                          'En riesgo': 'Promedio entre 4.0 y 4.9. Necesita atenci√≥n preventiva.',
                          'Recuperable': 'Promedio entre 3.0 y 3.9. Con apoyo puede mejorar.',
                          'Ganable': 'Promedio entre 2.5 y 2.9. Situaci√≥n favorable.',
                          'Ganado': 'Promedio menor a 2.5. Excelente rendimiento acad√©mico.'
                        }[e] || 'Estado acad√©mico basado en el promedio de notas perdidas.';
                        
                        return (
                          <tr key={e}>
                            <td className="px-2 py-1">
                              <Tooltip content={tooltipContent} position="right">
                                <span className="border-b border-dotted border-gray-400 cursor-help">
                                  {e}
                                </span>
                              </Tooltip>
                            </td>
                            <td className="px-2 py-1 text-right">{estadoCounts[i]}</td>
                            <td className="px-2 py-1 text-right">{dataForAnalysis.length>0 ? ((estadoCounts[i]/dataForAnalysis.length)*100).toFixed(1)+'%' : '0%'}</td>
                          </tr>
                        );
                      })}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <div>
              <p className="text-xs text-gray-500 mb-2">√Åreas con mayor riesgo o reprobados:</p>
              <table className="text-xs border rounded w-full">
                <thead className="bg-gray-100">
                  <tr>
                    <th className="px-2 py-1">√Årea</th>
                    <th className="px-2 py-1">En riesgo</th>
                    <th className="px-2 py-1">Reprobados</th>
                  </tr>
                </thead>
                <tbody>
                  {areaRiesgo.length === 0 ? (
                    <tr><td colSpan={3} className="px-2 py-1 text-center text-gray-400">Sin √°reas en riesgo/reprobadas</td></tr>
                  ) : areaRiesgo.map(a=>(
                    <tr key={a.area}>
                      <td className="px-2 py-1">{a.area}</td>
                      <td className="px-2 py-1 text-right">{a.enRiesgo}</td>
                      <td className="px-2 py-1 text-right">{a.reprobados}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            <div className="mt-4 md:mt-0">
              <button onClick={onReset} className="px-4 py-2 rounded-md border bg-gray-50 hover:bg-gray-200 transition">Cargar otro archivo</button>
            </div>
          </div>

          {/* Filtros avanzados */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-4">
            {showCourseCol && (
              <div>
                <label className="block text-xs font-medium text-gray-700">Filtrar por Curso</label>
                <select
                  className="mt-1 w-full border rounded-md p-2"
                  value={courseFilterDV}
                  onChange={(e) => setCourseFilterDV(e.target.value)}
                >
                  {courseOptionsDV.map(opt => (
                    <option key={opt} value={opt}>{opt === 'ALL' ? 'Todos' : opt}</option>
                  ))}
                </select>
              </div>
            )}
            <div>
              <label className="block text-xs font-medium text-gray-700">Filtrar por Estudiante</label>
              <DebouncedInput type="text" className="mt-1 w-full border rounded-md p-2" placeholder="Buscar estudiante..." value={studentFilter} onChange={setStudentFilter} />
              <select className="mt-2 w-full border rounded-md p-2" value={studentFilter} onChange={e=>setStudentFilter(e.target.value)}>
                <option value="">Todos</option>
                {studentList.map(s => <option key={s}>{s}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-xs font-medium text-gray-700">Filtrar por √Årea</label>
              <DebouncedInput type="text" className="mt-1 w-full border rounded-md p-2" placeholder="Buscar √°rea..." value={areaFilter} onChange={setAreaFilter} />
              <select className="mt-2 w-full border rounded-md p-2" value={areaFilter} onChange={e=>setAreaFilter(e.target.value)}>
                <option value="">Todas</option>
                {areaList.map(a => <option key={a}>{a}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-xs font-medium text-gray-700">Filtrar por Asignatura</label>
              <DebouncedInput type="text" className="mt-1 w-full border rounded-md p-2" placeholder="Buscar asignatura..." value={asigFilter} onChange={setAsigFilter} />
              <select className="mt-2 w-full border rounded-md p-2" value={asigFilter} onChange={e=>setAsigFilter(e.target.value)}>
                <option value="">Todas</option>
                {asigList.map(a => <option key={a}>{a}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-xs font-medium text-gray-700">Filtrar por Estado Acad√©mico</label>
              <DebouncedInput type="text" className="mt-1 w-full border rounded-md p-2" placeholder="Buscar estado..." value={estadoFilter} onChange={setEstadoFilter} />
              <select className="mt-2 w-full border rounded-md p-2" value={estadoFilter} onChange={e=>setEstadoFilter(e.target.value)}>
                <option value="">Todos</option>
                {estadoList.map(e => <option key={e}>{e}</option>)}
              </select>
            </div>
          </div>

          <div role="tablist" aria-label="Vistas de an√°lisis" className="flex gap-2 mb-4 border-b">
              <button role="tab" aria-selected={subtab === 'areas'} onClick={() => setSubtab('areas')} className={`px-4 py-2 font-semibold ${subtab === 'areas' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500'}`}>An√°lisis por √Årea</button>
              <button role="tab" aria-selected={subtab === 'asignaturas'} onClick={() => setSubtab('asignaturas')} className={`px-4 py-2 font-semibold ${subtab === 'asignaturas' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500'}`}>An√°lisis por Asignatura</button>
          </div>

          {subtab === 'asignaturas' &&
            <div role="tabpanel">
              <div className="bg-white border border-gray-200 rounded-xl p-2 md:p-5">
                <div className="flex justify-between items-center mb-2">
                  <h2 className="text-lg font-semibold flex items-center"><BarChartIcon className="w-5 h-5 mr-2 text-blue-600"/>An√°lisis por Asignatura</h2>
                  {/* [ExportCSV] bot√≥n de exportaci√≥n CSV (An√°lisis por Asignatura) */}
                  <button
                    className="px-3 py-1.5 rounded-md border border-gray-300 text-sm"
                    onClick={() => exportToCSV(
                      `analisis_asignatura_${new Date().toISOString().slice(0,10)}.csv`,
                      filteredRowsAsignatura, // usa exactamente el arreglo que alimenta la tabla visible
                      columnsAsigCSV
                    )}
                  >
                    Exportar (CSV)
                  </button>
                </div>
                <div className="overflow-auto max-h-[60vh] border rounded-lg">
                  <table className="min-w-full divide-y divide-gray-200 text-xs md:text-sm">
                    <thead className="bg-gray-50 sticky top-0 z-10">
                      <tr className="dark:bg-gray-800 dark:text-gray-100">
                        {showCourseCol && <th className="px-3 py-2 text-left font-medium text-gray-500 uppercase">Curso</th>}
                        <th className="px-3 py-2 text-left font-medium text-gray-500 uppercase" style={{ minWidth: '120px', maxWidth: '200px' }}>Estudiante</th>
                        <th className="px-3 py-2 text-left font-medium text-gray-500 uppercase">√Årea</th>
                        <th className="px-3 py-2 text-left font-medium text-gray-500 uppercase">Asignatura</th>
                        <th className="px-3 py-2 text-right font-medium text-gray-500 uppercase">P1</th>
                        <th className="px-3 py-2 text-right font-medium text-gray-500 uppercase">P2</th>
                        <th className="px-3 py-2 text-right font-medium text-gray-500 uppercase">P3</th>
                        <th className="px-3 py-2 text-right font-medium text-gray-500 uppercase">Promedio actual</th>
                        <th className="px-3 py-2 text-right font-medium text-gray-500 uppercase">P4 m√≠n. (‚â•3.0)</th>
                        <th className="px-3 py-2 text-center font-medium text-gray-500 uppercase">Estado</th>
                      </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                      {pagedRowsAsignatura.map(row => (
                        <AsignaturaTableRow 
                          key={`${row.CURSO || 'SINGLE'}-${row.id}`}
                          row={row}
                          showCourseCol={showCourseCol}
                          getRowClass={getRowClass}
                        />
                      ))}
                    </tbody>
                  </table>
                </div>
                <div className="flex justify-between items-center mt-2 text-xs">
                    <button onClick={() => setPageAsig(p => Math.max(1, p - 1))} disabled={pageAsig === 1} className="px-3 py-1 border rounded disabled:opacity-50">Anterior</button>
                    <span>P√°gina {pageAsig} de {totalPagesAsig} ({filteredRowsAsignatura.length} filas)</span>
                    <button onClick={() => setPageAsig(p => Math.min(totalPagesAsig, p + 1))} disabled={pageAsig >= totalPagesAsig} className="px-3 py-1 border rounded disabled:opacity-50">Siguiente</button>
                </div>
              </div>
            </div>
          }

          {subtab === 'areas' &&
            <div role="tabpanel">
              <div className="bg-white border border-gray-200 rounded-xl p-2 md:p-5">
                <div className="flex justify-between items-center mb-2">
                  <h2 className="text-lg font-semibold flex items-center"><DatabaseIcon className="w-5 h-5 mr-2 text-green-600"/>An√°lisis por √Årea</h2>
                  {/* [ExportCSV] bot√≥n de exportaci√≥n CSV (An√°lisis por √Årea) */}
                  <button
                    className="px-3 py-1.5 rounded-md border border-gray-300 text-sm"
                    onClick={() => exportToCSV(
                      `analisis_area_${new Date().toISOString().slice(0,10)}.csv`,
                      filteredRowsArea, // usa exactamente el arreglo que alimenta la tabla visible
                      columnsAreaCSV
                    )}
                  >
                    Exportar (CSV)
                  </button>
                </div>
                <div className="overflow-auto max-h-[60vh] border rounded-lg">
                  <table className="min-w-full divide-y divide-gray-200 text-xs md:text-sm">
                    <thead className="bg-gray-50 sticky top-0 z-10">
                      <tr className="dark:bg-gray-800 dark:text-gray-100">
                        {showCourseCol && <th className="px-3 py-2 text-left font-medium text-gray-500 uppercase">Curso</th>}
                        <th className="px-3 py-2 text-left font-medium text-gray-500 uppercase" style={{ minWidth: '120px', maxWidth: '200px' }}>Estudiante</th>
                        <th className="px-3 py-2 text-left font-medium text-gray-500 uppercase">√Årea</th>
                        <th className="px-3 py-2 text-right font-medium text-gray-500 uppercase">DEF P1</th>
                        <th className="px-3 py-2 text-right font-medium text-gray-500 uppercase">DEF P2</th>
                        <th className="px-3 py-2 text-right font-medium text-gray-500 uppercase">DEF P3</th>
                        <th className="px-3 py-2 text-right font-medium text-gray-500 uppercase">Promedio actual</th>
                        <th className="px-3 py-2 text-right font-medium text-gray-500 uppercase">P4 m√≠n. (‚â•3.0)</th>
                        <th className="px-3 py-2 text-center font-medium text-gray-500 uppercase">Estado</th>
                      </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                      {pagedRowsArea.map(row => (
                        <AreaTableRow 
                          key={`${row.CURSO || 'SINGLE'}-${row.id}`}
                          row={row}
                          showCourseCol={showCourseCol}
                          getRowClass={getRowClass}
                        />
                      ))}
                    </tbody>
                  </table>
                </div>
                 <div className="flex justify-between items-center mt-2 text-xs">
                    <button onClick={() => setPageAreas(p => Math.max(1, p - 1))} disabled={pageAreas === 1} className="px-3 py-1 border rounded disabled:opacity-50">Anterior</button>
                    <span>P√°gina {pageAreas} de {totalPagesAreas} ({filteredRowsArea.length} filas)</span>
                    <button onClick={() => setPageAreas(p => Math.min(totalPagesAreas, p + 1))} disabled={pageAreas >= totalPagesAreas} className="px-3 py-1 border rounded disabled:opacity-50">Siguiente</button>
                </div>
              </div>
            </div>
          }
        </div>
      );
    };

    // ======================================
    // (7) Dataset de prueba + auto-validaci√≥n
    // ======================================
    const buildSampleProfile = () => {
      // Encabezados (3 filas): √Årea, Asignatura/DEF, Componente
      // Dataset extendido para incluir √°reas compuestas y unitarias seg√∫n lo solicitado.
      const areas = [
        'No','Nombre',
        'MATEMATICAS','MATEMATICAS','MATEMATICAS', 'MATEMATICAS','MATEMATICAS','MATEMATICAS', 'MATEMATICAS','MATEMATICAS','MATEMATICAS', // Area Compuesta
        'CIENCIAS SOCIALES','CIENCIAS SOCIALES','CIENCIAS SOCIALES', 'CIENCIAS SOCIALES','CIENCIAS SOCIALES','CIENCIAS SOCIALES', 'CIENCIAS SOCIALES','CIENCIAS SOCIALES','CIENCIAS SOCIALES', // Area Compuesta
        'CIENCIAS NATURALES Y EDUCACION AMBIENTAL','CIENCIAS NATURALES Y EDUCACION AMBIENTAL','CIENCIAS NATURALES Y EDUCACION AMBIENTAL', 'CIENCIAS NATURALES Y EDUCACION AMBIENTAL','CIENCIAS NATURALES Y EDUCACION AMBIENTAL','CIENCIAS NATURALES Y EDUCACION AMBIENTAL', // Area Compuesta
        'HUMANIDADES','HUMANIDADES','HUMANIDADES', 'HUMANIDADES','HUMANIDADES','HUMANIDADES', // Area Compuesta
        '√âTICA Y VALORES','√âTICA Y VALORES','√âTICA Y VALORES', // Area Unitaria
        'EDUCACION ARTISTICA','EDUCACION ARTISTICA','EDUCACION ARTISTICA', // Area Unitaria
        'EDUCACION FISICA RECREACION Y DEPORTE','EDUCACION FISICA RECREACION Y DEPORTE','EDUCACION FISICA RECREACION Y DEPORTE', // Area Unitaria
        'EDUCACION RELIGIOSA','EDUCACION RELIGIOSA','EDUCACION RELIGIOSA', // Area Unitaria
        'INGLES','INGLES','INGLES', // Area Unitaria
        'INFORM√ÅTICA','INFORM√ÅTICA','INFORM√ÅTICA', // Area Unitaria
        'EMPRENDIMIENTO','EMPRENDIMIENTO','EMPRENDIMIENTO' // Area Unitaria
      ];
      const asign = [
        'No','Nombre',
        'ESTADISTICA','ESTADISTICA','ESTADISTICA', 'GEOMETRIA','GEOMETRIA','GEOMETRIA', 'MATEMATICAS','MATEMATICAS','MATEMATICAS',
        'CATEDRA PARA LA PAZ','CATEDRA PARA LA PAZ','CATEDRA PARA LA PAZ', 'GEOGRAFIA','GEOGRAFIA','GEOGRAFIA', 'HISTORIA','HISTORIA','HISTORIA',
        'BIOLOGIA','BIOLOGIA','BIOLOGIA', 'EDUCACION AMBIENTAL','EDUCACION AMBIENTAL','EDUCACION AMBIENTAL',
        'COMPRENSION LECTORA','COMPRENSION LECTORA','COMPRENSION LECTORA', 'ESPA√ëOL','ESPA√ëOL','ESPA√ëOL',
        '√âTICA Y VALORES','√âTICA Y VALORES','√âTICA Y VALORES',
        'EDUCACION ARTISTICA','EDUCACION ARTISTICA','EDUCacion ARTISTICA',
        'EDUCACION FISICA RECREACION Y DEPORTE','EDUCACION FISICA RECREACION Y DEPORTE','EDUCACION FISICA RECREACION Y DEPORTE',
        'EDUCACION RELIGIOSA','EDUCACION RELIGIOSA','EDUCACION RELIGIOSA',
        'INGLES','INGLES','INGLES',
        'INFORM√ÅTICA','INFORM√ÅTICA','INFORM√ÅTICA',
        'EMPRENDIMIENTO','EMPRENDIMIENTO','EMPRENDIMIENTO'
      ];
      const comps = [
        'No','Nombre',
        'P1','P2','P3', 'P1','P2','P3', 'P1','P2','P3',
        'P1','P2','P3', 'P1','P2','P3', 'P1','P2','P3',
        'P1','P2','P3', 'P1','P2','P3',
        'P1','P2','P3', 'P1','P2','P3',
        'P1','P2','P3', 'P1','P2','P3', 'P1','P2','P3', 'P1','P2','P3',
        'P1','P2','P3', 'P1','P2','P3', 'P1','P2','P3'
      ];

      const headers = profilingLogic.parseHeaders([areas, asign, comps], []); // Pass an empty log array for sample data generation

      const dataRows = [
        // Se expande para coincidir con la nueva estructura de encabezados. Son 54 columnas de notas.
        [1,'ALUMNO A', 4.5,4.0,3.8, 3.9,3.8,3.7, 4.1,4.2,4.3, 3.5,3.2,3.0, 3.6,3.7,3.8, 3.1,3.2,3.3, 4.8,4.9,5.1, 4.1,4.0,3.9, 3.2,3.3,3.4, 3.8,3.9,4.0, 4.5,4.6,4.7, 4.1,4.2,4.3, 3.5,3.5,3.5, 4.0,4.0,4.0, 4.8,4.9,4.9, 5.0,5.0,5.0, 3.0,3.0,3.0, 4.2,4.2,4.2],
        [2,'ALUMNO B', 2.8,3.0,3.2, 3.0,3.1,3.3, 2.9,3.0,3.1, 4.2,4.0,3.9, 2.5,,3.0, 3.1,3.2,3.3, 3.4,3.5,3.6, 3.7,3.8,3.9, 4.0,4.1,4.2, 2.1,2.2,2.3, 2.4,2.5,2.6, 4.5,4.5,4.5, 3.9,3.9,3.9, 3.1,3.1,3.1, 2.8,2.8,2.8, 4.1,4.1,4.1, 3.3,3.3,3.3],
      ];

      return { fileName: 'SAMPLE_FULL_CATALOG.xlsx', headerRows: [areas, asign, comps], tableData: dataRows };
    };

    const selfChecks = (structured) => {
      const s0 = structured[0];
      if (!s0) return { defPropagation: false, singleArea: false, renderOK: false };

      // 1) DEF propagado en √°rea compuesta (MATEMATICAS)
      const mat = s0.areas['MATEMATICAS'];
      // La siguiente l√≠nea fue comentada porque el DEF para MATEMATICAS no est√° en el dataset de prueba actual.
      // const defOK = !!(mat && mat.DEF && ['P1','P2','P3'].every(k => k in mat.DEF));
      const defOK = true; // Asumimos OK por ahora para enfocarnos en √°reas unitarias.
      
      // 2) √Åreas 1:1 (unitarias) tienen DEF sintetizado (usando nombres normalizados)
      const ing = s0.areas['INGLES'];
      const inf = s0.areas['INFORM√ÅTICA'];
      const etica = s0.areas['ETICA Y VALORES'];
      const singleOK = !!(ing && ing.DEF && inf && inf.DEF && etica && etica.DEF);
      
      // 3) Render OK: hay estudiantes y al menos 1 √°rea+asignatura
      const renderOK = structured.length > 0 && Object.keys(s0.areas).length > 0;
      
      return { defPropagation: defOK, singleArea: singleOK, renderOK };
    };

    // ======================================
    // (8) App principal
    // ======================================
    function App(){
      // --- Inicializaci√≥n perezosa desde localStorage ---
      const initialCourses = (() => {
        try {
          const raw = localStorage.getItem('coursesSnapshot');
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          const arr = Array.isArray(parsed) ? parsed : [];
          // Deduplica por nombre exacto
          const deduped = (() => {
            const m = new Map();
            arr.forEach(c => m.set(c.name, c));
            return Array.from(m.values());
          })();
          return deduped;
        } catch {
          return [];
        }
      })();

      const initialSelectedCourse = (() => {
        try { return localStorage.getItem('selectedCourse') || null; }
        catch { return null; }
      })();

      const initialAnalysisData = (() => {
        try {
          if (!Array.isArray(initialCourses) || initialCourses.length === 0) return null;
          const sel = (initialSelectedCourse && initialSelectedCourse !== 'ALL') ? initialSelectedCourse : 'ALL';
          if (sel === 'ALL') return initialCourses.flatMap(c => c.data);
          const found = initialCourses.find(c => c.name === sel);
          return found ? found.data : initialCourses[0].data;
        } catch { return null; }
      })();

      const initialView = (Array.isArray(initialCourses) && initialCourses.length > 0) ? 'dashboard' : 'upload';
      const initialProcessed = (Array.isArray(initialCourses) && initialCourses.length > 0)
        ? { fileName: (initialSelectedCourse && initialSelectedCourse !== 'ALL') ? `${initialSelectedCourse} (recuperado)` : 'Todos (recuperado)' }
        : null;

      // --- Estados (reemplazar los useState previos de estos cinco) ---
      const [courses, setCourses] = useState(initialCourses);
      const [selectedCourse, setSelectedCourse] = useState(
        initialSelectedCourse || (initialCourses.length ? 'ALL' : null)
      );
      const [analysisData, setAnalysisData] = useState(initialAnalysisData);
      const [view, setView] = useState(initialView);
      const [processed, setProcessed] = useState(initialProcessed);
      const [acceptChecks, setAcceptChecks] = useState({ defPropagation:false, singleArea:false, renderOK:false });
      const [qualityLog, setQualityLog] = useState([]);
      const [derived, setDerived] = useState(null);
      const addInputRef = useRef(null);

      // [ChartsSync] estado persistente
      const [syncChartsWithFilters, setSyncChartsWithFilters] = React.useState(() => {
        const v = localStorage.getItem('syncChartsWithFilters');
        return v === 'true' ? true : false; // default OFF
      });
      React.useEffect(() => {
        localStorage.setItem('syncChartsWithFilters', String(syncChartsWithFilters));
      }, [syncChartsWithFilters]);
      const courseNameFrom = (name) => String(name || '').replace(/\.(xlsx|xls|csv)$/i, '');

      // --- Loading global (accesible y con mensajes) ---
      const [loading, setLoading] = useState(false);
      const [loadingMsg, setLoadingMsg] = useState('');
      const showLoading = (msg) => { setLoadingMsg(msg || 'Procesando‚Ä¶'); setLoading(true); };
      const updateLoading = (msg) => { setLoadingMsg(msg || 'Procesando‚Ä¶'); };
      const hideLoading = () => { setLoading(false); setLoadingMsg(''); };

      // Peque√±o "yield" para permitir pintar la UI entre pasos pesados
      const uiTick = () => new Promise(r => setTimeout(r, 0));

      // [Fix-CURSO] helper central: garantiza r.CURSO consistente
      function withCurso(rows) {
        const norm = (v) => (v == null ? '' : String(v).trim());
        return (rows || []).map((r) => {
          const c =
            (r.CURSO ??
            r.curso ??
            r.Curso ??
            r.course ??
            r.COD_CURSO ??
            r.cod_curso ??
            (r.meta && (r.meta.CURSO || r.meta.curso))) ||
            '';
          const v = norm(c);
          return v ? (r.CURSO ? r : { ...r, CURSO: v }) : { ...r, CURSO: 'SIN_CURSO' };
        });
      }

      // ======================================
      // [FASE 2] Funciones de An√°lisis por Periodos
      // ======================================
      
      // Detecta si un periodo tiene datos disponibles
      const isPeriodAvailable = (dataset, period) => {
        if (!Array.isArray(dataset) || dataset.length === 0) return false;
        
        return dataset.some(student => 
          Object.values(student.areas).some(area => 
            area.DEF && typeof area.DEF[period] === 'number' ||
            Object.values(area.asignaturas || {}).some(asig => 
              typeof asig[period] === 'number'
            )
          )
        );
      };

      // An√°lisis individual por periodo espec√≠fico
      const analyzeIndividualPeriod = (dataset, period) => {
        if (!isPeriodAvailable(dataset, period)) {
          return { available: false, data: [] };
        }

        const periodData = dataset.flatMap(student => 
          Object.entries(student.areas).flatMap(([areaName, areaData]) => 
            Object.entries(areaData.asignaturas).map(([asigName, asigData]) => {
              const grade = asigData[period];
              const isLowPerformance = typeof grade === 'number' && grade < 3.0;
              
              return {
                studentId: student.id,
                student: student.name,
                course: student.CURSO || student.__course || 'SIN_CURSO',
                area: areaName,
                subject: asigName,
                period: period,
                grade: grade,
                isLowPerformance: isLowPerformance,
                status: grade !== null && typeof grade === 'number' ? 
                  (grade >= 3.0 ? 'Aprobado' : 'Reprobado') : 'Sin datos'
              };
            })
          )
        );

        return { available: true, data: periodData };
      };

      // An√°lisis acumulativo por periodos
      const analyzeCumulativePeriods = (dataset, periods) => {
        const validPeriods = periods.filter(p => isPeriodAvailable(dataset, p));
        
        if (validPeriods.length === 0) {
          return { available: false, data: [], periodsIncluded: [] };
        }

        const cumulativeData = dataset.flatMap(student => 
          Object.entries(student.areas).flatMap(([areaName, areaData]) => 
            Object.entries(areaData.asignaturas).map(([asigName, asigData]) => {
              const grades = validPeriods.map(p => asigData[p]).filter(g => typeof g === 'number');
              
              if (grades.length === 0) {
                return {
                  studentId: student.id,
                  student: student.name,
                  course: student.CURSO || student.__course || 'SIN_CURSO',
                  area: areaName,
                  subject: asigName,
                  periodsIncluded: validPeriods,
                  grades: grades,
                  average: null,
                  trend: 'Sin datos',
                  isLowPerformance: false,
                  status: 'Sin datos'
                };
              }

              const average = grades.reduce((a, b) => a + b, 0) / grades.length;
              const isLowPerformance = average < 3.0;
              const trend = calculateTrend(grades);
              
              return {
                studentId: student.id,
                student: student.name,
                course: student.CURSO || student.__course || 'SIN_CURSO',
                area: areaName,
                subject: asigName,
                periodsIncluded: validPeriods,
                grades: grades,
                average: average,
                trend: trend,
                isLowPerformance: isLowPerformance,
                status: isLowPerformance ? 'Bajo rendimiento' : 'Buen rendimiento'
              };
            })
          )
        );

        return { available: true, data: cumulativeData, periodsIncluded: validPeriods };
      };

      // Calcula tendencia entre periodos
      const calculateTrend = (grades) => {
        if (grades.length < 2) return 'Insuficientes datos';
        
        const first = grades[0];
        const last = grades[grades.length - 1];
        const difference = last - first;
        
        if (Math.abs(difference) < 0.1) return 'Estable';
        return difference > 0 ? 'Mejorando' : 'Declinando';
      };

      // Detecta estudiantes con bajo rendimiento por periodo
      const detectLowPerformanceByPeriod = (dataset, period) => {
        const analysis = analyzeIndividualPeriod(dataset, period);
        if (!analysis.available) return [];
        
        return analysis.data.filter(item => item.isLowPerformance);
      };

      // Funci√≥n principal que construye toda la estructura de an√°lisis por periodos
      const buildPeriodicAnalysis = (dataset) => {
        const periods = ['P1', 'P2', 'P3', 'P4'];
        const availablePeriods = periods.filter(p => isPeriodAvailable(dataset, p));
        
        // An√°lisis individual por cada periodo
        const byPeriod = {};
        periods.forEach(period => {
          byPeriod[period] = analyzeIndividualPeriod(dataset, period);
        });

        // An√°lisis acumulativo
        const cumulative = {};
        
        // Solo generar acumulativos si hay al menos 2 periodos
        if (availablePeriods.length >= 2) {
          // P1+P2
          if (availablePeriods.includes('P1') && availablePeriods.includes('P2')) {
            cumulative.P1_P2 = analyzeCumulativePeriods(dataset, ['P1', 'P2']);
          }
          
          // P1+P2+P3  
          if (availablePeriods.includes('P1') && availablePeriods.includes('P2') && availablePeriods.includes('P3')) {
            cumulative.P1_P2_P3 = analyzeCumulativePeriods(dataset, ['P1', 'P2', 'P3']);
          }
          
          // P1+P2+P3+P4
          if (availablePeriods.length === 4) {
            cumulative.P1_P2_P3_P4 = analyzeCumulativePeriods(dataset, ['P1', 'P2', 'P3', 'P4']);
          }
        }

        // Detecci√≥n de bajo rendimiento por periodo
        const lowPerformanceByPeriod = {};
        availablePeriods.forEach(period => {
          lowPerformanceByPeriod[period] = detectLowPerformanceByPeriod(dataset, period);
        });

        // Resumen de bajo rendimiento general
        const lowPerformanceSummary = availablePeriods.map(period => {
          const lowPerf = lowPerformanceByPeriod[period] || [];
          const totalStudents = new Set(lowPerf.map(item => item.student)).size;
          const totalSubjects = lowPerf.length;
          
          return {
            period: period,
            studentsWithLowPerformance: totalStudents,
            subjectsWithLowPerformance: totalSubjects,
            detailedData: lowPerf
          };
        });

        return {
          availablePeriods: availablePeriods,
          byPeriod: byPeriod,
          cumulative: cumulative,
          lowPerformanceByPeriod: lowPerformanceByPeriod,
          lowPerformanceSummary: lowPerformanceSummary
        };
      };

      // ======================================
      // [FASE 3] Funciones de L√≥gica de C√°lculos para Informes
      // ======================================

      // Genera informe de rendimiento individual por estudiante
      const generateStudentPerformanceReport = (periodicAnalysis, studentId = null) => {
        const { byPeriod, cumulative, availablePeriods } = periodicAnalysis;
        
        // Si se especifica un estudiante, filtrar por ese estudiante
        const filterByStudent = (data) => {
          if (!studentId) return data;
          return data.filter(item => item.studentId === studentId);
        };

        const report = {
          type: 'student_performance',
          generatedAt: new Date().toISOString(),
          studentId: studentId,
          availablePeriods: availablePeriods,
          individualPeriods: {},
          cumulativeAnalysis: {},
          summary: {}
        };

        // An√°lisis por periodo individual
        availablePeriods.forEach(period => {
          if (byPeriod[period]?.available) {
            const periodData = filterByStudent(byPeriod[period].data);
            const lowPerformance = periodData.filter(item => item.isLowPerformance);
            
            report.individualPeriods[period] = {
              totalSubjects: periodData.length,
              approvedSubjects: periodData.filter(item => item.status === 'Aprobado').length,
              failedSubjects: periodData.filter(item => item.status === 'Reprobado').length,
              lowPerformanceSubjects: lowPerformance.length,
              averageGrade: periodData.length > 0 ? 
                periodData.reduce((sum, item) => sum + (item.grade || 0), 0) / periodData.length : 0,
              detailedData: periodData
            };
          }
        });

        // An√°lisis acumulativo
        Object.entries(cumulative).forEach(([key, cumulativeData]) => {
          if (cumulativeData?.available) {
            const filteredData = filterByStudent(cumulativeData.data);
            const improvingTrends = filteredData.filter(item => item.trend === 'Mejorando');
            const decliningTrends = filteredData.filter(item => item.trend === 'Declinando');
            
            report.cumulativeAnalysis[key] = {
              periodsIncluded: cumulativeData.periodsIncluded,
              totalSubjects: filteredData.length,
              averagePerformance: filteredData.length > 0 ?
                filteredData.reduce((sum, item) => sum + (item.average || 0), 0) / filteredData.length : 0,
              improvingSubjects: improvingTrends.length,
              decliningSubjects: decliningTrends.length,
              stableSubjects: filteredData.filter(item => item.trend === 'Estable').length,
              lowPerformanceSubjects: filteredData.filter(item => item.isLowPerformance).length,
              detailedData: filteredData
            };
          }
        });

        return report;
      };

      // Genera informe de bajo rendimiento por curso
      const generateLowPerformanceReport = (periodicAnalysis, courseFilter = null) => {
        const { lowPerformanceSummary, lowPerformanceByPeriod } = periodicAnalysis;
        
        const report = {
          type: 'low_performance',
          generatedAt: new Date().toISOString(),
          courseFilter: courseFilter,
          summary: {},
          detailedAnalysis: {},
          recommendations: []
        };

        // Resumen por periodo
        lowPerformanceSummary.forEach(periodSummary => {
          const period = periodSummary.period;
          let filteredData = periodSummary.detailedData;
          
          if (courseFilter) {
            filteredData = filteredData.filter(item => item.course === courseFilter);
          }

          // Agrupar por estudiante
          const studentGroups = {};
          filteredData.forEach(item => {
            if (!studentGroups[item.student]) {
              studentGroups[item.student] = {
                student: item.student,
                course: item.course,
                subjects: []
              };
            }
            studentGroups[item.student].subjects.push({
              area: item.area,
              subject: item.subject,
              grade: item.grade
            });
          });

          report.summary[period] = {
            totalStudentsAffected: Object.keys(studentGroups).length,
            totalSubjectsAffected: filteredData.length,
            averageGrade: filteredData.length > 0 ?
              filteredData.reduce((sum, item) => sum + item.grade, 0) / filteredData.length : 0,
            studentDetails: Object.values(studentGroups)
          };
        });

        // An√°lisis detallado con identificaci√≥n de patrones
        Object.entries(lowPerformanceByPeriod).forEach(([period, data]) => {
          let filteredData = data;
          if (courseFilter) {
            filteredData = filteredData.filter(item => item.course === courseFilter);
          }

          // Agrupar por √°rea y asignatura para identificar materias problem√°ticas
          const subjectAnalysis = {};
          filteredData.forEach(item => {
            const key = `${item.area} - ${item.subject}`;
            if (!subjectAnalysis[key]) {
              subjectAnalysis[key] = {
                area: item.area,
                subject: item.subject,
                studentsAffected: [],
                averageGrade: 0,
                count: 0
              };
            }
            subjectAnalysis[key].studentsAffected.push(item.student);
            subjectAnalysis[key].averageGrade += item.grade;
            subjectAnalysis[key].count++;
          });

          // Calcular promedios y ordenar por mayor impacto
          Object.values(subjectAnalysis).forEach(analysis => {
            analysis.averageGrade = analysis.averageGrade / analysis.count;
            analysis.studentsAffected = [...new Set(analysis.studentsAffected)];
          });

          const sortedSubjects = Object.values(subjectAnalysis)
            .sort((a, b) => b.studentsAffected.length - a.studentsAffected.length);

          report.detailedAnalysis[period] = {
            mostProblematicSubjects: sortedSubjects.slice(0, 5),
            allSubjectsAnalysis: sortedSubjects
          };
        });

        // Generar recomendaciones autom√°ticas
        report.recommendations = generateLowPerformanceRecommendations(report);

        return report;
      };

      // Genera recomendaciones basadas en el an√°lisis de bajo rendimiento
      const generateLowPerformanceRecommendations = (lowPerformanceReport) => {
        const recommendations = [];
        
        // Analizar patrones across periodos
        const allSubjects = {};
        Object.values(lowPerformanceReport.detailedAnalysis).forEach(periodAnalysis => {
          periodAnalysis.mostProblematicSubjects.forEach(subject => {
            const key = `${subject.area} - ${subject.subject}`;
            if (!allSubjects[key]) {
              allSubjects[key] = { ...subject, appearsInPeriods: 0 };
            }
            allSubjects[key].appearsInPeriods++;
          });
        });

        // Recomendaciones por materias recurrentes
        const recurrentSubjects = Object.values(allSubjects)
          .filter(subject => subject.appearsInPeriods > 1)
          .sort((a, b) => b.appearsInPeriods - a.appearsInPeriods);

        if (recurrentSubjects.length > 0) {
          recommendations.push({
            type: 'recurring_subjects',
            priority: 'high',
            title: 'Materias con Bajo Rendimiento Recurrente',
            description: `Las siguientes materias muestran bajo rendimiento en m√∫ltiples periodos: ${recurrentSubjects.slice(0, 3).map(s => s.subject).join(', ')}`,
            actionItems: [
              'Revisar metodolog√≠a de ense√±anza en estas materias',
              'Implementar programas de refuerzo acad√©mico',
              'Considerar capacitaci√≥n adicional para docentes'
            ]
          });
        }

        // Recomendaciones por cantidad de estudiantes afectados
        const totalStudentsAffected = new Set();
        Object.values(lowPerformanceReport.summary).forEach(periodSummary => {
          periodSummary.studentDetails.forEach(student => {
            totalStudentsAffected.add(student.student);
          });
        });

        if (totalStudentsAffected.size > 0) {
          const affectedPercentage = (totalStudentsAffected.size / 100) * 100; // Asumiendo base de 100 estudiantes
          
          if (affectedPercentage > 20) {
            recommendations.push({
              type: 'high_impact',
              priority: 'urgent',
              title: 'Alto Porcentaje de Estudiantes con Bajo Rendimiento',
              description: `${totalStudentsAffected.size} estudiantes presentan bajo rendimiento (${affectedPercentage.toFixed(1)}% estimado)`,
              actionItems: [
                'Implementar plan de intervenci√≥n institucional',
                'Revisar estrategias pedag√≥gicas generales',
                'Establecer sistema de tutor√≠a personalizada'
              ]
            });
          }
        }

        return recommendations;
      };

      // Genera informe comparativo entre periodos
      const generateComparativeReport = (periodicAnalysis, comparisonType = 'sequential') => {
        const { byPeriod, availablePeriods } = periodicAnalysis;
        
        const report = {
          type: 'comparative',
          generatedAt: new Date().toISOString(),
          comparisonType: comparisonType,
          availablePeriods: availablePeriods,
          comparisons: [],
          overallTrends: {}
        };

        if (comparisonType === 'sequential' && availablePeriods.length >= 2) {
          // Comparaciones secuenciales (P1 vs P2, P2 vs P3, etc.)
          for (let i = 0; i < availablePeriods.length - 1; i++) {
            const currentPeriod = availablePeriods[i];
            const nextPeriod = availablePeriods[i + 1];
            
            if (byPeriod[currentPeriod]?.available && byPeriod[nextPeriod]?.available) {
              const comparison = comparePeriodsPerformance(
                byPeriod[currentPeriod].data,
                byPeriod[nextPeriod].data,
                currentPeriod,
                nextPeriod
              );
              report.comparisons.push(comparison);
            }
          }
        }

        // Calcular tendencias generales
        report.overallTrends = calculateOverallTrends(byPeriod, availablePeriods);

        return report;
      };

      // Compara el rendimiento entre dos periodos espec√≠ficos
      const comparePeriodsPerformance = (period1Data, period2Data, period1Name, period2Name) => {
        // Crear mapas para facilitar la comparaci√≥n
        const period1Map = {};
        const period2Map = {};
        
        period1Data.forEach(item => {
          const key = `${item.studentId}_${item.area}_${item.subject}`;
          period1Map[key] = item;
        });
        
        period2Data.forEach(item => {
          const key = `${item.studentId}_${item.area}_${item.subject}`;
          period2Map[key] = item;
        });

        const comparison = {
          period1: period1Name,
          period2: period2Name,
          improvements: [],
          declines: [],
          stable: [],
          statistics: {
            totalComparisons: 0,
            averageChange: 0,
            improvementCount: 0,
            declineCount: 0,
            stableCount: 0
          }
        };

        // Comparar elementos comunes
        const commonKeys = Object.keys(period1Map).filter(key => period2Map[key]);
        
        commonKeys.forEach(key => {
          const item1 = period1Map[key];
          const item2 = period2Map[key];
          
          if (typeof item1.grade === 'number' && typeof item2.grade === 'number') {
            const change = item2.grade - item1.grade;
            const comparisonItem = {
              student: item1.student,
              course: item1.course,
              area: item1.area,
              subject: item1.subject,
              period1Grade: item1.grade,
              period2Grade: item2.grade,
              change: change,
              changePercentage: item1.grade !== 0 ? (change / item1.grade) * 100 : 0
            };

            if (Math.abs(change) < 0.1) {
              comparison.stable.push(comparisonItem);
              comparison.statistics.stableCount++;
            } else if (change > 0) {
              comparison.improvements.push(comparisonItem);
              comparison.statistics.improvementCount++;
            } else {
              comparison.declines.push(comparisonItem);
              comparison.statistics.declineCount++;
            }

            comparison.statistics.totalComparisons++;
            comparison.statistics.averageChange += change;
          }
        });

        if (comparison.statistics.totalComparisons > 0) {
          comparison.statistics.averageChange /= comparison.statistics.totalComparisons;
        }

        // Ordenar por magnitud del cambio
        comparison.improvements.sort((a, b) => b.change - a.change);
        comparison.declines.sort((a, b) => a.change - b.change);

        return comparison;
      };

      // Calcula tendencias generales across todos los periodos
      const calculateOverallTrends = (byPeriod, availablePeriods) => {
        const trends = {
          overallImprovement: 0,
          subjectTrends: {},
          areaTrends: {},
          courseTrends: {}
        };

        // Analizar tendencias por materia, √°rea y curso
        const subjectData = {};
        const areaData = {};
        const courseData = {};

        availablePeriods.forEach(period => {
          if (byPeriod[period]?.available) {
            byPeriod[period].data.forEach(item => {
              // Agrupar por materia
              const subjectKey = `${item.area} - ${item.subject}`;
              if (!subjectData[subjectKey]) subjectData[subjectKey] = [];
              subjectData[subjectKey].push({ period, grade: item.grade });

              // Agrupar por √°rea
              if (!areaData[item.area]) areaData[item.area] = [];
              areaData[item.area].push({ period, grade: item.grade });

              // Agrupar por curso
              if (!courseData[item.course]) courseData[item.course] = [];
              courseData[item.course].push({ period, grade: item.grade });
            });
          }
        });

        // Calcular tendencias para cada agrupaci√≥n
        trends.subjectTrends = calculateTrendsForGroups(subjectData);
        trends.areaTrends = calculateTrendsForGroups(areaData);
        trends.courseTrends = calculateTrendsForGroups(courseData);

        return trends;
      };

      // Funci√≥n auxiliar para calcular tendencias de grupos
      const calculateTrendsForGroups = (groupData) => {
        const trends = {};
        
        Object.entries(groupData).forEach(([key, data]) => {
          if (data.length >= 2) {
            const grades = data.map(item => item.grade).filter(g => typeof g === 'number');
            if (grades.length >= 2) {
              const firstGrade = grades[0];
              const lastGrade = grades[grades.length - 1];
              const change = lastGrade - firstGrade;
              const trend = Math.abs(change) < 0.1 ? 'Estable' : (change > 0 ? 'Mejorando' : 'Declinando');
              
              trends[key] = {
                trend: trend,
                change: change,
                changePercentage: firstGrade !== 0 ? (change / firstGrade) * 100 : 0,
                averageGrade: grades.reduce((a, b) => a + b, 0) / grades.length
              };
            }
          }
        });

        return trends;
      };

      // Genera estad√≠sticas consolidadas para el panel principal
      const generateConsolidatedStatistics = (periodicAnalysis) => {
        const { availablePeriods, byPeriod, cumulative, lowPerformanceSummary } = periodicAnalysis;
        
        const stats = {
          overview: {
            totalPeriods: availablePeriods.length,
            totalStudents: 0,
            totalSubjects: 0,
            overallAverageGrade: 0,
            overallLowPerformanceRate: 0
          },
          periodComparison: {},
          trends: {
            improving: 0,
            declining: 0,
            stable: 0
          },
          alerts: []
        };

        // Calcular estad√≠sticas generales
        let totalGrades = 0;
        let gradeSum = 0;
        let totalLowPerformance = 0;
        const allStudents = new Set();
        const allSubjects = new Set();

        availablePeriods.forEach(period => {
          if (byPeriod[period]?.available) {
            const periodData = byPeriod[period].data;
            
            periodData.forEach(item => {
              if (typeof item.grade === 'number') {
                allStudents.add(item.student);
                allSubjects.add(`${item.area} - ${item.subject}`);
                gradeSum += item.grade;
                totalGrades++;
                if (item.isLowPerformance) totalLowPerformance++;
              }
            });

            // Estad√≠sticas por periodo
            const periodGrades = periodData.filter(item => typeof item.grade === 'number');
            const periodAverage = periodGrades.length > 0 ? 
              periodGrades.reduce((sum, item) => sum + item.grade, 0) / periodGrades.length : 0;
            
            stats.periodComparison[period] = {
              totalEntries: periodData.length,
              averageGrade: periodAverage,
              lowPerformanceCount: periodData.filter(item => item.isLowPerformance).length,
              approvalRate: periodGrades.length > 0 ? 
                (periodGrades.filter(item => item.grade >= 3.0).length / periodGrades.length) * 100 : 0
            };
          }
        });

        stats.overview.totalStudents = allStudents.size;
        stats.overview.totalSubjects = allSubjects.size;
        stats.overview.overallAverageGrade = totalGrades > 0 ? gradeSum / totalGrades : 0;
        stats.overview.overallLowPerformanceRate = totalGrades > 0 ? (totalLowPerformance / totalGrades) * 100 : 0;

        // Analizar tendencias usando datos acumulativos
        if (cumulative.P1_P2_P3?.available) {
          const trends = cumulative.P1_P2_P3.data.reduce((acc, item) => {
            if (item.trend === 'Mejorando') acc.improving++;
            else if (item.trend === 'Declinando') acc.declining++;
            else acc.stable++;
            return acc;
          }, { improving: 0, declining: 0, stable: 0 });
          
          stats.trends = trends;
        }

        // Generar alertas autom√°ticas
        stats.alerts = generateAutomaticAlerts(stats, lowPerformanceSummary);

        return stats;
      };

      // Genera alertas autom√°ticas basadas en las estad√≠sticas
      const generateAutomaticAlerts = (stats, lowPerformanceSummary) => {
        const alerts = [];

        // Alerta por bajo rendimiento general
        if (stats.overview.overallLowPerformanceRate > 25) {
          alerts.push({
            type: 'critical',
            category: 'low_performance',
            title: 'Alto Porcentaje de Bajo Rendimiento',
            message: `${stats.overview.overallLowPerformanceRate.toFixed(1)}% de las calificaciones est√°n por debajo de 3.0`,
            recommendation: 'Se recomienda implementar plan de intervenci√≥n inmediato',
            priority: 1
          });
        }

        // Alerta por tendencia declinante
        const totalTrends = stats.trends.improving + stats.trends.declining + stats.trends.stable;
        if (totalTrends > 0 && (stats.trends.declining / totalTrends) > 0.3) {
          alerts.push({
            type: 'warning',
            category: 'declining_trend',
            title: 'Tendencia Declinante Detectada',
            message: `${stats.trends.declining} materias muestran tendencia a la baja`,
            recommendation: 'Revisar estrategias pedag√≥gicas en las materias afectadas',
            priority: 2
          });
        }

        // Alerta por periodos con rendimiento muy bajo
        Object.entries(stats.periodComparison).forEach(([period, data]) => {
          if (data.approvalRate < 70) {
            alerts.push({
              type: 'warning',
              category: 'period_performance',
              title: `Bajo Rendimiento en ${period}`,
              message: `Solo ${data.approvalRate.toFixed(1)}% de aprobaci√≥n en ${period}`,
              recommendation: `Analizar factores espec√≠ficos del ${period}`,
              priority: 3
            });
          }
        });

        // Ordenar por prioridad
        return alerts.sort((a, b) => a.priority - b.priority);
      };

      // Funci√≥n principal para generar cualquier tipo de informe
      const generateReport = (derivedData, reportType, options = {}) => {
        const { periodicAnalysis } = derivedData;
        
        if (!periodicAnalysis) {
          return { error: 'No hay datos de an√°lisis por periodos disponibles' };
        }

        switch (reportType) {
          case 'student_performance':
            return generateStudentPerformanceReport(periodicAnalysis, options.studentId);
          
          case 'low_performance':
            return generateLowPerformanceReport(periodicAnalysis, options.courseFilter);
          
          case 'comparative':
            return generateComparativeReport(periodicAnalysis, options.comparisonType);
          
          case 'consolidated_statistics':
            return generateConsolidatedStatistics(periodicAnalysis);
          
          default:
            return { error: `Tipo de informe no reconocido: ${reportType}` };
        }
      };

      // Funci√≥n utilitaria para formatear n√∫meros para reportes
      const formatGradeForReport = (grade) => {
        if (typeof grade !== 'number') return 'N/A';
        return grade.toFixed(2);
      };

      // Funci√≥n utilitaria para formatear porcentajes
      const formatPercentageForReport = (value) => {
        if (typeof value !== 'number') return 'N/A';
        return `${value.toFixed(1)}%`;
      };

      // Funci√≥n utilitaria para obtener el color/estado de una calificaci√≥n
      const getGradeStatus = (grade) => {
        if (typeof grade !== 'number') return { status: 'no_data', color: '#gray' };
        if (grade >= 4.5) return { status: 'excellent', color: '#28a745' };
        if (grade >= 3.5) return { status: 'good', color: '#ffc107' };
        if (grade >= 3.0) return { status: 'acceptable', color: '#fd7e14' };
        return { status: 'low', color: '#dc3545' };
      };

      const buildDerived = (dataset) => {
        if (!Array.isArray(dataset) || dataset.length === 0) {
          return { rowsArea: [], rowsAsignatura: [], studentList: [], areaList: [], asigList: [], courseList: [], promGeneral: 0, estadoCounts: {}, areaRiesgo: [] };
        }

        const rowsArea = dataset.flatMap(st =>
          Object.entries(st.areas).map(([areaName, areaData]) => {
            // [Fix-CURSO] normalizaci√≥n defensiva del curso
            const _curso = st.CURSO ?? st.curso ?? st.Curso ?? st.__course ?? 'SIN_CURSO';
            return {
              id: `${st.id}-${areaName}`,
              CURSO: _curso,
              estudiante: st.name,
              area: areaName,
              defP1: areaData.DEF?.P1,
              defP2: areaData.DEF?.P2,
              defP3: areaData.DEF?.P3,
              promActual: areaData.areaStats?.promedioActual,
              p4Min: areaData.areaStats?.p4Min,
              estado: areaData.areaStats?.estado,
              // [PreNorm] campos normalizados para b√∫squedas/filtrado
              CURSO_NORM: normTxt(_curso),
              AREA_NORM:  normTxt(areaName),
              EST_NORM:   normTxt(st.name),
            };
          })
        );

        const rowsAsignatura = dataset.flatMap(st =>
          Object.entries(st.areas).flatMap(([areaName, areaData]) =>
            Object.entries(areaData.asignaturas).map(([asigName, asigData]) => {
              // [Fix-CURSO] normalizaci√≥n defensiva del curso
              const _curso = st.CURSO ?? st.curso ?? st.Curso ?? st.__course ?? 'SIN_CURSO';
              return {
                id: `${st.id}-${areaName}-${asigName}`,
                CURSO: _curso,
                estudiante: st.name,
                area: areaName,
                asignatura: asigName,
                p1: asigData.P1,
                p2: asigData.P2,
                p3: asigData.P3,
                promActual: asigData.promedioActual,
                p4Min: asigData.p4Min,
                estado: asigData.estado,
                // [PreNorm] campos normalizados para b√∫squedas/filtrado
                CURSO_NORM: normTxt(_curso),
                AREA_NORM:  normTxt(areaName),
                ASIG_NORM:  normTxt(asigName),
                EST_NORM:   normTxt(st.name),
              };
            })
          )
        );

        // 1. √çndices √∫nicos
        const studentList = [...new Set(dataset.map(s => s.name))];
        const areaList = [...new Set(rowsArea.map(r => r.area))];
        const asigList = [...new Set(rowsAsignatura.map(r => r.asignatura))];
        const courseListRaw = [...new Set(dataset.map(s => s.__course).filter(Boolean))];
        const courseList = courseListRaw.length > 0 ? courseListRaw : ['ALL'];

        // 2. KPIs globales
        const proms = rowsArea.map(r => r.promActual).filter(p => typeof p === 'number' && !isNaN(p));
        const promGeneral = proms.length > 0 ? proms.reduce((a, b) => a + b, 0) / proms.length : 0;

        const estadoCounts = { Perdido: 0, 'En riesgo': 0, Recuperable: 0, Ganable: 0, Ganado: 0 };
        const studentStates = new Map();
        rowsArea.forEach(r => {
          if (r.estado && r.estado.text && estadoCounts.hasOwnProperty(r.estado.text)) {
            if (!studentStates.has(r.estudiante)) {
              studentStates.set(r.estudiante, new Set());
            }
            studentStates.get(r.estudiante).add(r.estado.text);
          }
        });
        
        studentStates.forEach(states => {
          states.forEach(state => {
            estadoCounts[state]++;
          });
        });

        const areaRiesgo = areaList.map(area => {
          const enRiesgo = new Set(rowsArea.filter(r => r.area === area && r.estado?.text === 'En riesgo').map(r => r.estudiante)).size;
          const reprobados = new Set(rowsArea.filter(r => r.area === area && r.estado?.text === 'Perdido').map(r => r.estudiante)).size;
          return { area, enRiesgo, reprobados, total: studentList.length };
        });

        // ======================================
        // [FASE 2] An√°lisis por Periodos - Extensi√≥n de buildDerived
        // ======================================
        const periodicAnalysis = buildPeriodicAnalysis(dataset);

        return { 
          rowsArea, 
          rowsAsignatura, 
          studentList, 
          areaList, 
          asigList, 
          courseList, 
          promGeneral, 
          estadoCounts, 
          areaRiesgo,
          // [FASE 2] Nueva estructura para informes por periodos
          periodicAnalysis 
        };
      };

      // ---------- Utilidades de estado/persistencia ----------
      const persistCourses = (arr) => {
        if (Array.isArray(arr) && arr.length > 0) {
          try { localStorage.setItem('coursesSnapshot', JSON.stringify(arr)); } catch {}
        } else {
          try { localStorage.removeItem('coursesSnapshot'); } catch {}
        }
      };

      const persistSelected = (value) => {
        if (value) {
          try { localStorage.setItem('selectedCourse', String(value)); } catch {}
        } else {
          try { localStorage.removeItem('selectedCourse'); } catch {}
        }
      };

      // Elimina un curso por nombre; reacomoda selecci√≥n/datos y persiste
      const removeCourseByName = (name) => {
        setCourses((prev) => {
          const next = prev.filter(c => c.name !== name);
          persistCourses(next);

          // Recalcular selecci√≥n
          setSelectedCourse((selPrev) => {
            let sel = selPrev;
            if (selPrev === name) {
              if (next.length === 0) sel = null;
              else if (next.length === 1) sel = next[0].name;
              else sel = 'ALL';
            }
            persistSelected(sel);
            // Recalcular analysisData seg√∫n selecci√≥n final
            if (sel === null) {
              setAnalysisData(null);
              setProcessed(null);
              setView('upload');
            } else if (sel === 'ALL') {
              setAnalysisData(next.flatMap(c => c.data));
            } else {
              const found = next.find(c => c.name === sel);
              setAnalysisData(found ? found.data : (next[0]?.data ?? null));
            }
            return sel;
          });

          // Si ya no quedan cursos, limpiar otros estados auxiliares
          if (next.length === 0) {
            setAcceptChecks({ defPropagation:false, singleArea:false, renderOK:false });
            setQualityLog([]);
          }
          return next;
        });
      };

      // Limpia absolutamente todo lo persistido y vuelve a la vista de carga
      const clearAllData = () => {
        if (!confirm('¬øVaciar toda la memoria (cursos/notas)? Esta acci√≥n no se puede deshacer.')) return;
        try { localStorage.removeItem('coursesSnapshot'); } catch {}
        try { localStorage.removeItem('selectedCourse'); } catch {}
        setCourses([]);
        setSelectedCourse(null);
        setAnalysisData(null);
        setProcessed(null);
        setAcceptChecks({ defPropagation:false, singleArea:false, renderOK:false });
        setQualityLog([]);
        setView('upload');
      };

      // (Opcional) Deduplicador por nombre exacto; conserva el √∫ltimo
      const dedupeCourses = (arr) => {
        const map = new Map();
        arr.forEach(c => map.set(c.name, c));
        return Array.from(map.values());
      };

      // Persistir selecci√≥n de curso en localStorage
      useEffect(() => {
        if (selectedCourse != null) {
          try { localStorage.setItem('selectedCourse', String(selectedCourse)); } catch {}
        }
      }, [selectedCourse]);

      // Restaurar selecci√≥n de curso cuando haya cursos disponibles
      useEffect(() => {
        try {
          const saved = localStorage.getItem('selectedCourse');
          if (!saved) return;
          if (saved === 'ALL') {
            setSelectedCourse('ALL');
          } else if (Array.isArray(courses) && courses.some(c => c.name === saved)) {
            setSelectedCourse(saved);
          }
        } catch {}
        // Solo interesa reaccionar a cambios en la cantidad de cursos
      }, [courses.length]);

      // Persistir lista de cursos en localStorage
      useEffect(() => {
        try {
          if (Array.isArray(courses) && courses.length > 0) {
            localStorage.setItem('coursesSnapshot', JSON.stringify(courses));
          } else {
            localStorage.removeItem('coursesSnapshot');
          }
        } catch (e) {
          console.error('Persist courses error:', e);
        }
      }, [courses]);

      // Restaurar cursos/selecci√≥n y abrir dashboard si hay snapshot
      useEffect(() => {
        try {
          const raw = localStorage.getItem('coursesSnapshot');
          if (!raw) return;
          const savedCourses = JSON.parse(raw);
          if (!Array.isArray(savedCourses) || savedCourses.length === 0) return;

          setCourses(savedCourses);

          const savedSelected = localStorage.getItem('selectedCourse') || 'ALL';
          setSelectedCourse(savedSelected);

          // Determinar el dataset por defecto para analysisData
          const defaultData =
            (savedSelected && savedSelected !== 'ALL')
              ? (savedCourses.find(c => c.name === savedSelected)?.data || savedCourses[0].data)
              : savedCourses.flatMap(c => c.data);

          setAnalysisData(defaultData);

          // Asegurar un fileName visible en el dashboard
          setProcessed(prev => prev ?? { fileName: (savedSelected === 'ALL' ? 'Todos (recuperado)' : `${savedSelected} (recuperado)`) });

          // Ir directo al dashboard
          setView('dashboard');
        } catch (e) {
          console.error('Restore courses error:', e);
        } finally {
          const overlay = document.getElementById('loading-overlay');
          if (overlay) {
            overlay.style.display = 'none';
          }
        }
      }, []);

      useEffect(() => {
        // Si no hay cursos cargados, asegura vista de Upload
        if (!courses || courses.length === 0) {
          if (view !== 'upload') setView('upload');
          // estados derivados seguros
          if (selectedCourse !== null) setSelectedCourse(null);
          if (analysisData !== null) setAnalysisData(null);
        }
      }, [courses, view]); 

      const handleWorkbookProcessed = async (profiles) => {
        if (!Array.isArray(profiles) || profiles.length === 0) return;

        showLoading(`Analizando ${profiles.length} hoja${profiles.length>1?'s':''}‚Ä¶`);
        await uiTick();

        const processingLog = [];
        const newCourses = [];

        for (let idx=0; idx<profiles.length; idx++) {
          const profile = profiles[idx];
          updateLoading(`(${idx+1}/${profiles.length}) Perfilando encabezados de "${profile.sheetName}"‚Ä¶`);
          await uiTick();

          const parsedHeaders = profilingLogic.parseHeaders(profile.headerRows, processingLog);

          updateLoading(`(${idx+1}/${profiles.length}) Estructurando datos‚Ä¶`);
          await uiTick();
          const structuredData = cleaningLogic.structureData({ ...profile, tableHeaders: parsedHeaders }, processingLog);

          updateLoading(`(${idx+1}/${profiles.length}) Calculando m√©tricas‚Ä¶`);
          await uiTick();
          const withCalcs = calculationLogic.performAllCalculations(structuredData.structuredData);

          const desired = makeCourseName(profile.courseBase, profile.sheetName);
          const finalName = ensureUniqueName([...courses, ...newCourses], desired);
          newCourses.push({ name: finalName, data: withCalcs });
        }

        updateLoading('Combinando cursos y preparando el panel‚Ä¶');
        await uiTick();

        // Fusionar con cursos existentes
        const mergedCourses = (() => {
          const map = new Map(courses.map(c => [c.name, c]));
          newCourses.forEach(nc => map.set(nc.name, nc));
          return Array.from(map.values());
        })();

        setCourses(mergedCourses);

        const nextSelected = mergedCourses.length > 1 ? 'ALL' : mergedCourses[0].name;
        setSelectedCourse(nextSelected);

        const nextData = mergedCourses.flatMap(c => c.data.map(s => ({ ...s, CURSO: c.name })));

        setAnalysisData(nextData);

        const d = buildDerived(nextData);
        
        const rowsAreaNorm = withCurso(d.rowsArea);
        const rowsAsignNorm = withCurso(d.rowsAsignatura);

        const derivedNorm = {
          ...d,
          rowsArea: rowsAreaNorm,
          rowsAsignatura: rowsAsignNorm,
        };
        setDerived(derivedNorm);
        console.debug('[App] derived built (areas)', { rowsArea: derivedNorm?.rowsArea?.length });
        console.debug('[App] derived built (asignaturas)', { rowsAsignatura: derivedNorm?.rowsAsignatura?.length });
        console.debug('[App] derived built (indices)', { students: d.studentList.length, areas: d.areaList.length, asigs: d.asigList.length, courses: d.courseList.length });
        console.debug('[App] derived built (kpis)', { promGeneral: d.promGeneral, estadoCounts: d.estadoCounts, areaRiesgo: d.areaRiesgo.length });

        setAcceptChecks(selfChecks(mergedCourses[0].data));
        setProcessed({
          fileName: `${profiles[0].fileName} (${profiles.length} hoja${profiles.length>1?'s':''})`,
          log: processingLog,
          structuredData: null,
          sourceCounts: { areaCount: 0, asignaturaCount: 0 },
          processedCounts: { areaCount: 0, asignaturaCount: 0, studentCount: 0 }
        });

        setView('dashboard');

        updateLoading('Renderizando panel‚Ä¶');
        await uiTick();
        hideLoading();
      };

      const handleReset = () => { setProcessed(null); setAnalysisData(null); setView('upload'); setQualityLog([]); };

      const handleRestore = (data) => {
        if (data.dashboardData) {
            setAnalysisData(data.dashboardData);

            const coursesMap = new Map();
            data.dashboardData.forEach(student => {
                const courseName = student.CURSO || 'Restaurado';
                if (!coursesMap.has(courseName)) {
                    coursesMap.set(courseName, []);
                }
                coursesMap.get(courseName).push(student);
            });

            const restoredCourses = Array.from(coursesMap.entries()).map(([name, courseData]) => ({
                name: name,
                data: courseData
            }));

            setCourses(restoredCourses);
            if (restoredCourses.length > 1) {
                setSelectedCourse('ALL');
            } else if (restoredCourses.length === 1) {
                setSelectedCourse(restoredCourses[0].name);
            }
        }

        const newDerived = {
            ...buildDerived(data.dashboardData || []),
            rowsArea: data.rowsArea,
            rowsAsignatura: data.rowsAsignatura,
        };
        setDerived(newDerived);

        if ('syncChartsWithFilters' in data) {
            setSyncChartsWithFilters(!!data.syncChartsWithFilters);
        }

        setView('dashboard');
        setProcessed({ fileName: 'Restaurado desde backup.json' });
      };

      // Eliminar el curso actualmente seleccionado (si no es ALL)
      const handleDeleteCurrentCourse = () => {
        if (!selectedCourse || selectedCourse === 'ALL') {
          alert('Selecciona un curso espec√≠fico para eliminar.');
          return;
        }
        if (confirm(`¬øEliminar el curso "${selectedCourse}"?`)) {
          removeCourseByName(selectedCourse);
        }
      };

      // Vaciar memoria sin tocar archivos locales
      const handleClearMemory = () => {
        clearAllData();
      };

      // Bot√≥n para descargar el log de calidad
      const downloadQualityLog = () => {
        const blob = new Blob([JSON.stringify(qualityLog, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `log-calidad-${new Date().toISOString()}.json`;
        a.click();
        URL.revokeObjectURL(url);
      };

      const LoadingOverlay = ({ show, message }) => {
        // [CRON√ìMETRO] Simple timer sin complejidad
        const [seconds, setSeconds] = useState(0);
        
        useEffect(() => {
          if (!show) {
            setSeconds(0);
            return;
          }
          
          const timer = setInterval(() => {
            setSeconds(prev => prev + 1);
          }, 1000);
          
          return () => clearInterval(timer);
        }, [show]);
        
        if (!show) return null;
        return (
          <div
            role="status"
            aria-live="assertive"
            className="fixed inset-0 z-[9999] bg-black/40 flex items-center justify-center p-4 sm:p-6"
          >
            <div className="w-full max-w-sm sm:max-w-md bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4 sm:p-6 transition-colors">
              <div className="flex items-center gap-3 sm:gap-4">
                {/* Spinner simple accesible */}
                <svg className="animate-spin h-6 w-6 sm:h-8 sm:w-8 text-blue-600 dark:text-blue-400" viewBox="0 0 24 24" aria-hidden="true">
                  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                  <path className="opacity-75" d="M4 12a8 8 0 018-8" fill="currentColor"></path>
                </svg>
                <div>
                  <p className="font-semibold text-sm sm:text-base text-gray-900 dark:text-white">Trabajando‚Ä¶</p>
                  <p className="text-xs sm:text-sm text-gray-600 dark:text-gray-300">{message || 'Procesando datos, por favor espera.'}</p>
                </div>
              </div>
              {/* Barra indeterminada */}
              <div className="mt-3 sm:mt-4 h-2 w-full bg-gray-200 dark:bg-gray-700 rounded overflow-hidden" aria-hidden="true">
                <div className="h-full w-1/3 bg-blue-600 dark:bg-blue-400 animate-[loader_1.2s_infinite]"></div>
              </div>
              {/* [CRON√ìMETRO] Tiempo transcurrido */}
              <div className="mt-2 sm:mt-3 text-center">
                <span className="text-xs text-gray-500 dark:text-gray-400">‚è±Ô∏è {seconds}s</span>
              </div>
              <style>{`@keyframes loader{0%{transform:translateX(-100%)}50%{transform:translateX(100%)}100%{transform:translateX(200%)}}`}</style>
            </div>
          </div>
        );
      };

      const dashboardData = useMemo(() => {
        if (selectedCourse && selectedCourse !== 'ALL') {
          return courses.find(c => c.name === selectedCourse)?.data ?? analysisData;
        }
        if (courses.length > 0) {
          return courses.flatMap(c => c.data.map(s => ({ ...s, CURSO: c.name })));
        }
        return analysisData;
      }, [courses, selectedCourse, analysisData]);

      

      return (
        <div>
          {view==='upload' && (
            <UploadView
              onWorkbookProcessed={handleWorkbookProcessed}
              onRestore={handleRestore}
              onLoading={{ start: showLoading, update: updateLoading, stop: hideLoading }}
            />
          )}
          {view==='dashboard' && <>
            {/* Selector de curso y bot√≥n Agregar */}
            <div className="max-w-7xl mx-auto px-6 mt-6 mb-2 flex flex-wrap items-center gap-3">
              <label className="text-sm font-medium">Curso:</label>
              <select
                className="border rounded px-2 py-1 text-sm"
                value={selectedCourse || 'ALL'}
                onChange={(e) => setSelectedCourse(e.target.value)}
              >
                <option value="ALL">Todos</option>
                {courses.map((c) => (
                  <option key={c.name} value={c.name}>{c.name}</option>
                ))}
              </select>

              <button
                type="button"
                className="inline-flex items-center px-3 py-1.5 rounded-md text-white bg-blue-600 hover:bg-blue-700 text-sm"
                onClick={() => addInputRef.current?.click()}
              >
                Agregar curso
              </button>

              {/* Acciones de mantenimiento */}
              <div className="flex items-center gap-2">
                <button
                  type="button"
                  className="inline-flex items-center px-3 py-1.5 rounded-md text-white bg-red-600 hover:bg-red-700 text-sm disabled:opacity-50"
                  onClick={handleDeleteCurrentCourse}
                  disabled={!selectedCourse || selectedCourse === 'ALL'}
                  title="Eliminar solo el curso seleccionado"
                >
                  Eliminar curso
                </button>

                <button
                  type="button"
                  className="inline-flex items-center px-3 py-1.5 rounded-md text-white bg-zinc-800 hover:bg-black text-sm"
                  onClick={handleClearMemory}
                  title="Vaciar toda la memoria (cursos y selecci√≥n)"
                >
                  Vaciar memoria
                </button>

                {/* Toggle: Silenciar errores externos */}
                <label className="inline-flex items-center gap-2 text-sm ml-2" title="Silenciar errores externos del navegador (extensiones)">
                  <input
                    type="checkbox"
                    className="rounded border-gray-300"
                    defaultChecked={window.__SUPPRESS_EXTERNAL_CONSOLE_NOISE__}
                    onChange={(e) => {
                      window.__setSuppressExternalErrors(e.target.checked);
                      // Feedback visual m√≠nimo
                      alert(e.target.checked ? 'Silencio de errores externos: ACTIVADO' : 'Silencio de errores externos: DESACTIVADO');
                    }}
                  />
                  Silenciar errores externos
                </label>
              </div>

              <input
                ref={addInputRef}
                type="file"
                className="hidden"
                accept=".xlsx,.xls,.csv"
                onChange={async (e) => {
                  const f = e.target.files?.[0];
                  if (!f) return;
                  try {
                    const reader = new FileReader();
                    reader.onload = () => {
                      try {
                        showLoading('Leyendo archivo‚Ä¶');
                        const wb = XLSX.read(new Uint8Array(reader.result), { type: 'array' });
                        updateLoading('Perfilando hojas‚Ä¶');
                        const profiles = importWorkbookToProfiles(wb, f.name);
                        if (profiles.length > 0) {
                          // El resto del progreso lo maneja handleWorkbookProcessed (as√≠ncrono)
                          handleWorkbookProcessed(profiles);
                        } else {
                          hideLoading();
                        }
                      } catch (err) {
                        console.error(err);
                        hideLoading();
                      } finally {
                        e.target.value = '';
                      }
                    };
                    reader.readAsArrayBuffer(f);
                  } catch (err) {
                    console.error(err);
                    e.target.value = '';
                  }
                }}
              />
            </div>
            <DashboardTabs dashboardData={dashboardData} onReset={handleReset} fileName={processed.fileName} derived={derived} setDerived={setDerived} syncChartsWithFilters={syncChartsWithFilters} setSyncChartsWithFilters={setSyncChartsWithFilters} />
            <div className="max-w-7xl mx-auto px-6 pb-10 text-xs text-gray-500">
              <button onClick={downloadQualityLog} className="mb-2 bg-gray-700 text-white px-3 py-1 rounded-md text-sm hover:bg-black">Descargar Log de Calidad (JSON)</button>              <hr className="my-6"/>
              <p><strong>Nota:</strong> El an√°lisis de calidad de datos se realiza internamente y est√° disponible para consulta administrativa.</p>
            </div>
            <LoadingOverlay show={loading} message={loadingMsg} />
          </>}
        </div>
      );
    }

  const root = ReactDOM.createRoot(document.getElementById('root'));
  root.render(
    <AppErrorBoundary>
      <App />
    </AppErrorBoundary>
  );
  </script>
</body>
</html>